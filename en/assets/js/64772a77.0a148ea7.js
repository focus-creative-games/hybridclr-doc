"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[9388],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>y});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),d=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=d(e.components);return a.createElement(s.Provider,{value:t},e.children)},c="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),c=d(n),m=r,y=c["".concat(s,".").concat(m)]||c[m]||u[m]||i;return n?a.createElement(y,o(o({ref:t},p),{},{components:n})):a.createElement(y,o({ref:t},p))}));function y(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[c]="string"==typeof e?e:r,o[1]=l;for(var d=2;d<i;d++)o[d]=n[d];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},550:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>l,toc:()=>d});var a=n(7462),r=(n(7294),n(3905));const i={},o="Use Generics",l={unversionedId:"beginner/generic",id:"beginner/generic",title:"Use Generics",description:"HybridCLR fully supports generic features without any restrictions.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/beginner/generic.md",sourceDirName:"beginner",slug:"/beginner/generic",permalink:"/en/docs/beginner/generic",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Use MonoBehaviour",permalink:"/en/docs/beginner/monobehaviour"},next:{title:"Other Information",permalink:"/en/docs/beginner/otherhelp"}},s={},d=[{value:"Use generic classes or functions defined in hot update",id:"use-generic-classes-or-functions-defined-in-hot-update",level:2},{value:"Use generic classes or functions defined in AOT",id:"use-generic-classes-or-functions-defined-in-aot",level:2},{value:"get supplementary metadata dll",id:"get-supplementary-metadata-dll",level:2},{value:"Execute Supplementary Metadata",id:"execute-supplementary-metadata",level:2}],p={toc:d},c="wrapper";function u(e){let{components:t,...n}=e;return(0,r.kt)(c,(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"use-generics"},"Use Generics"),(0,r.kt)("p",null,"HybridCLR fully supports generic features without any restrictions."),(0,r.kt)("h2",{id:"use-generic-classes-or-functions-defined-in-hot-update"},"Use generic classes or functions defined in hot update"),(0,r.kt)("p",null,"Just use it directly."),(0,r.kt)("h2",{id:"use-generic-classes-or-functions-defined-in-aot"},"Use generic classes or functions defined in AOT"),(0,r.kt)("p",null,"If some generic class or function has been instantiated in AOT code, it can be used directly in hot update, for example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"\n// List<float> generic type has been used in AOT\nclass Foo\n{\n     public void Run()\n     {\n         var arr = new List<float>();\n     }\n}\n\n// List<float> can be used in hot update\nclass HotUpdateGenericDemos\n{\n     public void Run()\n     {\n         var arr = new List<float>();\n     }\n}\n\n")),(0,r.kt)("p",null,"However, if an AOT generic class or function has not been instantiated in the AOT, certain processing is required. There are two solutions:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Add the corresponding instantiation code in the AOT code."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"Supplementary Metadata Technology"),". This is HybridCLR's patented technology.")),(0,r.kt)("p",null,"Please read ",(0,r.kt)("a",{parentName:"p",href:"/en/docs/basic/aotgeneric"},"AOT Generics")," for detailed principles of AOT generics."),(0,r.kt)("p",null,"For method 1, there are several fatal flaws:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The instantiation code added to the AOT code needs to be repackaged. Not only is the development period very troublesome, but it is unrealistic to redistribute the main package in a short period of time after it goes online."),(0,r.kt)("li",{parentName:"ul"},"Generic parameters may be hot update types, which cannot be instantiated in advance in AOT. For example, if you define ",(0,r.kt)("inlineCode",{parentName:"li"},"struct MyVector3 {int x, y, z;}")," in the hot update code, you cannot instantiate ",(0,r.kt)("inlineCode",{parentName:"li"},"List<MyVector3>")," in advance in AOT.")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"Supplementary Metadata Technology")," completely solves this problem. Roughly speaking, after you supplement the original metadata of the AOT generic class (or generic function), you can instantiate the generic class arbitrarily. Take the above ",(0,r.kt)("inlineCode",{parentName:"p"},"List<MyVector3>")," as an example, after you add the ",(0,r.kt)("inlineCode",{parentName:"p"},"mscorlib.dll")," metadata where the List class (not MyVector3) is located, you can use any ",(0,r.kt)("inlineCode",{parentName:"p"},"List<T>")," generic class in the hot update code up."),(0,r.kt)("h2",{id:"get-supplementary-metadata-dll"},"get supplementary metadata dll"),(0,r.kt)("p",null,"The stripped AOT dll generated by ",(0,r.kt)("strong",{parentName:"p"},"build process")," can be used to supplement metadata. The com.code-philosophy.hybridclr plugin will automatically copy them to ",(0,r.kt)("inlineCode",{parentName:"p"},"{project}/HybridCLRData/AssembliesPostIl2CppStrip/{target}"),"."),(0,r.kt)("admonition",{type:"danger"},(0,r.kt)("p",{parentName:"admonition"},"Stripped AOT dlls of different BuildTargets cannot be reused.")),(0,r.kt)("p",null,"Using the ",(0,r.kt)("inlineCode",{parentName:"p"},"HybridCLR/Generate/AotDlls")," command can also generate the trimmed AOT dll immediately, it works by exporting a Temp project to get the trimmed AOT dll."),(0,r.kt)("p",null,"Obtain the supplementary metadata dll you need from the ",(0,r.kt)("inlineCode",{parentName:"p"},"{project}/HybridCLRData/AssembliesPostIl2CppStrip/{target}")," directory, and add it to the hot update resource management system of the project. The example projects are placed in the StreamingAssets directory for demonstration purposes.\nTake the ",(0,r.kt)("inlineCode",{parentName:"p"},"List<T>")," type as an example, it needs to complement ",(0,r.kt)("inlineCode",{parentName:"p"},"mscorlib.dll"),". Copy ",(0,r.kt)("inlineCode",{parentName:"p"},"{project}/HybridCLRData/AssembliesPostIl2CppStrip/{target}/mscorlib.dll")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"Assets/StreamingAssets/mscorlib.dll.bytes"),"."),(0,r.kt)("h2",{id:"execute-supplementary-metadata"},"Execute Supplementary Metadata"),(0,r.kt)("p",null,"Use the ",(0,r.kt)("inlineCode",{parentName:"p"},"HybridCLR.RuntimeApi.LoadMetadataForAOTAssembly")," function in the ",(0,r.kt)("inlineCode",{parentName:"p"},"com.code-philosophy.hybridclr")," package to supplement metadata for AOT generics.\nMetadata only needs to be supplemented once, it is recommended before executing any hot update code. ",(0,r.kt)("inlineCode",{parentName:"p"},"LoadDll.cs")," ends up looking like this."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},'\npublic class LoadDll : MonoBehaviour\n{\n\n     void Start()\n     {\n         // Add metadata first\n         LoadMetadataForAOTAAssemblies();\n       // In the Editor environment, HotUpdate.dll.bytes has been automatically loaded and does not need to be loaded. Repeated loading will cause problems.\n#if !UNITY_EDITOR\n         Assembly hotUpdateAss = Assembly.Load(File.ReadAllBytes($"{Application.streamingAssetsPath}/HotUpdate.dll.bytes"));\n#else\n       // No need to load under Editor, directly find the HotUpdate assembly\n         Assembly hotUpdateAss = System.AppDomain.CurrentDomain.GetAssemblies().First(a => a.GetName().Name == "HotUpdate");\n#endif\n    \n         Type type = hotUpdateAss. GetType("Hello");\n         type. GetMethod("Run"). Invoke(null, null);\n     }\n\n     private static void LoadMetadataForAOTAAssemblies()\n     {\n         List<string> aotDllList = new List<string>\n         {\n             "mscorlib.dll",\n             "System.dll",\n             "System.Core.dll", // required if using Linq\n             // "Newtonsoft.Json.dll",\n             // "protobuf-net.dll",\n         };\n\n         foreach (var aotDllName in aotDllList)\n         {\n             byte[] dllBytes = File.ReadAllBytes($"{Application.streamingAssetsPath}/{aotDllName}.bytes");\n             int err = HybridCLR.RuntimeApi.LoadMetadataForAOTAssembly(dllBytes, HomologousImageMode.SuperSet);\n             Debug.Log($"LoadMetadataForAOTAssembly:{aotDllName}.ret:{err}");\n         }\n     }\n}\n')),(0,r.kt)("p",null,"Now you can freely use AOT generics in hot update code."))}u.isMDXComponent=!0}}]);