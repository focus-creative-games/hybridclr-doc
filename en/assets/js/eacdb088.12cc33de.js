"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[5672],{3905:(t,e,n)=>{n.d(e,{Zo:()=>d,kt:()=>g});var a=n(67294);function r(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function i(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,a)}return n}function l(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?i(Object(n),!0).forEach((function(e){r(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function o(t,e){if(null==t)return{};var n,a,r=function(t,e){if(null==t)return{};var n,a,r={},i=Object.keys(t);for(a=0;a<i.length;a++)n=i[a],e.indexOf(n)>=0||(r[n]=t[n]);return r}(t,e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);for(a=0;a<i.length;a++)n=i[a],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(r[n]=t[n])}return r}var s=a.createContext({}),p=function(t){var e=a.useContext(s),n=e;return t&&(n="function"==typeof t?t(e):l(l({},e),t)),n},d=function(t){var e=p(t.components);return a.createElement(s.Provider,{value:e},t.children)},u="mdxType",m={inlineCode:"code",wrapper:function(t){var e=t.children;return a.createElement(a.Fragment,{},e)}},c=a.forwardRef((function(t,e){var n=t.components,r=t.mdxType,i=t.originalType,s=t.parentName,d=o(t,["components","mdxType","originalType","parentName"]),u=p(n),c=r,g=u["".concat(s,".").concat(c)]||u[c]||m[c]||i;return n?a.createElement(g,l(l({ref:e},d),{},{components:n})):a.createElement(g,l({ref:e},d))}));function g(t,e){var n=arguments,r=e&&e.mdxType;if("string"==typeof t||r){var i=n.length,l=new Array(i);l[0]=c;var o={};for(var s in e)hasOwnProperty.call(e,s)&&(o[s]=e[s]);o.originalType=t,o[u]="string"==typeof t?t:r,l[1]=o;for(var p=2;p<i;p++)l[p]=n[p];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},36418:(t,e,n)=>{n.r(e),n.d(e,{assets:()=>s,contentTitle:()=>l,default:()=>m,frontMatter:()=>i,metadata:()=>o,toc:()=>p});var a=n(87462),r=(n(67294),n(3905));const i={},l="DOTS Support",o={unversionedId:"basic/dots",id:"basic/dots",title:"DOTS Support",description:"DOTS's TypeManager initializes too early and doesn't support dynamic registration of Components and Systems. To make hot update modules run properly in DOTS systems, DOTS source code needs to be modified to adjust the initialization timing of World.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/basic/dots.md",sourceDirName:"basic",slug:"/basic/dots",permalink:"/en/docs/basic/dots",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Bridge Functions",permalink:"/en/docs/basic/methodbridge"},next:{title:"Code Obfuscation",permalink:"/en/docs/basic/codeobfuscation"}},s={},p=[{value:"Supported Versions",id:"supported-versions",level:2},{value:"Supported Features",id:"supported-features",level:2},{value:"Version 1.0.16",id:"version-1016",level:3},{value:"Version 0.51.1-preview.21",id:"version-0511-preview21",level:3},{value:"Installation",id:"installation",level:2},{value:"Installing com.unity.entities",id:"installing-comunityentities",level:3},{value:"Modifying Project Settings",id:"modifying-project-settings",level:3},{value:"Initialization",id:"initialization",level:3},{value:"Solving ReversePInvokeCallback Issues",id:"solving-reversepinvokecallback-issues",level:3},{value:"Burst Related",id:"burst-related",level:3}],d={toc:p},u="wrapper";function m(t){let{components:e,...n}=t;return(0,r.kt)(u,(0,a.Z)({},d,n,{components:e,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"dots-support"},"DOTS Support"),(0,r.kt)("p",null,"DOTS's TypeManager initializes too early and doesn't support dynamic registration of Components and Systems. To make hot update modules run properly in DOTS systems, DOTS source code needs to be modified to adjust the initialization timing of World."),(0,r.kt)("h2",{id:"supported-versions"},"Supported Versions"),(0,r.kt)("p",null,"Since DOTS is still rapidly iterating and changing, to reduce maintenance costs, only the following versions of com.unity.entities are maintained:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"0.51.1-preview.21"),(0,r.kt)("li",{parentName:"ul"},"1.0.16")),(0,r.kt)("p",null,"Currently only tested on Unity 2021+ versions, Unity 2020 and lower versions haven't been tested for compatibility. Generally speaking, as long as the corresponding version of com.unity.entities can run normally on that Unity version, it can also support HybridCLR."),(0,r.kt)("p",null,"Developers with special DOTS version requirements need to contact us for separate paid customization due to the high cost of maintaining individual DOTS versions."),(0,r.kt)("h2",{id:"supported-features"},"Supported Features"),(0,r.kt)("p",null,"Currently most DOTS features can run normally under HybridCLR, with only features related to BurstCompile and resource serialization having poor support."),(0,r.kt)("h3",{id:"version-1016"},"Version 1.0.16"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Feature"),(0,r.kt)("th",{parentName:"tr",align:null},"Community Edition"),(0,r.kt)("th",{parentName:"tr",align:null},"Professional Edition"),(0,r.kt)("th",{parentName:"tr",align:null},"Ultimate Edition"),(0,r.kt)("th",{parentName:"tr",align:null},"Hot Reload Edition"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Jobs"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Managed Component"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Unmanaged Component"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Managed System"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Unmanaged System"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Aspect"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"IJobEntity"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"BurstCompile"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"SubScene"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})))),(0,r.kt)("h3",{id:"version-0511-preview21"},"Version 0.51.1-preview.21"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Feature"),(0,r.kt)("th",{parentName:"tr",align:null},"Community Edition"),(0,r.kt)("th",{parentName:"tr",align:null},"Professional Edition"),(0,r.kt)("th",{parentName:"tr",align:null},"Ultimate Edition"),(0,r.kt)("th",{parentName:"tr",align:null},"Hot Reload Edition"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Jobs"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Managed Component"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Unmanaged Component"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Managed System"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Unmanaged System"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"IJobEntity"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"BurstCompile"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"SubScene"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})))),(0,r.kt)("h2",{id:"installation"},"Installation"),(0,r.kt)("h3",{id:"installing-comunityentities"},"Installing com.unity.entities"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Remove the com.unity.entities package from the project, exit Unity Editor, and clear the corresponding directory in the ",(0,r.kt)("inlineCode",{parentName:"li"},"Library\\PackageCache")," directory"),(0,r.kt)("li",{parentName:"ul"},"Based on the version used by your project, download the ",(0,r.kt)("a",{parentName:"li",href:"https://code-philosophy.feishu.cn/file/NH0cbaeneozfd8xdbvmcLNvfn2d"},"modified com.unity.entities"),", extract the ",(0,r.kt)("inlineCode",{parentName:"li"},"com.unity.entities.7z")," from the corresponding directory to the Packages directory. Make sure the extracted directory name is com.unity.entities.")),(0,r.kt)("p",null,"When reopening Unity Editor, you may be prompted whether to perform API upgrade. Decide whether to upgrade based on your project situation."),(0,r.kt)("h3",{id:"modifying-project-settings"},"Modifying Project Settings"),(0,r.kt)("p",null,"To avoid potential issues with dynamic registration of Components or Systems during DOTS runtime, you need to adjust World initialization timing to ensure all hot update types are registered before running all Worlds."),(0,r.kt)("p",null,"In ",(0,r.kt)("inlineCode",{parentName:"p"},"Player Settings"),"'s ",(0,r.kt)("inlineCode",{parentName:"p"},"Scripting Define Symbols"),", add the compilation macro ",(0,r.kt)("inlineCode",{parentName:"p"},"UNITY_DISABLE_AUTOMATIC_SYSTEM_BOOTSTRAP_RUNTIME_WORLD"),". For detailed introduction, see World's\n",(0,r.kt)("a",{parentName:"p",href:"https://docs.unity3d.com/Packages/com.unity.entities@0.51/manual/world.html"},"custom initialization documentation"),"."),(0,r.kt)("h3",{id:"initialization"},"Initialization"),(0,r.kt)("p",null,"To avoid encountering problems, please initialize ",(0,r.kt)("strong",{parentName:"p"},"after loading hot update code and before running any DOTS code"),"."),(0,r.kt)("p",null,"Initialization mainly includes two parts:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Register hot update DOTS types"),(0,r.kt)("li",{parentName:"ul"},"Initialize World")),(0,r.kt)("p",null,"Different com.unity.entities versions have slightly different initialization implementations."),(0,r.kt)("p",null,"0.51.1 version initialization code:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},'    private static void InitializeWorld()\n    {\n#if !UNITY_EDITOR\n        // dotsAsseemblies are all AOT and hot update assemblies containing custom Component, System and other DOTS types\n        var dotsAssemblies = new Assembly[] { ... };\n        var componentTypes = new HashSet<System.Type>();\n        TypeManager.CollectComponentTypes(dotsAssemblies, componentTypes);\n        TypeManager.AddNewComponentTypes(componentTypes.ToArray());\n        TypeManager.EarlyInitAssemblies(dotsAssemblies);\n#endif\n\n\n        DefaultWorldInitialization.Initialize("Default World", false);\n\n    }\n')),(0,r.kt)("p",null,"1.0.16 version initialization code:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},'    private static void InitializeWorld()\n    {\n#if !UNITY_EDITOR\n        // dotsAsseemblies are all AOT and hot update assemblies containing custom Component, System and other DOTS types\n        var dotsAssemblies = new Assembly[] { ... };\n        var componentTypes = new HashSet<Type>();\n        TypeManager.CollectComponentTypes(dotsAssemblies, componentTypes);\n        TypeManager.AddComponentTypes(dotsAssemblies, componentTypes);\n        TypeManager.RegisterSystemTypes(dotsAssemblies);\n        TypeManager.InitializeSharedStatics();\n        TypeManager.EarlyInitAssemblies(dotsAssemblies);\n#endif\n\n\n        DefaultWorldInitialization.Initialize("Default World", false);\n    }\n')),(0,r.kt)("h3",{id:"solving-reversepinvokecallback-issues"},"Solving ReversePInvokeCallback Issues"),(0,r.kt)("p",null,"When DOTS system initializes Unmanaged Systems, it tries to get Marshal pointers for functions like OnStart. HybridCLR needs to bind a runtime-unique cpp function pointer for each such function,\notherwise a ",(0,r.kt)("inlineCode",{parentName:"p"},"GetReversePInvokeWrapper fail. exceed max wrapper num of method")," error will occur during runtime. For detailed introduction, see the ",(0,r.kt)("a",{parentName:"p",href:"https://hybridclr.doc.code-philosophy.com/docs/basic/workwithscriptlanguage"},"HybridCLR+lua/js/python")," documentation."),(0,r.kt)("p",null,"Simply put, you need to reserve enough wrapper functions corresponding to SystemBaseRegistry.ForwardingFunc. Add the following code in the hot update module (can also be in DHE assembly, but not in AOT assembly):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"public static class PreserveDOTSReversePInvokeWrapper\n{\n    [ReversePInvokeWrapperGeneration(100)]\n    [MonoPInvokeCallback(typeof(SystemBaseRegistry.ForwardingFunc))]\n    public static void ForwordMethod(IntPtr system, IntPtr state)\n    {\n\n    }\n}\n\n\n")),(0,r.kt)("p",null,"Change the 100 in the code to an appropriate number. It's recommended to be 5-10 times the number of Unmanaged System types."),(0,r.kt)("h3",{id:"burst-related"},"Burst Related"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"When hot update functions containing ",(0,r.kt)("inlineCode",{parentName:"li"},"[BurstCompile]")," change, you need to remove the ",(0,r.kt)("inlineCode",{parentName:"li"},"[BurstCompile]")," attribute, otherwise runtime errors will occur. This issue may be optimized in the future")))}m.isMDXComponent=!0}}]);