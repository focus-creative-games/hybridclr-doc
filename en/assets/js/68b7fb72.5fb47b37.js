"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[2064],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>y});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),u=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=u(e.components);return a.createElement(l.Provider,{value:t},e.children)},m="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),m=u(n),p=r,y=m["".concat(l,".").concat(p)]||m[p]||d[p]||o;return n?a.createElement(y,i(i({ref:t},c),{},{components:n})):a.createElement(y,i({ref:t},c))}));function y(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=p;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[m]="string"==typeof e?e:r,i[1]=s;for(var u=2;u<o;u++)i[u]=n[u];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},70399:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>u});var a=n(87462),r=(n(67294),n(3905));const o={},i="Retarget Metadata",s={unversionedId:"business/ultimate/retargetmetadata",id:"version-8.5.0/business/ultimate/retargetmetadata",title:"Retarget Metadata",description:"Anonymous classes and anonymous functions generated by the compiler are unstable. Sometimes, simply adding a new type or function to an assembly can cause a large number of anonymous classes and functions to have their names changed.",source:"@site/i18n/en/docusaurus-plugin-content-docs/version-8.5.0/business/ultimate/retargetmetadata.md",sourceDirName:"business/ultimate",slug:"/business/ultimate/retargetmetadata",permalink:"/en/docs/8.5.0/business/ultimate/retargetmetadata",draft:!1,tags:[],version:"8.5.0",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Function Injection Strategy",permalink:"/en/docs/8.5.0/business/ultimate/injectrules"},next:{title:"Common Issues",permalink:"/en/docs/8.5.0/business/ultimate/commonerrors"}},l={},u=[{value:"Issues with Functions Marked with <code>[BurstCompile]</code>",id:"issues-with-functions-marked-with-burstcompile",level:2},{value:"Retarget Anonymous Type Names and Anonymous Function Names",id:"retarget-anonymous-type-names-and-anonymous-function-names",level:2},{value:"Other Notes",id:"other-notes",level:2}],c={toc:u},m="wrapper";function d(e){let{components:t,...n}=e;return(0,r.kt)(m,(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"retarget-metadata"},"Retarget Metadata"),(0,r.kt)("p",null,"Anonymous classes and anonymous functions generated by the compiler are unstable. Sometimes, simply adding a new type or function to an assembly can cause a large number of anonymous classes and functions to have their names changed.\nEven though the code of these anonymous classes themselves hasn't changed, because their names have changed, when generating dhao files, these anonymous classes and functions will be judged as changed, causing these anonymous functions to execute interpretively, ultimately affecting runtime performance."),(0,r.kt)("h2",{id:"issues-with-functions-marked-with-burstcompile"},"Issues with Functions Marked with ",(0,r.kt)("inlineCode",{parentName:"h2"},"[BurstCompile]")),(0,r.kt)("p",null,"If the game uses burst-related technology, burst-related packages will modify functions marked with ",(0,r.kt)("inlineCode",{parentName:"p"},"[BurstCompile]")," during compilation, for example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"\n[BurstCompile]\nprivate static int DecryptNumber(int number, int mulFactor, int addFactor)\n{\n    return (number - addFactor) / mulFactor;\n}\n\n")),(0,r.kt)("p",null,"Will ultimately be compiled to:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"\n[BurstCompile]\nprivate static int DecryptNumber(int number, int mulFactor, int addFactor)\n{\n    return DecryptNumber_00000029$BurstDirectCall.Invoke(number, mulFactor, addFactor);\n}\n\npublic delegate int DecryptNumber_00000029$PostfixBurstDelegate(int number, int mulFactor, int addFactor);\n\ninternal static class DecryptNumber_00000029$BurstDirectCall\n{\n\n    // Some code omitted ... \n\n    public unsafe static int Invoke(int number, int mulFactor, int addFactor)\n    {\n        if (BurstCompiler.IsEnabled)\n        {\n            IntPtr functionPointer = GetFunctionPointer();\n            if (functionPointer != (IntPtr)0)\n            {\n                return ((delegate* unmanaged[Cdecl]<int, int, int, int>)functionPointer)(number, mulFactor, addFactor);\n            }\n        }\n        return DecryptNumber$BurstManaged(number, mulFactor, addFactor);\n    }\n}\n\n\n")),(0,r.kt)("p",null,"If you add some other types to the assembly, even without modifying the code of ",(0,r.kt)("inlineCode",{parentName:"p"},"DecryptNumber"),", during the next compilation, ",(0,r.kt)("inlineCode",{parentName:"p"},"DecryptNumber_00000029$BurstDirectCall")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"DecryptNumber_00000029$PostfixBurstDelegate")," might become ",(0,r.kt)("inlineCode",{parentName:"p"},"DecryptNumber_0000002A$BurstDirectCall")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"DecryptNumber_0000002A$PostfixBurstDelegate"),"."),(0,r.kt)("p",null,"This not only causes DecryptNumber to incorrectly execute interpretively, but in HybridCLR versions below 7.4.0, it may even cause runtime errors or crashes!"),(0,r.kt)("h2",{id:"retarget-anonymous-type-names-and-anonymous-function-names"},"Retarget Anonymous Type Names and Anonymous Function Names"),(0,r.kt)("p",null,"Starting from Ultimate version ",(0,r.kt)("inlineCode",{parentName:"p"},"v7.4.0"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"HybridCLR.Editor.AssemblyMetaRetarget")," is provided for retargeting metadata to enhance the stability of metadata related to anonymous classes and anonymous functions."),(0,r.kt)("p",null,"Usage is as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},'        private static void RetargetAssembly()\n        {\n            string dllName = "HotUpdate";\n\n            string dllDir = $"{Application.dataPath}/../Dlls";\n\n            string oldDllFile = $"{dllDir}/{dllName}.old.dll.bytes";\n            string newDllFile = $"{dllDir}/{dllName}.new.dll.bytes";\n            byte[] oldDllBytes = File.ReadAllBytes(oldDllFile);\n            byte[] newDllBytes = File.ReadAllBytes(newDllFile);\n\n            var retarget = new AssemblyMetaRetarget(oldDllBytes, newDllBytes);\n            retarget.Retarget();\n            retarget.Save($"{dllDir}/{dllName}.retargeted.dll.bytes");\n        }\n\n')),(0,r.kt)("h2",{id:"other-notes"},"Other Notes"),(0,r.kt)("p",null,"Retargeting metadata is optional. If you don't use ",(0,r.kt)("inlineCode",{parentName:"p"},"[BurstCompile]"),", this operation is generally not needed."),(0,r.kt)("p",null,"Please use the generated assembly as the latest hot update assembly after retargeting metadata, for generating dhao files."))}d.isMDXComponent=!0}}]);