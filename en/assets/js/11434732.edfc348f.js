"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[658],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>h});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),u=p(n),c=r,h=u["".concat(l,".").concat(c)]||u[c]||m[c]||i;return n?a.createElement(h,o(o({ref:t},d),{},{components:n})):a.createElement(h,o({ref:t},d))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=c;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[u]="string"==typeof e?e:r,o[1]=s;for(var p=2;p<i;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},1857:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>m,frontMatter:()=>i,metadata:()=>s,toc:()=>p});var a=n(87462),r=(n(67294),n(3905));const i={},o="Build and Hot Update",s={unversionedId:"business/ultimate/build",id:"business/ultimate/build",title:"Build and Hot Update",description:"Build Game",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/business/ultimate/build.md",sourceDirName:"business/ultimate",slug:"/business/ultimate/build",permalink:"/en/docs/business/ultimate/build",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Quick Start",permalink:"/en/docs/business/ultimate/quickstartunchecked"},next:{title:"Load Hot Update Assembly",permalink:"/en/docs/business/ultimate/loadassembly"}},l={},p=[{value:"Build Game",id:"build-game",level:2},{value:"Create AOT Snapshot",id:"create-aot-snapshot",level:2},{value:"Create AOT Base Snapshot Files",id:"create-aot-base-snapshot-files",level:3},{value:"Generate meta version files for dhe dlls in base AOT snapshot",id:"generate-meta-version-files-for-dhe-dlls-in-base-aot-snapshot",level:3},{value:"Carry AOT snapshot meta version files with package (optional but strongly recommended)",id:"carry-aot-snapshot-meta-version-files-with-package-optional-but-strongly-recommended",level:3},{value:"Multi-platform",id:"multi-platform",level:3},{value:"Version Control of Snapshots",id:"version-control-of-snapshots",level:3},{value:"Release Hot Update",id:"release-hot-update",level:2},{value:"Generate meta version files for hot update assemblies",id:"generate-meta-version-files-for-hot-update-assemblies",level:3},{value:"Others",id:"others",level:2},{value:"UserEditorSettings.development option",id:"usereditorsettingsdevelopment-option",level:3},{value:"Changes in HybridCLRSettings.differentialHybridAssemblies list",id:"changes-in-hybridclrsettingsdifferentialhybridassemblies-list",level:3}],d={toc:p},u="wrapper";function m(e){let{components:t,...n}=e;return(0,r.kt)(u,(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"build-and-hot-update"},"Build and Hot Update"),(0,r.kt)("h2",{id:"build-game"},"Build Game"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Run ",(0,r.kt)("inlineCode",{parentName:"li"},"HybridCLR/Generate/All")),(0,r.kt)("li",{parentName:"ul"},"Export project or directly Build in ",(0,r.kt)("inlineCode",{parentName:"li"},"Build Settings")),(0,r.kt)("li",{parentName:"ul"},"Create AOT snapshot and add AOT snapshot directory to version control"),(0,r.kt)("li",{parentName:"ul"},"Add the MetaVersions directory from AOT snapshot to StreamingAssets directory to carry with the package (optional but strongly recommended)")),(0,r.kt)("h2",{id:"create-aot-snapshot"},"Create AOT Snapshot"),(0,r.kt)("admonition",{type:"warning"},(0,r.kt)("p",{parentName:"admonition"},"The dlls in AOT snapshot must exactly match the binary code in the built main package. Be sure to create after ",(0,r.kt)("strong",{parentName:"p"},"exporting project")," or ",(0,r.kt)("strong",{parentName:"p"},"Build"),"!")),(0,r.kt)("p",null,"Process as follows:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Create AOT base snapshot files"),(0,r.kt)("li",{parentName:"ul"},"Generate meta version for dhe dlls in base AOT snapshot"),(0,r.kt)("li",{parentName:"ul"},"Add final AOT snapshot directory to version control")),(0,r.kt)("h3",{id:"create-aot-base-snapshot-files"},"Create AOT Base Snapshot Files"),(0,r.kt)("p",null,"Call ",(0,r.kt)("inlineCode",{parentName:"p"},"MetaVersionWorkflow.CreateAotSnapshot(BuildTarget target, string outputSnapshotDir)")," to create snapshot base files."),(0,r.kt)("p",null,"CreateAotSnapshot does the following work:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Copy all AOT and DHE dlls"),(0,r.kt)("li",{parentName:"ul"},"Copy inject rule files to InjectRules directory"),(0,r.kt)("li",{parentName:"ul"},"Create manifest.json to record all DHE assembly lists")),(0,r.kt)("p",null,"Base snapshot directory structure as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-txt"},"  AotSnapshot\n  \u251c\u2500\u2500 *.dll\n  \u251c\u2500\u2500 InjectRules\n        \u251c\u2500\u2500rule1.xml\n        \u251c\u2500\u2500rule2.xml\n  \u2514\u2500\u2500 manifest.json\n")),(0,r.kt)("h3",{id:"generate-meta-version-files-for-dhe-dlls-in-base-aot-snapshot"},"Generate meta version files for dhe dlls in base AOT snapshot"),(0,r.kt)("p",null,"Call ",(0,r.kt)("inlineCode",{parentName:"p"},"MetaVersionWorkflow.GenerateAotSnapshotMetaVersionFiles(string prevSnapshotDir, string curSnapshotDir)")," to generate corresponding meta version files for dhe dlls in snapshot."),(0,r.kt)("p",null,"Parameter rules for ",(0,r.kt)("inlineCode",{parentName:"p"},"prevSnapshotDir")," in ",(0,r.kt)("inlineCode",{parentName:"p"},"MetaVersionWorkflow.GenerateAotSnapshotMetaVersionFiles"),":"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"If it's the first AotSnapshot, since there's no older AotSnapshot, ",(0,r.kt)("inlineCode",{parentName:"li"},"prevSnapshotDir")," takes null."),(0,r.kt)("li",{parentName:"ul"},"If the project uses single main package mode, i.e., only one valid main package exists at the same time, and old main packages become invalid after releasing new main packages, then ",(0,r.kt)("inlineCode",{parentName:"li"},"prevSnapshotDir")," takes null."),(0,r.kt)("li",{parentName:"ul"},"If the project uses multiple main package mode, i.e., old main packages remain valid after releasing new main packages, then the ",(0,r.kt)("inlineCode",{parentName:"li"},"prevSnapshotDir")," parameter takes the AotSnapshot directory of the previously released main package.")),(0,r.kt)("p",null,"GenerateAotSnapshotMetaVersionFiles generates the following files:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"meta version and spec files. Generated to MetaVersions directory"),(0,r.kt)("li",{parentName:"ul"},"signature-mapper.json file")),(0,r.kt)("p",null,"Directory structure before generation:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-txt"},"  Snapshots\n  \u251c\u2500\u2500 PrevAotSnapshotDir\n      \u251c\u2500\u2500 *.dll\n      \u251c\u2500\u2500 InjectRules\n      \u251c\u2500\u2500 MetaVersions\n        \u251c\u2500\u2500 *.mv.bytes\n        \u251c\u2500\u2500 *.mv.spec\n        \u251c\u2500\u2500 *.mv.diff.spec\n      \u251c\u2500\u2500 signature-mapper.json\n      \u2514\u2500\u2500 manifest.json\n  \u251c\u2500\u2500 CurrentSnapshotDir\n      \u251c\u2500\u2500 *.dll\n      \u251c\u2500\u2500 InjectRules\n      \u2514\u2500\u2500 manifest.json\n")),(0,r.kt)("p",null,"After generation, MetaVersions directory and signature-mapper.json file are added. Final directory structure:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-txt"},"  Snapshots\n  \u251c\u2500\u2500 PrevAotSnapshotDir\n      \u251c\u2500\u2500 *.dll\n      \u251c\u2500\u2500 InjectRules\n      \u251c\u2500\u2500 MetaVersions\n        \u251c\u2500\u2500 *.mv.bytes\n        \u251c\u2500\u2500 *.mv.spec\n        \u251c\u2500\u2500 *.mv.diff.spec\n      \u251c\u2500\u2500 signature-mapper.json\n      \u2514\u2500\u2500 manifest.json\n  \u251c\u2500\u2500 CurrentAotSnapshotDir\n      \u251c\u2500\u2500 *.dll\n      \u251c\u2500\u2500 InjectRules\n      \u251c\u2500\u2500 MetaVersions (New)\n        \u251c\u2500\u2500 *.mv.bytes\n        \u251c\u2500\u2500 *.mv.spec\n        \u251c\u2500\u2500 *.mv.diff.spec\n      \u251c\u2500\u2500 signature-mapper.json (New)\n      \u2514\u2500\u2500 manifest.json\n")),(0,r.kt)("h3",{id:"carry-aot-snapshot-meta-version-files-with-package-optional-but-strongly-recommended"},"Carry AOT snapshot meta version files with package (optional but strongly recommended)"),(0,r.kt)("p",null,"The parameter ",(0,r.kt)("inlineCode",{parentName:"p"},"originalMetaVersionFileBytes")," of ",(0,r.kt)("inlineCode",{parentName:"p"},"RuntimeApi::LoadDifferentialHybridAssemblyWithMetaVersion")," is the content of the corresponding meta version file in the AOT snapshot of the DHE assembly.\nThis meta version file is different for each main package and is completely determined when building the main package. This file is relatively small, so it's strongly recommended to carry it with the main package."),(0,r.kt)("h3",{id:"multi-platform"},"Multi-platform"),(0,r.kt)("p",null,"Most games release on multiple platforms. Due to significant differences in main package AOT dlls between different platforms, we ",(0,r.kt)("strong",{parentName:"p"},"strongly recommend")," maintaining separate AotSnapshot trees for each platform. Directory structure like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-txt"},"  Snapshots\n  \u251c\u2500\u2500 PreAotSnapshotDir-StandaloneWindows64\n  \u251c\u2500\u2500 CurrentAotSnapshotDir-StandaloneWindows64\n  \u251c\u2500\u2500 PreAotSnapshotDir-Android64\n  \u251c\u2500\u2500 CurrentAotSnapshotDir-Android64\n  \u251c\u2500\u2500 PreAotSnapshotDir-iOS\n  \u251c\u2500\u2500 CurrentAotSnapshotDir-iOS\n\n")),(0,r.kt)("p",null,"For example, when calculating meta version for a newly released Win64 main package, use the snapshot directory of the previously released Win64 main package and the snapshot of the new main package to calculate the meta version for the new main package."),(0,r.kt)("h3",{id:"version-control-of-snapshots"},"Version Control of Snapshots"),(0,r.kt)("p",null,"The directory structure given in the previous section ",(0,r.kt)("inlineCode",{parentName:"p"},"Multi-platform")," is actually not convenient for version control. A directory structure suitable for version control should be like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-txt"},"  Snapshots\n  \u251c\u2500\u2500 AotSnapshotDir-StandaloneWindows64\n  \u251c\u2500\u2500 AotSnapshotDir-Android64\n  \u251c\u2500\u2500 AotSnapshotDir-iOS\n")),(0,r.kt)("p",null,"Snapshot update process:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Create a ",(0,r.kt)("inlineCode",{parentName:"li"},"CurrentAotSnapshotDir-{buildTarget}")," directory for the latest main package."),(0,r.kt)("li",{parentName:"ul"},"Compare ",(0,r.kt)("inlineCode",{parentName:"li"},"CurrentAotSnapshotDir-{buildTarget}")," with ",(0,r.kt)("inlineCode",{parentName:"li"},"AotSnapshotDir-{buildTarget}")," to calculate meta version files for ",(0,r.kt)("inlineCode",{parentName:"li"},"CurrentAotSnapshotDir-{buildTarget}"),"."),(0,r.kt)("li",{parentName:"ul"},"Replace ",(0,r.kt)("inlineCode",{parentName:"li"},"AotSnapshotDir-{buildTarget}")," with ",(0,r.kt)("inlineCode",{parentName:"li"},"CurrentAotSnapshotDir-{buildTarget}"),"."),(0,r.kt)("li",{parentName:"ul"},"Commit ",(0,r.kt)("inlineCode",{parentName:"li"},"AotSnapshotDir-{buildTarget}")," to repository.")),(0,r.kt)("h2",{id:"release-hot-update"},"Release Hot Update"),(0,r.kt)("p",null,"The Ultimate version is a superset of Professional and community versions, supporting both community version's pure interpreted assemblies and DHE assemblies, which can coexist."),(0,r.kt)("p",null,"Since DHE assemblies are compiled into AOT, DHE assemblies cannot depend on ordinary pure interpreted hot update assemblies, otherwise building the main package will fail due to compilation errors. However, ordinary hot update assemblies can depend on DHE assemblies.\nDHE assemblies can also depend on DHE assemblies."),(0,r.kt)("p",null,"The configuration and release process for ordinary hot update assemblies is exactly the same as the community version, so it won't be repeated here. Only the hot update process for DHE assemblies is introduced."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Use ",(0,r.kt)("inlineCode",{parentName:"li"},"HybridCLR/CompileDll/ActivedBuildTarget")," to generate hot update dlls."),(0,r.kt)("li",{parentName:"ul"},"Generate meta version files for hot update assemblies."),(0,r.kt)("li",{parentName:"ul"},"Add the latest hot update dlls and meta version files to the hot update resource management system.")),(0,r.kt)("h3",{id:"generate-meta-version-files-for-hot-update-assemblies"},"Generate meta version files for hot update assemblies"),(0,r.kt)("p",null,"Call ",(0,r.kt)("inlineCode",{parentName:"p"},"MetaVersionWorkflow.GenerateHotUpdateMetaVersionFiles(string aotSnapshotDir, string hotUpdateSnapshotDir)")," to generate meta version files for hot update assemblies.\nWhere ",(0,r.kt)("inlineCode",{parentName:"p"},"aotSnapshotDir")," is the latest ",(0,r.kt)("inlineCode",{parentName:"p"},"AotSnapshot-{buildTarget}")," directory, and ",(0,r.kt)("inlineCode",{parentName:"p"},"hotUpdateSnapshotDir")," is the latest hot update assembly directory."),(0,r.kt)("p",null,"After calling this function, meta version files corresponding to DHE assemblies will be generated in the ",(0,r.kt)("inlineCode",{parentName:"p"},"{hotUpdateSnapshotDir}/MetaVersions")," directory. Directory structure similar to:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-txt"},"  HotUpdateSnapshot\n  \u251c\u2500\u2500 *.dll\n  \u251c\u2500\u2500 MetaVersions\n    \u251c\u2500\u2500 *.mv.bytes\n    \u251c\u2500\u2500 *.mv.spec\n    \u251c\u2500\u2500 *.mv.diff.spec\n")),(0,r.kt)("p",null,"Example code as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"        public static void GenerateHotUpdateMetaVersionFiles(BuildTarget target)\n        {\n            var latestSnapshotSolutionDir = GetAOTAssemblySnapshotDir(target);\n            var newHotUpdateSolutionDir = SettingsUtil.GetHotUpdateDllsOutputDirByTarget(target);\n            MetaVersionWorkflow.GenerateHotUpdateMetaVersionFiles(latestSnapshotSolutionDir, newHotUpdateSolutionDir);\n        }\n\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"*.mv.spec")," is a readable version of ",(0,r.kt)("inlineCode",{parentName:"p"},"*.mv.bytes"),", while ",(0,r.kt)("inlineCode",{parentName:"p"},"*.mv.diff.spec")," records metadata that has version changes in ",(0,r.kt)("inlineCode",{parentName:"p"},"*.mv.spec"),". These two types of files are only used for convenient problem tracking and are not used during runtime.\nIt's recommended to add them to the repository, but don't add them to hot update resources because they serve no purpose!"),(0,r.kt)("h2",{id:"others"},"Others"),(0,r.kt)("h3",{id:"usereditorsettingsdevelopment-option"},"UserEditorSettings.development option"),(0,r.kt)("p",null,"The development option when releasing the main package and the development option when releasing hot updates must be consistent, i.e., the UserEditorSettings.development option must be consistent when creating AotSnapshot and compiling hot update dlls. Because development has a huge impact on the finally compiled dlls,\ninconsistent development parameters will cause huge changes in calculated meta versions!"),(0,r.kt)("h3",{id:"changes-in-hybridclrsettingsdifferentialhybridassemblies-list"},"Changes in HybridCLRSettings.differentialHybridAssemblies list"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"MetaVersionWorkflow.GenerateAotSnapshotMetaVersionFiles(string prevSnapshotDir, string curSnapshotDir)")," requires that the DHE assembly lists of prevSnapshotDir and curSnapshotDir snapshots are the same."),(0,r.kt)("p",null,"If DHE assemblies are added or removed from a certain main package onwards, it will cause meta version generation to fail. The solution is to create a brand new ",(0,r.kt)("inlineCode",{parentName:"p"},"AotSnapshot-{buildTarget}-v2")," version tree starting from this main package. Directory structure similar to:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-txt"},"  Snapshots\n  \u251c\u2500\u2500 AotSnapshotDir-StandaloneWindows64-v1\n  \u251c\u2500\u2500 AotSnapshotDir-StandaloneWindows64-v2\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Use v1 version DHE list configuration to generate meta version files for v1 version AotSnapshot and HotUpdateSnapshot."),(0,r.kt)("li",{parentName:"ul"},"Use v2 version DHE list configuration to generate meta version files for v2 version AotSnapshot and HotUpdateSnapshot.")),(0,r.kt)("p",null,"When releasing hot updates, v1 main packages can only load v1 version HotUpdateSnapshot dlls and meta version files. v2 version main packages can only load v2 version HotUpdateSnapshot dlls and meta version files."))}m.isMDXComponent=!0}}]);