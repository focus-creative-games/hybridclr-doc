"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[1192],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var d=a.createContext({}),s=function(e){var t=a.useContext(d),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=s(e.components);return a.createElement(d.Provider,{value:t},e.children)},u="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,d=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=s(n),h=i,m=u["".concat(d,".").concat(h)]||u[h]||p[h]||r;return n?a.createElement(m,o(o({ref:t},c),{},{components:n})):a.createElement(m,o({ref:t},c))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=h;var l={};for(var d in t)hasOwnProperty.call(t,d)&&(l[d]=t[d]);l.originalType=e,l[u]="string"==typeof e?e:i,o[1]=l;for(var s=2;s<r;s++)o[s]=n[s];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},5044:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>o,default:()=>p,frontMatter:()=>r,metadata:()=>l,toc:()=>s});var a=n(7462),i=(n(7294),n(3905));const r={},o="Differential Hybrid Execution",l={unversionedId:"advanced/differentialhybridexecution",id:"advanced/differentialhybridexecution",title:"Differential Hybrid Execution",description:"HybridCLR pioneered the implementation of Differential Hybrid Execution (DHE) differential hybrid execution technology. That is, you can add, delete, or modify the AOT dll at will, and intelligently make the changed or newly added classes and functions run in interpreter mode, but the unchanged classes and functions run in AOT mode, so that the running performance of the hot-updated game logic basically reaches the original AOT level.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/advanced/differentialhybridexecution.md",sourceDirName:"advanced",slug:"/advanced/differentialhybridexecution",permalink:"/en/docs/advanced/differentialhybridexecution",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"\u8fdb\u9636\u6307\u5357",permalink:"/en/docs/advanced"},next:{title:"HybridCLR+lua/js/python",permalink:"/en/docs/advanced/workwithscriptlanguage"}},d={},s=[{value:"principle",id:"principle",level:2},{value:"Features and Benefits",id:"features-and-benefits",level:2},{value:"Unsupported feature",id:"unsupported-feature",level:2},{value:"Install",id:"install",level:2},{value:"configuration",id:"configuration",level:2},{value:"Configure the assembly that requires differential mixed execution",id:"configure-the-assembly-that-requires-differential-mixed-execution",level:3},{value:"Configure the backup directory of the original AOT dll",id:"configure-the-backup-directory-of-the-original-aot-dll",level:3},{value:"Configure the export directory of the configuration data of the assembly executed by the differential hybrid",id:"configure-the-export-directory-of-the-configuration-data-of-the-assembly-executed-by-the-differential-hybrid",level:3},{value:"Mark function information",id:"mark-function-information",level:3},{value:"used in the code",id:"used-in-the-code",level:2},{value:"Pack",id:"pack",level:2},{value:"Hot update",id:"hot-update",level:2}],c={toc:s},u="wrapper";function p(e){let{components:t,...n}=e;return(0,i.kt)(u,(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"differential-hybrid-execution"},"Differential Hybrid Execution"),(0,i.kt)("p",null,"HybridCLR pioneered the implementation of Differential Hybrid Execution (DHE) differential hybrid execution technology. That is, you can add, delete, or modify the AOT dll at will, and intelligently make the changed or newly added classes and functions run in interpreter mode, but the unchanged classes and functions run in AOT mode, so that the running performance of the hot-updated game logic basically reaches the original AOT level."),(0,i.kt)("admonition",{type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"DHE is only included in ",(0,i.kt)("strong",{parentName:"p"},"Enterprise Ultimate Edition"),", please refer to ",(0,i.kt)("a",{parentName:"p",href:"/en/docs/other/business"},"Commercial Services")," for details.")),(0,i.kt)("h2",{id:"principle"},"principle"),(0,i.kt)("p",null,"Put the assembly marked as DHE into the main package, and then load the latest hot update dll after running. During the execution process, when calling a function of a DHE assembly, if the function has not changed, the native AOT implementation will be called directly, otherwise the latest code will be executed in an interpreted manner.\nSince the two versions often do not modify too much code in practice, DHE can basically approach the native performance level."),(0,i.kt)("h2",{id:"features-and-benefits"},"Features and Benefits"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"The performance of the unchanged part of the code is exactly the same as that of the native version, which is an astonishing ",(0,i.kt)("strong",{parentName:"li"},"3-30")," times or even higher than the purely interpreted version, and the overall performance almost reaches the native performance level."),(0,i.kt)("li",{parentName:"ul"},"The code can be changed arbitrarily, there is basically no intrusion to the code, there are almost no special precautions, and the usage method is similar to the community version."),(0,i.kt)("li",{parentName:"ul"},"The workflow is simple, you don't need to mark which functions have changed like xxxfix and other solutions, and the tools will automatically handle them"),(0,i.kt)("li",{parentName:"ul"},"Retrofits to items cost less than pure hot update versions. For example, extern functions can be defined directly in DHE without moving to the AOT module."),(0,i.kt)("li",{parentName:"ul"},"The advanced version includes ",(0,i.kt)("strong",{parentName:"li"},"interpretation instruction optimization, and the performance of most numerical calculation instructions in the changed part is improved by 100-300% or more"),", further greatly improving the performance level."),(0,i.kt)("li",{parentName:"ul"},"The native code is all in the package body, the risk of being rejected by iOS is greatly reduced")),(0,i.kt)("h2",{id:"unsupported-feature"},"Unsupported feature"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Any code in the AOT assembly corresponding to DHE cannot be executed before the DHE hot update code is loaded. It means that DHE does not support differential mixing of basic libraries like mscorlib, but supports differential hot update of traditional hot update assembly."),(0,i.kt)("li",{parentName:"ul"},"Due to the first restriction, ",(0,i.kt)("inlineCode",{parentName:"li"},"[InitializeOnLoadMethod]")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"Script Execution Order settings")," are not supported in DHE assemblies."),(0,i.kt)("li",{parentName:"ul"},"DHE scripts are not supported to be mounted in package resources, including Resources. (This restriction will be relaxed or removed in the future)"),(0,i.kt)("li",{parentName:"ul"},"Cannot add extern function in DHE assembly through hot update.")),(0,i.kt)("h2",{id:"install"},"Install"),(0,i.kt)("p",null,"Unzip the libil2cpp-xxx.7zip package we provided, enable the copy libil2cpp from local option in the ",(0,i.kt)("inlineCode",{parentName:"p"},"Installer"),", point the directory to the libil2cpp directory extracted from it, and then execute the installation."),(0,i.kt)("h2",{id:"configuration"},"configuration"),(0,i.kt)("h3",{id:"configure-the-assembly-that-requires-differential-mixed-execution"},"Configure the assembly that requires differential mixed execution"),(0,i.kt)("p",null,"Open the configuration dialog through the ",(0,i.kt)("inlineCode",{parentName:"p"},"HybridCLR/Settings")," menu, and add the assemblies that require differential hybrid execution to differentialHybridAssemblies (differential hybrid execution dlls).\nThe workflow of the differential mixed execution assembly is different from that of the ordinary pure hot update assembly, because the pure hot update assembly does not need to be packaged into the main project. Therefore, the same assembly",(0,i.kt)("strong",{parentName:"p"}," cannot be added at the same time"),"\nlist of differentialHybridAssemblies and hotUpdateAssemblies. ",(0,i.kt)("inlineCode",{parentName:"p"},"RuntimeApi::LoadDifferentialHybridAssembly")," must be executed before any code that executes the differential hybrid assembly,\nTherefore, not all assemblies can be configured as differential mixed execution assemblies, because system assemblies such as mscorlib run very early. Fortunately, assemblies like mscorlib have no need for differential mixed execution.\nMost game logic assemblies are executed after the hot update, which satisfies the conditions for differential mixed execution."),(0,i.kt)("h3",{id:"configure-the-backup-directory-of-the-original-aot-dll"},"Configure the backup directory of the original AOT dll"),(0,i.kt)("p",null,"This directory is used to save the AOT dll generated during packaging. Every time a dhao file is generated later, the dll in this directory is used as the original AOT dll.\nDue to frequent temporary packaging, AOT dll does not need to be backed up in most cases, so the backup behavior needs to manually call the ",(0,i.kt)("inlineCode",{parentName:"p"},"HybridCLR/CreateAOTDllSnapshot")," menu command."),(0,i.kt)("admonition",{type:"caution"},(0,i.kt)("p",{parentName:"admonition"},"When you officially release the package, you must remember to back up the AOT dll by yourself or use this command after packaging, and submit it to your version management system.")),(0,i.kt)("h3",{id:"configure-the-export-directory-of-the-configuration-data-of-the-assembly-executed-by-the-differential-hybrid"},"Configure the export directory of the configuration data of the assembly executed by the differential hybrid"),(0,i.kt)("p",null,"Configure ",(0,i.kt)("inlineCode",{parentName:"p"},"differentialHybridOptionOutputDir")," field in HybridCLRSetting. Using ",(0,i.kt)("inlineCode",{parentName:"p"},"HybridCLR/generate/DHEAssemblyOptionDatas")," will generate a ",(0,i.kt)("inlineCode",{parentName:"p"},"<assembly>.dhao.bytes")," file for each differential hybrid assembly."),(0,i.kt)("p",null,"Loading a differential hybrid execution assembly requires some configuration data. For example, which functions are changed are calculated offline, so that there is no need to determine whether the function has changed at runtime. The configuration data is passed in as a parameter when calling ",(0,i.kt)("inlineCode",{parentName:"p"},"RuntimeApi::LoadDifferentialHybridAssembly"),"."),(0,i.kt)("h3",{id:"mark-function-information"},"Mark function information"),(0,i.kt)("p",null,"At present, the function of change can be automatically calculated without manual operation. But it also supports manually using ",(0,i.kt)("inlineCode",{parentName:"p"},"[Unchanged]")," to mark which functions have not changed."),(0,i.kt)("admonition",{type:"danger"},(0,i.kt)("p",{parentName:"admonition"},"It is strongly recommended not to manually tag your own. Because the compiler often generates some hidden classes or fields, these class names are not stable. The C# code that looks the same on the surface may not actually generate the same code.")),(0,i.kt)("h2",{id:"used-in-the-code"},"used in the code"),(0,i.kt)("p",null,"At runtime, after completing the hot update, for each hybrid execution assembly, call ",(0,i.kt)("inlineCode",{parentName:"p"},"RuntimeApi::LoadDifferentialHybridAssembly")," to load the hot update assembly. Generally speaking, the passed parameters are compiled by ",(0,i.kt)("inlineCode",{parentName:"p"},"HybridCLR/CompileDll/xxx"),"\nHot update dll and dhao data generated by ",(0,i.kt)("inlineCode",{parentName:"p"},"HybridCLR/Generate/DHEAssemblyOptionDatas"),". But when it was just released and there was no hot update version, the passed parameters were ",(0,i.kt)("inlineCode",{parentName:"p"},"AOT dll generated during packaging")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"null dhao data"),"."),(0,i.kt)("p",null,"Precautions:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"To load the differential hybrid execution assembly in the order of its dependencies."),(0,i.kt)("li",{parentName:"ul"},"If a certain assembly has not changed, the dhao field can pass null, but at this time, the AOT dll generated during packaging must be used instead of the hot update dll generated by the ",(0,i.kt)("inlineCode",{parentName:"li"},"HybridCLR/CompileDll/xxx")," command.")),(0,i.kt)("p",null,"The sample code is as follows."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-csharp"},"void InitDifferentialHybridAssembly(string assemblyName)\n{\n     // When there is no hot update, the passed parameter is null.\n     byte[] dhaoBytes = needHotUpdate ? GetAssemblyOptionData(assemblyName) : null;\n     LoadImageErrCode err = RuntimeApi.LoadDifferentialHybridAssembly(GetAssemblyData(assemblyName), dhaoBytes);\n}\n")),(0,i.kt)("h2",{id:"pack"},"Pack"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"If the ",(0,i.kt)("strong",{parentName:"li"},"development build option")," is used for packaging, please be sure to use ",(0,i.kt)("inlineCode",{parentName:"li"},"HybridCLR/CompileDll/ActivedBuildTarget_Development")," to compile the hot update dll in Development mode, otherwise the comparison result is that almost all functions are judged to have changed."),(0,i.kt)("li",{parentName:"ul"},"Run ",(0,i.kt)("inlineCode",{parentName:"li"},"HybridCLR/CreateAOTDllSnapshot")," to back up the AOT file and add it to the version management system. Notice! Due to the instability generated by clipping AOT dll, do not try to save trouble with the AOT dll generated by the ",(0,i.kt)("inlineCode",{parentName:"li"},"HybridCLR/Generate/All")," command."),(0,i.kt)("li",{parentName:"ul"},"Since the DHE assembly is the latest when packaging, there is no change, so there is no need to carry the dhao file."),(0,i.kt)("li",{parentName:"ul"},"If you want to carry the aot dll corresponding to the DHE assembly with the package, according to your BuildTarget:\n-iOS. After exporting the xcode project, copy the DHE dll under ",(0,i.kt)("inlineCode",{parentName:"li"},"{proj}/HybridCLRData/AssembliesPostIl2CppStrip/{buildTarget}")," to the StreamingAssets directory (or subdirectory)\n-Android. If you export the gradle project first and then package it, it is the same as iOS. Otherwise, you can create a new Editor script, implement the ",(0,i.kt)("inlineCode",{parentName:"li"},"IPostGenerateGradleAndroidProject")," interface, and copy the generated DHE AOT assembly to the gradle project in the OnPostGenerateGradleAndroidProject event.")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-csharp"},'\n// sample code\npublic class CopyDHEAOTDllsToAndroidProject : IPostGenerateGradleAndroidProject\n{\n     public int callbackOrder => 0;\n\n     public void OnPostGenerateGradleAndroidProject(string path)\n     {\n         BuildTarget target = EditorUserBuildSettings. activeBuildTarget;\n         string pathInGradleProjectOfStreamingAssets = "xxx"; // Path of the StreamingAssets directory in the exported gradle project\n         HybridCLR.Editor.Installer.BashUtil.CopyDir(SettingsUtil.GetHotUpdateDllsOutputDirByTarget(target), pathInGradleProjectOfStreamingAssets);\n     }\n}\n\n')),(0,i.kt)("h2",{id:"hot-update"},"Hot update"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Use ",(0,i.kt)("inlineCode",{parentName:"li"},"HybridCLR/CompileDll/ActivedBuildTarget")," to generate hot update dll."),(0,i.kt)("li",{parentName:"ul"},"Make sure you have run ",(0,i.kt)("inlineCode",{parentName:"li"},"HybridCLR/CreateAOTDllSnapshot")," to back up the AOT file, and make sure that the AOT dll in the backup directory is the AOT dll generated during packaging."),(0,i.kt)("li",{parentName:"ul"},"Use ",(0,i.kt)("inlineCode",{parentName:"li"},"HybridCLR/generate/DHEAssemblyOptionDatas")," to generate dhao files.")),(0,i.kt)("admonition",{type:"caution"},(0,i.kt)("p",{parentName:"admonition"}," Because the working principle of DHEAssemblyOptionDatas is to compare the latest hot update ",(0,i.kt)("inlineCode",{parentName:"p"},"DHE dll")," with the aot dll in the backup directory of the original AOT dll, and generate changed function and type information. Please be sure to ensure hot update dll and backup\nThe correctness of the AOT dll!")))}p.isMDXComponent=!0}}]);