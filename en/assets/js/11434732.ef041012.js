"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[658],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>c});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},h="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),h=p(n),m=i,c=h["".concat(l,".").concat(m)]||h[m]||u[m]||r;return n?a.createElement(c,o(o({ref:t},d),{},{components:n})):a.createElement(c,o({ref:t},d))}));function c(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[h]="string"==typeof e?e:i,o[1]=s;for(var p=2;p<r;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},1857:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>p});var a=n(7462),i=(n(7294),n(3905));const r={},o="Building and Hot Updating",s={unversionedId:"business/ultimate/build",id:"business/ultimate/build",title:"Building and Hot Updating",description:"Building the Game",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/business/ultimate/build.md",sourceDirName:"business/ultimate",slug:"/business/ultimate/build",permalink:"/en/docs/business/ultimate/build",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Quick Start",permalink:"/en/docs/business/ultimate/quickstartunchecked"},next:{title:"Loading Hot Update Assemblies",permalink:"/en/docs/business/ultimate/loadassembly"}},l={},p=[{value:"Building the Game",id:"building-the-game",level:2},{value:"Creating AOT Snapshots",id:"creating-aot-snapshots",level:2},{value:"Creating the Base AOT Snapshot File",id:"creating-the-base-aot-snapshot-file",level:3},{value:"Generating Meta Version Files for DHE DLLs in the Base AOT Snapshot",id:"generating-meta-version-files-for-dhe-dlls-in-the-base-aot-snapshot",level:3},{value:"Including AOT Snapshot Meta Version Files in the Main Package (Optional but Highly Recommended)",id:"including-aot-snapshot-meta-version-files-in-the-main-package-optional-but-highly-recommended",level:3},{value:"Multi-Platform Considerations",id:"multi-platform-considerations",level:3},{value:"Version Control for Snapshots",id:"version-control-for-snapshots",level:3},{value:"Publishing Hot Updates",id:"publishing-hot-updates",level:2},{value:"Generating Meta Version Files for Hot Update Assemblies",id:"generating-meta-version-files-for-hot-update-assemblies",level:3},{value:"Other Considerations",id:"other-considerations",level:2},{value:"UserEditorSettings.development Option",id:"usereditorsettingsdevelopment-option",level:3},{value:"Changes in HybridCLRSettings.differentialHybridAssemblies List",id:"changes-in-hybridclrsettingsdifferentialhybridassemblies-list",level:3}],d={toc:p},h="wrapper";function u(e){let{components:t,...n}=e;return(0,i.kt)(h,(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"building-and-hot-updating"},"Building and Hot Updating"),(0,i.kt)("h2",{id:"building-the-game"},"Building the Game"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Run ",(0,i.kt)("inlineCode",{parentName:"li"},"HybridCLR/Generate/All"),"."),(0,i.kt)("li",{parentName:"ul"},"Export the project or build directly from the ",(0,i.kt)("inlineCode",{parentName:"li"},"Build Settings"),"."),(0,i.kt)("li",{parentName:"ul"},"Create an AOT snapshot and add the AOT snapshot directory to version control."),(0,i.kt)("li",{parentName:"ul"},"Add the ",(0,i.kt)("inlineCode",{parentName:"li"},"MetaVersions")," directory from the AOT snapshot to the ",(0,i.kt)("inlineCode",{parentName:"li"},"StreamingAssets")," directory, and package it with the game (optional but highly recommended).")),(0,i.kt)("h2",{id:"creating-aot-snapshots"},"Creating AOT Snapshots"),(0,i.kt)("admonition",{type:"warning"},(0,i.kt)("p",{parentName:"admonition"},"The DLLs in the AOT snapshot must match the binary code of the main package exactly. Please create the AOT snapshot ",(0,i.kt)("strong",{parentName:"p"},"after")," exporting the project or building the main package!")),(0,i.kt)("p",null,"The process is as follows:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Create the base AOT snapshot file."),(0,i.kt)("li",{parentName:"ul"},"Generate meta versions for the DHE DLLs in the base AOT snapshot."),(0,i.kt)("li",{parentName:"ul"},"Add the final AOT snapshot directory to version control.")),(0,i.kt)("h3",{id:"creating-the-base-aot-snapshot-file"},"Creating the Base AOT Snapshot File"),(0,i.kt)("p",null,"Call ",(0,i.kt)("inlineCode",{parentName:"p"},"MetaVersionWorkflow.CreateAotSnapshot(BuildTarget target, string outputSnapshotDir)")," to create the base snapshot file."),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"CreateAotSnapshot")," performs the following tasks:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Copies all AOT and DHE DLLs."),(0,i.kt)("li",{parentName:"ul"},"Copies the inject rule files to the ",(0,i.kt)("inlineCode",{parentName:"li"},"InjectRules")," directory."),(0,i.kt)("li",{parentName:"ul"},"Creates a ",(0,i.kt)("inlineCode",{parentName:"li"},"manifest.json")," file, which records the list of all DHE assemblies.")),(0,i.kt)("p",null,"The base snapshot directory structure is as follows:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-txt"},"  AotSnapshot\n  \u251c\u2500\u2500 *.dll\n  \u251c\u2500\u2500 InjectRules\n        \u251c\u2500\u2500 rule1.xml\n        \u251c\u2500\u2500 rule2.xml\n  \u2514\u2500\u2500 manifest.json\n")),(0,i.kt)("h3",{id:"generating-meta-version-files-for-dhe-dlls-in-the-base-aot-snapshot"},"Generating Meta Version Files for DHE DLLs in the Base AOT Snapshot"),(0,i.kt)("p",null,"Call ",(0,i.kt)("inlineCode",{parentName:"p"},"MetaVersionWorkflow.GenerateAotSnapshotMetaVersionFiles(string prevSnapshotDir, string curSnapshotDir)")," to generate meta version files for the DHE DLLs in the snapshot."),(0,i.kt)("p",null,"The rules for the ",(0,i.kt)("inlineCode",{parentName:"p"},"prevSnapshotDir")," parameter in ",(0,i.kt)("inlineCode",{parentName:"p"},"MetaVersionWorkflow.GenerateAotSnapshotMetaVersionFiles")," are as follows:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"If this is the first AotSnapshot (i.e., there is no older AotSnapshot), ",(0,i.kt)("inlineCode",{parentName:"li"},"prevSnapshotDir")," should be ",(0,i.kt)("inlineCode",{parentName:"li"},"null"),"."),(0,i.kt)("li",{parentName:"ul"},"If the project uses a single main package mode (i.e., only one main package is valid at a time and a new main package invalidates the old one), ",(0,i.kt)("inlineCode",{parentName:"li"},"prevSnapshotDir")," should be ",(0,i.kt)("inlineCode",{parentName:"li"},"null"),"."),(0,i.kt)("li",{parentName:"ul"},"If the project uses a multi-main package mode (i.e., old main packages remain valid after a new one is released), ",(0,i.kt)("inlineCode",{parentName:"li"},"prevSnapshotDir")," should point to the AotSnapshot directory of the previously released main package.")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"GenerateAotSnapshotMetaVersionFiles")," generates the following files:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Meta version and spec files, which are placed in the ",(0,i.kt)("inlineCode",{parentName:"li"},"MetaVersions")," directory."),(0,i.kt)("li",{parentName:"ul"},"A ",(0,i.kt)("inlineCode",{parentName:"li"},"signature-mapper.json")," file.")),(0,i.kt)("p",null,"The directory structure before generation is as follows:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-txt"},"  Snapshots\n  \u251c\u2500\u2500 PrevAotSnapshotDir\n      \u251c\u2500\u2500 *.dll\n      \u251c\u2500\u2500 InjectRules\n      \u251c\u2500\u2500 MetaVersions\n        \u251c\u2500\u2500 *.mv.bytes\n        \u251c\u2500\u2500 *.mv.spec\n        \u251c\u2500\u2500 *.mv.diff.spec\n      \u251c\u2500\u2500 signature-mapper.json\n      \u2514\u2500\u2500 manifest.json\n  \u251c\u2500\u2500 CurrentSnapshotDir\n      \u251c\u2500\u2500 *.dll\n      \u251c\u2500\u2500 InjectRules\n      \u2514\u2500\u2500 manifest.json\n")),(0,i.kt)("p",null,"After generation, the ",(0,i.kt)("inlineCode",{parentName:"p"},"MetaVersions")," directory and ",(0,i.kt)("inlineCode",{parentName:"p"},"signature-mapper.json")," file are added. The final directory structure is as follows:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-txt"},"  Snapshots\n  \u251c\u2500\u2500 PrevAotSnapshotDir\n      \u251c\u2500\u2500 *.dll\n      \u251c\u2500\u2500 InjectRules\n      \u251c\u2500\u2500 MetaVersions\n        \u251c\u2500\u2500 *.mv.bytes\n        \u251c\u2500\u2500 *.mv.spec\n        \u251c\u2500\u2500 *.mv.diff.spec\n      \u251c\u2500\u2500 signature-mapper.json\n      \u2514\u2500\u2500 manifest.json\n  \u251c\u2500\u2500 CurrentAotSnapshotDir\n      \u251c\u2500\u2500 *.dll\n      \u251c\u2500\u2500 InjectRules\n      \u251c\u2500\u2500 MetaVersions (New)\n        \u251c\u2500\u2500 *.mv.bytes\n        \u251c\u2500\u2500 *.mv.spec\n        \u251c\u2500\u2500 *.mv.diff.spec\n      \u251c\u2500\u2500 signature-mapper.json (New)\n      \u2514\u2500\u2500 manifest.json\n")),(0,i.kt)("h3",{id:"including-aot-snapshot-meta-version-files-in-the-main-package-optional-but-highly-recommended"},"Including AOT Snapshot Meta Version Files in the Main Package (Optional but Highly Recommended)"),(0,i.kt)("p",null,"The parameter ",(0,i.kt)("inlineCode",{parentName:"p"},"originalMetaVersionFileBytes")," in ",(0,i.kt)("inlineCode",{parentName:"p"},"RuntimeApi::LoadDifferentialHybridAssemblyWithMetaVersion")," is the content of the meta version file corresponding to the DHE assembly in the AOT snapshot. This meta version file is different for each main package and is fully determined during the main package build. It is small in size and highly recommended to be included with the main package."),(0,i.kt)("h3",{id:"multi-platform-considerations"},"Multi-Platform Considerations"),(0,i.kt)("p",null,"Most games are released on multiple platforms. Since there are significant differences in the main package AOT DLLs between platforms, we ",(0,i.kt)("strong",{parentName:"p"},"strongly recommend")," maintaining separate AotSnapshot trees for each platform. The directory structure should be similar to the following:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-txt"},"  Snapshots\n  \u251c\u2500\u2500 PreAotSnapshotDir-StandaloneWindows64\n  \u251c\u2500\u2500 CurrentAotSnapshotDir-StandaloneWindows64\n  \u251c\u2500\u2500 PreAotSnapshotDir-Android64\n  \u251c\u2500\u2500 CurrentAotSnapshotDir-Android64\n  \u251c\u2500\u2500 PreAotSnapshotDir-iOS\n  \u251c\u2500\u2500 CurrentAotSnapshotDir-iOS\n")),(0,i.kt)("p",null,"For example, when calculating the meta version for a newly released Win64 main package, use the snapshot directory of the previously released Win64 main package and the new main package's snapshot to compute the meta version for the new main package."),(0,i.kt)("h3",{id:"version-control-for-snapshots"},"Version Control for Snapshots"),(0,i.kt)("p",null,"The directory structure mentioned in the previous section is not convenient for version control. A more suitable directory structure for version control is as follows:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-txt"},"  Snapshots\n  \u251c\u2500\u2500 AotSnapshotDir-StandaloneWindows64\n  \u251c\u2500\u2500 AotSnapshotDir-Android64\n  \u251c\u2500\u2500 AotSnapshotDir-iOS\n")),(0,i.kt)("p",null,"The snapshot update process is as follows:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Create a ",(0,i.kt)("inlineCode",{parentName:"li"},"CurrentAotSnapshotDir-{buildTarget}")," directory for the latest main package."),(0,i.kt)("li",{parentName:"ol"},"Compare ",(0,i.kt)("inlineCode",{parentName:"li"},"CurrentAotSnapshotDir-{buildTarget}")," with ",(0,i.kt)("inlineCode",{parentName:"li"},"AotSnapshotDir-{buildTarget}")," to generate the meta version files for ",(0,i.kt)("inlineCode",{parentName:"li"},"CurrentAotSnapshotDir-{buildTarget}"),"."),(0,i.kt)("li",{parentName:"ol"},"Replace ",(0,i.kt)("inlineCode",{parentName:"li"},"AotSnapshotDir-{buildTarget}")," with ",(0,i.kt)("inlineCode",{parentName:"li"},"CurrentAotSnapshotDir-{buildTarget}"),"."),(0,i.kt)("li",{parentName:"ol"},"Commit ",(0,i.kt)("inlineCode",{parentName:"li"},"AotSnapshotDir-{buildTarget}")," to the repository.")),(0,i.kt)("h2",{id:"publishing-hot-updates"},"Publishing Hot Updates"),(0,i.kt)("p",null,"The flagship version is a superset of the professional and community versions, supporting both pure interpreted assemblies and DHE assemblies, which can coexist. Since DHE assemblies are compiled into AOT, they cannot depend on ordinary pure interpreted hot update assemblies; otherwise, the main package build will fail due to compilation errors. However, ordinary hot update assemblies can depend on DHE assemblies, and DHE assemblies can also depend on each other."),(0,i.kt)("p",null,"The configuration and publishing process for ordinary hot update assemblies is identical to that of the community version and will not be repeated here. Only the hot update process for DHE assemblies is described below."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Use ",(0,i.kt)("inlineCode",{parentName:"li"},"HybridCLR/CompileDll/ActivedBuildTarget")," to generate hot update DLLs."),(0,i.kt)("li",{parentName:"ul"},"Generate meta version files for the hot update assemblies."),(0,i.kt)("li",{parentName:"ul"},"Add the latest hot update DLLs and meta version files to the hot update resource management system.")),(0,i.kt)("h3",{id:"generating-meta-version-files-for-hot-update-assemblies"},"Generating Meta Version Files for Hot Update Assemblies"),(0,i.kt)("p",null,"Call ",(0,i.kt)("inlineCode",{parentName:"p"},"MetaVersionWorkflow.GenerateHotUpdateMetaVersionFiles(string aotSnapshotDir, string hotUpdateSnapshotDir)")," to generate meta version files for the hot update assemblies."),(0,i.kt)("p",null,"Here, ",(0,i.kt)("inlineCode",{parentName:"p"},"aotSnapshotDir")," is the latest ",(0,i.kt)("inlineCode",{parentName:"p"},"AotSnapshot-{buildTarget}")," directory, and ",(0,i.kt)("inlineCode",{parentName:"p"},"hotUpdateSnapshotDir")," is the directory containing the latest hot update assemblies."),(0,i.kt)("p",null,"After calling this function, meta version files for the DHE assemblies will be generated in the ",(0,i.kt)("inlineCode",{parentName:"p"},"{hotUpdateSnapshotDir}/MetaVersions")," directory. The directory structure is similar to the following:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-txt"},"  HotUpdateSnapshot\n  \u251c\u2500\u2500 *.dll\n  \u251c\u2500\u2500 MetaVersions\n    \u251c\u2500\u2500 *.mv.bytes\n    \u251c\u2500\u2500 *.mv.spec\n    \u251c\u2500\u2500 *.mv.diff.spec\n")),(0,i.kt)("p",null,"Example code:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-csharp"},"        public static void GenerateHotUpdateMetaVersionFiles(BuildTarget target)\n        {\n            var latestSnapshotSolutionDir = GetAOTAssemblySnapshotDir(target);\n            var newHotUpdateSolutionDir = SettingsUtil.GetHotUpdateDllsOutputDirByTarget(target);\n            MetaVersionWorkflow.GenerateHotUpdateMetaVersionFiles(latestSnapshotSolutionDir, newHotUpdateSolutionDir);\n        }\n")),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"*.mv.spec")," file is a human-readable version of ",(0,i.kt)("inlineCode",{parentName:"p"},"*.mv.bytes"),", while the ",(0,i.kt)("inlineCode",{parentName:"p"},"*.mv.diff.spec")," file records the metadata changes in ",(0,i.kt)("inlineCode",{parentName:"p"},"*.mv.spec"),". These two types of files are only used for debugging and are not needed during runtime. It is recommended to add them to the repository but not to the hot update resources, as they serve no purpose there."),(0,i.kt)("h2",{id:"other-considerations"},"Other Considerations"),(0,i.kt)("h3",{id:"usereditorsettingsdevelopment-option"},"UserEditorSettings.development Option"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"development")," option used when publishing the main package must be consistent with that used when publishing hot updates. In other words, the ",(0,i.kt)("inlineCode",{parentName:"p"},"development")," option must be the same when creating the AotSnapshot and compiling the hot update DLLs. This is because the ",(0,i.kt)("inlineCode",{parentName:"p"},"development")," option significantly affects the final compiled DLLs. Inconsistent ",(0,i.kt)("inlineCode",{parentName:"p"},"development")," parameters will lead to significant changes in the meta version!"),(0,i.kt)("h3",{id:"changes-in-hybridclrsettingsdifferentialhybridassemblies-list"},"Changes in HybridCLRSettings.differentialHybridAssemblies List"),(0,i.kt)("p",null,"The function ",(0,i.kt)("inlineCode",{parentName:"p"},"MetaVersionWorkflow.GenerateAotSnapshotMetaVersionFiles(string prevSnapshotDir, string curSnapshotDir)")," requires that the DHE assembly lists in the ",(0,i.kt)("inlineCode",{parentName:"p"},"prevSnapshotDir")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"curSnapshotDir")," snapshots be identical."),(0,i.kt)("p",null,"If a new DHE assembly is added or an existing one is removed from a certain main package onwards, the meta version generation will fail. The solution is to create a new version tree for the AotSnapshot starting from this main package, such as ",(0,i.kt)("inlineCode",{parentName:"p"},"AotSnapshot-{buildTarget}-v2"),"."))}u.isMDXComponent=!0}}]);