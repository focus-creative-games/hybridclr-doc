"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[2241],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>y});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),u=c(n),m=r,y=u["".concat(l,".").concat(m)]||u[m]||d[m]||o;return n?a.createElement(y,s(s({ref:t},p),{},{components:n})):a.createElement(y,s({ref:t},p))}));function y(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,s=new Array(o);s[0]=m;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[u]="string"==typeof e?e:r,s[1]=i;for(var c=2;c<o;c++)s[c]=n[c];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},91495:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>d,frontMatter:()=>o,metadata:()=>i,toc:()=>c});var a=n(87462),r=(n(67294),n(3905));const o={},s="Loading and Running",i={unversionedId:"basic/runhotupdatecodes",id:"basic/runhotupdatecodes",title:"Loading and Running",description:"Loading Update Assemblies",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/basic/runhotupdatecodes.md",sourceDirName:"basic",slug:"/basic/runhotupdatecodes",permalink:"/en/docs/basic/runhotupdatecodes",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Assembly Configuration",permalink:"/en/docs/basic/hotupdateassemblysetting"},next:{title:"Build Workflow",permalink:"/en/docs/basic/buildpipeline"}},l={},c=[{value:"Loading Update Assemblies",id:"loading-update-assemblies",level:2},{value:"Running Hot Update Functions Directly Through Reflection",id:"running-hot-update-functions-directly-through-reflection",level:2},{value:"Running After Creating Delegate Through Reflection",id:"running-after-creating-delegate-through-reflection",level:2},{value:"Creating Objects Through Reflection, Then Calling Interface Functions",id:"creating-objects-through-reflection-then-calling-interface-functions",level:2},{value:"Running Script Code Through Dynamic AddComponent",id:"running-script-code-through-dynamic-addcomponent",level:2},{value:"Restoring Hot Update Scripts Mounted to Prefabs or Scenes Packaged as AssetBundles Through Initialization",id:"restoring-hot-update-scripts-mounted-to-prefabs-or-scenes-packaged-as-assetbundles-through-initialization",level:2}],p={toc:c},u="wrapper";function d(e){let{components:t,...n}=e;return(0,r.kt)(u,(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"loading-and-running"},"Loading and Running"),(0,r.kt)("h2",{id:"loading-update-assemblies"},"Loading Update Assemblies"),(0,r.kt)("p",null,"Obtain the hot update DLL bytes data according to your project's asset management approach. Then directly call ",(0,r.kt)("inlineCode",{parentName:"p"},"Assembly.Load(byte[] assemblyData)"),". ",(0,r.kt)("strong",{parentName:"p"},"Starting from v6.4.0, loading PDB symbol files is supported"),", meaning you can call ",(0,r.kt)("inlineCode",{parentName:"p"},"Assembly.Load(byte[] assemblyData, byte[] pdbSymbolData)")," to load both assembly and debug symbols simultaneously."),(0,r.kt)("p",null,"When executing ",(0,r.kt)("inlineCode",{parentName:"p"},"Assembly.Load"),", both assemblyData and pdbSymbolData are internally copied. Please don't save assemblyData and pdbSymbolData after calling, as it will cause memory waste."),(0,r.kt)("p",null,"Code example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"    // Get hot update dll data from your asset management system\n    byte[] assemblyData = xxxx; \n\n    // Assembly.Load automatically copies assemblyData internally, you can release assemblyData after calling this function, no need to save it.\n    Assembly ass = Assembly.Load(assemblyData);\n\n    // Load both dll and pdb files simultaneously\n    byte[] assData2 = yyy;\n    byte[] pdbData2 = zzz;\n    Assembly ass2 = Assembly.Load(assData2, pdbData2);\n")),(0,r.kt)("p",null,"If you have multiple hot update DLLs, make sure to ",(0,r.kt)("strong",{parentName:"p"},"load them in dependency order"),", loading dependent assemblies first. After loading hot update DLLs, there are multiple ways to run hot update code, and these techniques are exactly the same as when not considering hot updates."),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"If Assembly.Load takes too much time and causes stuttering, you can load asynchronously in other threads.")),(0,r.kt)("h2",{id:"running-hot-update-functions-directly-through-reflection"},"Running Hot Update Functions Directly Through Reflection"),(0,r.kt)("p",null,"Assuming there's a HotUpdateEntry class in the hot update assembly with a static Main function as the main entry point, code like:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},'class HotUpdateEntry\n{\n    public static void Main()\n    {\n        UnityEngine.Debug.Log("hello, HybridCLR");\n    }\n}\n')),(0,r.kt)("p",null,"You can run it as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},'    // ass is the hot update assembly returned by Assembly.Load.\n    // You can also find it after Assembly.Load with code like:\n    // Assembly ass = AppDomain.CurrentDomain.GetAssemblies().First(assembly => assembly.GetName().Name == "Your-HotUpdate-Assembly");\n    Type entryType = ass.GetType("HotUpdateEntry");\n    MethodInfo method = entryType.GetMethod("Main");\n    method.Invoke(null, null);\n')),(0,r.kt)("h2",{id:"running-after-creating-delegate-through-reflection"},"Running After Creating Delegate Through Reflection"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},'    Type entryType = ass.GetType("HotUpdateEntry");\n    MethodInfo method = entryType.GetMethod("Main");\n    Action mainFunc = (Action)Delegate.CreateDelegate(typeof(Action), method);\n    mainFunc();\n')),(0,r.kt)("h2",{id:"creating-objects-through-reflection-then-calling-interface-functions"},"Creating Objects Through Reflection, Then Calling Interface Functions"),(0,r.kt)("p",null,"Assuming there's an interface in AOT like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"public interface IEntry\n{\n    void Start();\n}\n")),(0,r.kt)("p",null,"A class implemented in hot update like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},'class HotUpdateEntry : IEntry\n{\n    public void Start()\n    {\n        UnityEngine.Debug.Log("hello, HybridCLR");\n    }\n}\n')),(0,r.kt)("p",null,"You can run it as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},'    Type entryType = ass.GetType("HotUpdateEntry");\n    IEntry entry = (IEntry)Activator.CreateInstance(entryType);\n    entry.Start();\n')),(0,r.kt)("h2",{id:"running-script-code-through-dynamic-addcomponent"},"Running Script Code Through Dynamic AddComponent"),(0,r.kt)("p",null,"Assuming there's code like this in hot update:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"class Rotate : MonoBehaviour\n{\n    void Update()\n    {\n\n    }\n}\n")),(0,r.kt)("p",null,"You run the following code in AOT:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},'    Type type = ass.GetType("Rotate");\n    GameObject go = new GameObject("Test");\n    go.AddComponent(type);\n')),(0,r.kt)("h2",{id:"restoring-hot-update-scripts-mounted-to-prefabs-or-scenes-packaged-as-assetbundles-through-initialization"},"Restoring Hot Update Scripts Mounted to Prefabs or Scenes Packaged as AssetBundles Through Initialization"),(0,r.kt)("p",null,"Assuming there's an entry script like this in hot update, which is mounted to ",(0,r.kt)("inlineCode",{parentName:"p"},"HotUpdatePrefab.prefab"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},'\npublic class HotUpdateMain : MonoBehaviour\n{\n    void Start()\n    {\n        Debug.Log("hello, HybridCLR");\n    }\n}\n\n')),(0,r.kt)("p",null,"You can run hot update logic by instantiating this prefab."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},'        AssetBundle prefabAb = xxxxx; // Get the AssetBundle containing HotUpdatePrefab.prefab\n        GameObject testPrefab = Instantiate(prefabAb.LoadAsset<GameObject>("HotUpdatePrefab.prefab"));\n')),(0,r.kt)("p",null,"This method doesn't require any reflection and follows the same startup flow as native, so it's recommended to use this approach to initialize hot update entry code!"))}d.isMDXComponent=!0}}]);