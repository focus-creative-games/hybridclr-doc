"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[5672],{3905:(t,e,n)=>{n.d(e,{Zo:()=>d,kt:()=>g});var a=n(67294);function r(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function l(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,a)}return n}function i(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?l(Object(n),!0).forEach((function(e){r(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function o(t,e){if(null==t)return{};var n,a,r=function(t,e){if(null==t)return{};var n,a,r={},l=Object.keys(t);for(a=0;a<l.length;a++)n=l[a],e.indexOf(n)>=0||(r[n]=t[n]);return r}(t,e);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(t);for(a=0;a<l.length;a++)n=l[a],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(r[n]=t[n])}return r}var s=a.createContext({}),p=function(t){var e=a.useContext(s),n=e;return t&&(n="function"==typeof t?t(e):i(i({},e),t)),n},d=function(t){var e=p(t.components);return a.createElement(s.Provider,{value:e},t.children)},u="mdxType",m={inlineCode:"code",wrapper:function(t){var e=t.children;return a.createElement(a.Fragment,{},e)}},c=a.forwardRef((function(t,e){var n=t.components,r=t.mdxType,l=t.originalType,s=t.parentName,d=o(t,["components","mdxType","originalType","parentName"]),u=p(n),c=r,g=u["".concat(s,".").concat(c)]||u[c]||m[c]||l;return n?a.createElement(g,i(i({ref:e},d),{},{components:n})):a.createElement(g,i({ref:e},d))}));function g(t,e){var n=arguments,r=e&&e.mdxType;if("string"==typeof t||r){var l=n.length,i=new Array(l);i[0]=c;var o={};for(var s in e)hasOwnProperty.call(e,s)&&(o[s]=e[s]);o.originalType=t,o[u]="string"==typeof t?t:r,i[1]=o;for(var p=2;p<l;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},36418:(t,e,n)=>{n.r(e),n.d(e,{assets:()=>s,contentTitle:()=>i,default:()=>m,frontMatter:()=>l,metadata:()=>o,toc:()=>p});var a=n(87462),r=(n(67294),n(3905));const l={},i="DOTS Support",o={unversionedId:"basic/dots",id:"basic/dots",title:"DOTS Support",description:"The initialization timing of TypeManager in DOTS is too early, and it does not support dynamically registering Component and System types. To ensure the normal operation of the hot update module in the DOTS system, modifications need to be made to the DOTS source code to adjust the initialization timing of the World.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/basic/dots.md",sourceDirName:"basic",slug:"/basic/dots",permalink:"/en/docs/basic/dots",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Method Bridge",permalink:"/en/docs/basic/methodbridge"},next:{title:"Memory and GC",permalink:"/en/docs/basic/memory"}},s={},p=[{value:"Supported Versions",id:"supported-versions",level:2},{value:"Supported Features",id:"supported-features",level:2},{value:"Version 1.0.16",id:"version-1016",level:3},{value:"Version 0.51.1-preview.21",id:"version-0511-preview21",level:3},{value:"Installation",id:"installation",level:2},{value:"Installing com.unity.entities",id:"installing-comunityentities",level:3},{value:"Modify Project Settings",id:"modify-project-settings",level:3},{value:"Initialization",id:"initialization",level:3},{value:"Resolve ReversePInvokeCallback Issues",id:"resolve-reversepinvokecallback-issues",level:2},{value:"Burst Related",id:"burst-related",level:2}],d={toc:p},u="wrapper";function m(t){let{components:e,...n}=t;return(0,r.kt)(u,(0,a.Z)({},d,n,{components:e,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"dots-support"},"DOTS Support"),(0,r.kt)("p",null,"The initialization timing of TypeManager in DOTS is too early, and it does not support dynamically registering Component and System types. To ensure the normal operation of the hot update module in the DOTS system, modifications need to be made to the DOTS source code to adjust the initialization timing of the World."),(0,r.kt)("h2",{id:"supported-versions"},"Supported Versions"),(0,r.kt)("p",null,"Due to the rapid iteration and modification of DOTS, in order to reduce maintenance costs, only the following versions of com.unity.entities are maintained:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"0.51.1-preview.21"),(0,r.kt)("li",{parentName:"ul"},"1.0.16")),(0,r.kt)("p",null,"Currently, compatibility testing has only been completed on Unity 2021+ versions, and compatibility with Unity 2020 and lower versions has not been tested. Generally, as long as the corresponding version of com.unity.entities can run normally on that Unity version, hybridclr support should also be available."),(0,r.kt)("p",null,"Developers with special requirements for DOTS versions need to contact us for separate customized payment due to the higher maintenance cost of maintaining separate DOTS versions."),(0,r.kt)("h2",{id:"supported-features"},"Supported Features"),(0,r.kt)("p",null,"Currently, most DOTS features can run normally under hybridclr, except for features related to BurstCompile and resource serialization."),(0,r.kt)("h3",{id:"version-1016"},"Version 1.0.16"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Feature"),(0,r.kt)("th",{parentName:"tr",align:null},"Community Version"),(0,r.kt)("th",{parentName:"tr",align:null},"Professional Version"),(0,r.kt)("th",{parentName:"tr",align:null},"Enterprise Version"),(0,r.kt)("th",{parentName:"tr",align:null},"Hot Reload Version"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Jobs"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Managed Component"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Unmanaged Component"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Managed System"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Unmanaged System"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Aspect"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"IJobEntity"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"BurstCompile"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"SubScene"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})))),(0,r.kt)("h3",{id:"version-0511-preview21"},"Version 0.51.1-preview.21"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Feature"),(0,r.kt)("th",{parentName:"tr",align:null},"Community Version"),(0,r.kt)("th",{parentName:"tr",align:null},"Professional Version"),(0,r.kt)("th",{parentName:"tr",align:null},"Enterprise Version"),(0,r.kt)("th",{parentName:"tr",align:null},"Hot Reload Version"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Jobs"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Managed Component"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Unmanaged Component"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Managed System"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Unmanaged System"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"IJobEntity"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"BurstCompile"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"SubScene"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})))),(0,r.kt)("h2",{id:"installation"},"Installation"),(0,r.kt)("h3",{id:"installing-comunityentities"},"Installing com.unity.entities"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Remove the com.unity.entities package from the project, exit the Unity Editor, and clear the directory corresponding to the package under ",(0,r.kt)("inlineCode",{parentName:"li"},"Library\\PackageCache"),"."),(0,r.kt)("li",{parentName:"ul"},"Download the ",(0,r.kt)("a",{parentName:"li",href:"https://code-philosophy.feishu.cn/file/NH0cbaeneozfd8xdbvmcLNvfn2d"},"modified com.unity.entities")," according to the version used by the project, and unzip the ",(0,r.kt)("inlineCode",{parentName:"li"},"com.unity.entities.7z")," in the corresponding directory to the Packages directory. Make sure that the directory name after decompression is com.unity.entities.")),(0,r.kt)("p",null,"When reopening the Unity Editor, you may be prompted to perform API upgrades. Decide whether to upgrade according to the project situation."),(0,r.kt)("h3",{id:"modify-project-settings"},"Modify Project Settings"),(0,r.kt)("p",null,"To avoid potential issues caused by dynamically registering Component or System during DOTS runtime, adjust the initialization timing of World to ensure that all hot update types are registered before running all Worlds."),(0,r.kt)("p",null,"Add the compilation macro ",(0,r.kt)("inlineCode",{parentName:"p"},"UNITY_DISABLE_AUTOMATIC_SYSTEM_BOOTSTRAP_RUNTIME_WORLD")," in ",(0,r.kt)("inlineCode",{parentName:"p"},"Player Settings")," under ",(0,r.kt)("inlineCode",{parentName:"p"},"Scripting Define Symbols"),". For detailed instructions, refer to the World's ",(0,r.kt)("a",{parentName:"p",href:"https://docs.unity3d.com/Packages/com.unity.entities@0.51/manual/world.html"},"custom initialization documentation"),"."),(0,r.kt)("h3",{id:"initialization"},"Initialization"),(0,r.kt)("p",null,"To avoid encountering issues, perform initialization ",(0,r.kt)("strong",{parentName:"p"},"after loading the hot update code and before running any dots code"),"."),(0,r.kt)("p",null,"Initialization mainly consists of two parts:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Register hot update dots types."),(0,r.kt)("li",{parentName:"ul"},"Initialize World.")),(0,r.kt)("p",null,"There are slight differences in the initialization implementations of different versions of com.unity.entities."),(0,r.kt)("p",null,"For version 0.51.1, the initialization code is as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},'    private static void InitializeWorld()\n    {\n#if !UNITY_EDITOR\n        var dotsAssemblies = new Assembly[] { ... };\n        var componentTypes = new HashSet<System.Type>();\n        TypeManager.CollectComponentTypes(dotsAssemblies, componentTypes);\n        TypeManager.AddNewComponentTypes(componentTypes.ToArray());\n        TypeManager.EarlyInitAssemblies(dotsAssemblies);\n#endif\n\n\n        DefaultWorldInitialization.Initialize("Default World", false);\n\n    }\n')),(0,r.kt)("p",null,"For version 1.0.16, the initialization code is as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},'    private static void InitializeWorld()\n    {\n#if !UNITY_EDITOR\n        var dotsAssemblies = new Assembly[] { ... };\n        var componentTypes = new HashSet<Type>();\n        TypeManager.CollectComponentTypes(dotsAssemblies, componentTypes);\n        TypeManager.AddComponentTypes(dotsAssemblies, componentTypes);\n        TypeManager.RegisterSystemTypes(dotsAssemblies);\n        TypeManager.InitializeSharedStatics();\n        TypeManager.EarlyInitAssemblies(dotsAssemblies);\n#endif\n\n\n        DefaultWorldInitialization.Initialize("Default World", false);\n    }\n')),(0,r.kt)("h2",{id:"resolve-reversepinvokecallback-issues"},"Resolve ReversePInvokeCallback Issues"),(0,r.kt)("p",null,"When initializing Unmanaged Systems, the DOTS system will attempt to obtain the Marshal pointer of its OnStart-like functions. hybridclr needs to bind a runtime-unique cpp function pointer for each of these functions, otherwise the error GetReversePInvokeWrapper fail. exceed max wrapper num of method will occur during runtime. For detailed instructions, refer to the HybridCLR+lua/js/python documentation."),(0,r.kt)("p",null,"In simple terms, a sufficient number of SystemBaseRegistry.ForwardingFunc corresponding wrapper functions need to be reserved. Add the following code to the hot update module (or DHE assembly, but not in AOT assemblies):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"\npublic static class PreserveDOTSReversePInvokeWrapper\n{\n    [ReversePInvokeWrapperGeneration(100)]\n    [MonoPInvokeCallback(typeof(SystemBaseRegistry.ForwardingFunc))]\n    public static void ForwordMethod(IntPtr system, IntPtr state)\n    {\n\n    }\n}\n\n\n")),(0,r.kt)("p",null,"Change the number 100 in the code to an appropriate number, recommended to be 5-10 times the number of Unmanaged System types."),(0,r.kt)("h2",{id:"burst-related"},"Burst Related"),(0,r.kt)("p",null,"Hot update functions containing ","[BurstCompile]"," have changed, remove the ","[BurstCompile]"," attribute, otherwise errors will occur during runtime. This issue may be optimized in the future."))}m.isMDXComponent=!0}}]);