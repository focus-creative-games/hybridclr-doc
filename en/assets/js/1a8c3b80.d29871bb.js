"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[9892],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var r=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=r.createContext({}),c=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},p=function(e){var t=c(e.components);return r.createElement(l.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},h=r.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=c(n),h=i,m=d["".concat(l,".").concat(h)]||d[h]||u[h]||o;return n?r.createElement(m,a(a({ref:t},p),{},{components:n})):r.createElement(m,a({ref:t},p))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,a=new Array(o);a[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[d]="string"==typeof e?e:i,a[1]=s;for(var c=2;c<o;c++)a[c]=n[c];return r.createElement.apply(null,a)}return r.createElement.apply(null,n)}h.displayName="MDXCreateElement"},4893:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>c});var r=n(7462),i=(n(7294),n(3905));const o={},a="Code Stripping",s={unversionedId:"basic/codestriping",id:"basic/codestriping",title:"Code Stripping",description:"Unity uses Code Stripping technology to help reduce the package size of the il2cpp backend. If anti-cutting processing is not performed, since there are generally not many codes in the AOT main project, a large number of C# types and functions are",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/basic/codestriping.md",sourceDirName:"basic",slug:"/basic/codestriping",permalink:"/en/docs/basic/codestriping",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Publish the WebGL platform",permalink:"/en/docs/basic/buildwebgl"},next:{title:"MonoBehaviour Support",permalink:"/en/docs/basic/monobehaviour"}},l={},c=[{value:"Solution",id:"solution",level:2},{value:"AOT type and function reserved",id:"aot-type-and-function-reserved",level:2},{value:"Check whether the pruned type or function is referenced in the hot update code",id:"check-whether-the-pruned-type-or-function-is-referenced-in-the-hot-update-code",level:2}],p={toc:c},d="wrapper";function u(e){let{components:t,...n}=e;return(0,i.kt)(d,(0,r.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"code-stripping"},"Code Stripping"),(0,i.kt)("p",null,"Unity uses ",(0,i.kt)("a",{parentName:"p",href:"https://docs.unity3d.com/Manual/ManagedCodeStripping.html"},"Code Stripping")," technology to help reduce the package size of the il2cpp backend. If anti-cutting processing is not performed, since there are generally not many codes in the AOT main project, a large number of C# types and functions are\nClipping, resulting in the following exceptions when calling these clipped classes or functions during hot update:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-txt"},"     // missing type error\n     Unity: TypeLoadException: Could not load type 'Xxx' from assembly 'yyy'\n\n     // missing function error\n     MissingMethodException: xxxx\n")),(0,i.kt)("h2",{id:"solution"},"Solution"),(0,i.kt)("p",null,"Determine which type or function is cut according to the log error log, keep this type or function in link.xml, or explicitly add calls to these classes or functions in the main project."),(0,i.kt)("p",null,"If you are not familiar with how to preserve this type or function in link.xml, please refer to ",(0,i.kt)("a",{parentName:"p",href:"https://docs.unity3d.com/Manual/ManagedCodeStripping.html"},"Code Stripping"),"."),(0,i.kt)("p",null,'But this method is very troublesome after all. There are a lot of cut types in the actual project, and you perform the operation of "package-type missing-supplement-package" over and over again,\nToo much time wasted. ',(0,i.kt)("inlineCode",{parentName:"p"},"com.code-philosophy.hybridclr")," package provides a convenient menu command ",(0,i.kt)("inlineCode",{parentName:"p"},"HybridCLR/Generate/LinkXml"),",\nAll AOT types and function references in the hot update project can be generated with one click."),(0,i.kt)("p",null,"Note that if you don't have any code referencing an assembly in your main project, even if it is kept in ",(0,i.kt)("inlineCode",{parentName:"p"},"link.xml"),", the assembly will be completely trimmed. So for each AOT assembly to keep,\nMake sure to explicitly reference one of its classes or functions in the main project code."),(0,i.kt)("h2",{id:"aot-type-and-function-reserved"},"AOT type and function reserved"),(0,i.kt)("p",null,"Although the ",(0,i.kt)("inlineCode",{parentName:"p"},"HybridCLR/Generate/LinkXml")," command of com.code-philosophy.hybridclr can intelligently scan out the AOT type you are currently referencing, it cannot predict the AOT type you will use in the future\ntype. Therefore, you still need to plan ahead in ",(0,i.kt)("inlineCode",{parentName:"p"},"Assets/link.xml")," (note! Not the automatically generated link.xml) to reserve your future\ntypes that may be used. Remember not to miss it, so as to avoid the embarrassing situation that the type used in a certain update is cut after it goes online!"),(0,i.kt)("h2",{id:"check-whether-the-pruned-type-or-function-is-referenced-in-the-hot-update-code"},"Check whether the pruned type or function is referenced in the hot update code"),(0,i.kt)("p",null,"As long as ",(0,i.kt)("inlineCode",{parentName:"p"},"HybridCLR/Generate/All")," is executed correctly when building the game, running the hot update code at that time will not cause problems with missing types or functions. But as the subsequent hot update code continues to iterate,\nIt is possible that a clipped type or function was accessed. If you can check it in advance when hot update code is released, problems can be discovered and solved early."),(0,i.kt)("p",null,"Since version v5.0.0, the ",(0,i.kt)("inlineCode",{parentName:"p"},"HybridCLR.Editor.HotUpdate.MissingMetadataChecker")," class is provided to check whether clipped types and functions are accessed. The sample code is as follows:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-csharp"},'         public static void CheckAccessMissingMetadata()\n         {\n             BuildTarget target = EditorUserBuildSettings.activeBuildTarget;\n             // aotDir is the stripped aot dll directory generated when building the main package, not the latest SettingsUtil.GetAssembliesPostIl2CppStripDir(target) directory.\n             // Generally speaking, when releasing a hot update package, since generate/all may have been called in the middle, the SettingsUtil.GetAssembliesPostIl2CppStripDir(target) directory contains the latest aot dll.\n             // Definitely cannot check for type or function pruning issues.\n             // After building the main package, you need to save the aot dll at that time for later supplementary metadata or cropping inspection.\n             string aotDir = "xxxx";\n            \n             // The second parameter excludeDllNames is the aot dll to be excluded. Generally, an empty list will suffice. For ultimate edition users,\n             // excludeDllNames needs to be the dhe assembly list, because the dhe assembly will be hot updated, and the hot update code\n             // The type or function in the referenced dhe assembly must exist.\n             var checker = new MissingMetadataChecker(aotDir, new List<string>());\n\n             string hotUpdateDir = SettingsUtil.GetHotUpdateDllsOutputDirByTarget(target);\n             foreach (var dll in SettingsUtil.HotUpdateAssemblyFilesExcludePreserved)\n             {\n                 string dllPath = $"{hotUpdateDir}/{dll}";\n                 checker.Check(dllPath);\n             }\n         }\n\n')))}u.isMDXComponent=!0}}]);