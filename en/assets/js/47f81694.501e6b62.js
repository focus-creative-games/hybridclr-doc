"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[483],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>m});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},d=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},u="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),u=c(n),h=r,m=u["".concat(s,".").concat(h)]||u[h]||p[h]||i;return n?a.createElement(m,l(l({ref:t},d),{},{components:n})):a.createElement(m,l({ref:t},d))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,l=new Array(i);l[0]=h;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o[u]="string"==typeof e?e:r,l[1]=o;for(var c=2;c<i;c++)l[c]=n[c];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},4765:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>p,frontMatter:()=>i,metadata:()=>o,toc:()=>c});var a=n(87462),r=(n(67294),n(3905));const i={},l="DHAO Files",o={unversionedId:"business/ultimate/dhao",id:"business/ultimate/dhao",title:"DHAO Files",description:"DHAO files are the core concept of DHE technology. DHAO files contain pre-calculated information about changed types and functions in the latest hot update dll. At runtime, the system directly determines whether to use the latest interpreted version or call the original AOT function when executing a hot update function based on the information in the DHAO file.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/business/ultimate/dhao.md",sourceDirName:"business/ultimate",slug:"/business/ultimate/dhao",permalink:"/en/docs/business/ultimate/dhao",draft:!1,tags:[],version:"current",frontMatter:{}},s={},c=[{value:"Marking Changed Function Information",id:"marking-changed-function-information",level:2},{value:"Merging DHAO Files",id:"merging-dhao-files",level:2},{value:"Precautions",id:"precautions",level:2},{value:"External dlls cause massive differences in DHAO calculation results",id:"external-dlls-cause-massive-differences-in-dhao-calculation-results",level:3}],d={toc:c},u="wrapper";function p(e){let{components:t,...n}=e;return(0,r.kt)(u,(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"dhao-files"},"DHAO Files"),(0,r.kt)("p",null,"DHAO files are the core concept of DHE technology. DHAO files contain pre-calculated information about changed types and functions in the latest hot update dll. At runtime, the system directly determines whether to use the latest interpreted version or call the original AOT function when executing a hot update function based on the information in the DHAO file.\nPre-calculated DHAO files are extremely critical for DHE technology. Without DHAO files, the original AOT dll would need to be carried additionally, and the cost of calculating function changes would be extremely high."),(0,r.kt)("p",null,"By comparing the latest hot update dll with the AOT dll generated during packaging, changed types and functions are calculated offline and saved as DHAO files. Therefore, for the DHE mechanism to work properly, it must rely on the correctness of DHAO files, and the correctness of DHAO files depends on accurately providing the latest hot update dll and the AOT dll generated during packaging."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"HybridCLR.Editor.DHE.BuildUtils")," provides multiple functions related to generating DHAO files."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Function Name"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"GenerateDHAODatas"),(0,r.kt)("td",{parentName:"tr",align:null},"Generate DHAO files for hot update packages (when code changes occur)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"EncryptDllAndGenerateDHAODatas"),(0,r.kt)("td",{parentName:"tr",align:null},"When basic code protection is enabled, generate encrypted dlls and DHAO files for hot update packages (when code changes occur)")))),(0,r.kt)("h2",{id:"marking-changed-function-information"},"Marking Changed Function Information"),(0,r.kt)("p",null,"Currently, it's possible to automatically calculate changed functions by comparing the latest hot update dll with the AOT dll generated during packaging. Manual operation is not required in most cases. However, there is no perfect code that can determine logical equivalence.\nThe tool simply compares IL one by one to determine equivalence. Sometimes functions may be equivalent but IL changes (such as swapping the order of two unrelated lines of code), which will be determined as function changes and switch to interpreted execution.\nIf this situation occurs, ",(0,r.kt)("strong",{parentName:"p"},"and there are extremely strict performance requirements for that function"),", developers can manually use the UnchangedAttribute to mark the function's change status.\n",(0,r.kt)("inlineCode",{parentName:"p"},"[Unchanged]")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"[Unchanged(true)]")," indicate no change, ",(0,r.kt)("inlineCode",{parentName:"p"},"[Unchanged(false)]")," indicates change, and unmarked attributes are automatically calculated by the tool."),(0,r.kt)("p",null,"Incorrectly marking unchanged functions as changed will not affect runtime correctness, only performance. Even if all hot update functions are marked as changed, it can still run normally. But incorrectly marking changed functions as unchanged will not only cause runtime logic errors,\nbut may also cause crashes in severe cases!"),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"Unless special circumstances and you are an experienced expert, do not manually mark. Because compilers often generate hidden classes or fields, and these class names are not stable. C# code that looks the same on the surface may not generate the same actual code. Forcing annotation as ",(0,r.kt)("inlineCode",{parentName:"p"},"[Unchanged]")," will lead to incorrect runtime logic or even crashes.")),(0,r.kt)("h2",{id:"merging-dhao-files"},"Merging DHAO Files"),(0,r.kt)("p",null,"Game packages released based on the same or similar source code have only minor differences in their original dhe assemblies across different platforms, and the DHAO files generated during hot updates also have only minor differences.\nThis requires calculating separate DHAO files for each platform (even on the same platform, due to code compilation instability, the generated original dlls may have minor differences), making DHAO maintenance complex and error-prone. This problem is particularly serious when multiple old and new game packages exist simultaneously.\nConsider merging DHAO files for multiple platforms corresponding to the same dhe assembly, which does not affect runtime correctness while having minimal impact on performance."),(0,r.kt)("p",null,"We provide the ",(0,r.kt)("inlineCode",{parentName:"p"},"HybridCLR.Editor.DHE.BuildUtil::MergeDHAOFiles")," function to achieve the goal of merging DHAO files."),(0,r.kt)("p",null,"Note that workflows with validation cannot use merged DHAO files because validated workflows check the md5 code of the original dll, which will definitely not match."),(0,r.kt)("h2",{id:"precautions"},"Precautions"),(0,r.kt)("h3",{id:"external-dlls-cause-massive-differences-in-dhao-calculation-results"},"External dlls cause massive differences in DHAO calculation results"),(0,r.kt)("p",null,"If external dlls are marked as DHE assemblies, because external dlls are stripped during packaging, but when calculating DHAO files, the original external dll is taken, causing massive differences, which is not expected. There are several solutions:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"In link.xml add ",(0,r.kt)("inlineCode",{parentName:"li"},'<assembly fullname="YourExternDll" preserve="all"/>')," to completely preserve external dlls"),(0,r.kt)("li",{parentName:"ol"},"Don't use the latest hot update dll to calculate differences, but use the AOT dll generated when repackaging with the latest code to calculate differences")))}p.isMDXComponent=!0}}]);