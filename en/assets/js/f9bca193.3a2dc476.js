"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[1916],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>f});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var p=r.createContext({}),s=function(e){var t=r.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=s(e.components);return r.createElement(p.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,p=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=s(n),m=a,f=u["".concat(p,".").concat(m)]||u[m]||d[m]||o;return n?r.createElement(f,i(i({ref:t},c),{},{components:n})):r.createElement(f,i({ref:t},c))}));function f(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=m;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l[u]="string"==typeof e?e:a,i[1]=l;for(var s=2;s<o;s++)i[s]=n[s];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},5632:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>l,toc:()=>s});var r=n(87462),a=(n(67294),n(3905));const o={},i="PInvoke support",l={unversionedId:"basic/pinvoke",id:"basic/pinvoke",title:"PInvoke support",description:"Before v8.0.0, if you defined an extern function in hot-update code and tried to call it, an error of ExecutionEngineException:method body is null would be thrown.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/basic/pinvoke.md",sourceDirName:"basic",slug:"/basic/pinvoke",permalink:"/en/docs/basic/pinvoke",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"MonoBehaviour Support",permalink:"/en/docs/basic/monobehaviour"},next:{title:"MonoPInvokeCallback Support",permalink:"/en/docs/basic/monopinvokecallback"}},p={},s=[{value:"Supported platforms",id:"supported-platforms",level:2},{value:"Reserved bridge function",id:"reserved-bridge-function",level:2},{value:"Limitations",id:"limitations",level:2}],c={toc:s},u="wrapper";function d(e){let{components:t,...n}=e;return(0,a.kt)(u,(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"pinvoke-support"},"PInvoke support"),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"Before v8.0.0, if you defined an extern function in hot-update code and tried to call it, an error of ",(0,a.kt)("inlineCode",{parentName:"p"},"ExecutionEngineException:method body is null")," would be thrown.")),(0,a.kt)("p",null,"hybridclr has always supported calling extern functions defined in AOT, but since ",(0,a.kt)("strong",{parentName:"p"},"v8.0.0"),", it supports defining extern functions in hot-update code."),(0,a.kt)("h2",{id:"supported-platforms"},"Supported platforms"),(0,a.kt)("p",null,"Supporting extern functions relies on the runtime to find function symbols in dynamic link libraries. It works properly on most platforms, but not on iOS."),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Platform"),(0,a.kt)("th",{parentName:"tr",align:null},"Support"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Windows"),(0,a.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Linux"),(0,a.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"MacOS"),(0,a.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Android"),(0,a.kt)("td",{parentName:"tr",align:null},"\u2714")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"iOS"),(0,a.kt)("td",{parentName:"tr",align:null})),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"WebGL"),(0,a.kt)("td",{parentName:"tr",align:null})),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Other platforms"),(0,a.kt)("td",{parentName:"tr",align:null},"Untested")))),(0,a.kt)("h2",{id:"reserved-bridge-function"},"Reserved bridge function"),(0,a.kt)("p",null,"When calling a PInvoke function, you also need to solve the parameter conversion from managed to native, so you need to generate the corresponding bridge function for the PInvoke function in advance, otherwise an exception will be thrown at runtime."),(0,a.kt)("p",null,"For PInvoke functions that already exist in the hot update code when constructing the main package, the corresponding bridge function will be automatically generated for them, and no special processing is required. For functions that may be used in the future but do not have an existing PInvoke function with the same signature, you need to reserve the corresponding bridge function for it."),(0,a.kt)("p",null,"The reservation method is to define some PInvoke type extern functions in the hot update code. PInvoke functions with the same signature can share the same bridge function, and it is ",(0,a.kt)("strong",{parentName:"p"},"not")," necessary to reserve a Wrapper function for each callback function like ",(0,a.kt)("inlineCode",{parentName:"p"},"[MonoPInvokeCallback]"),"."),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"dllName")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"EntryPoint")," parameters in the ",(0,a.kt)("inlineCode",{parentName:"p"},"DllImport")," attribute of the reserved PInvoke function can take any value and have no practical use."),(0,a.kt)("p",null,"Example as follows:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-csharp"},'\npublic static class PreservedPInvokes\n{\n[DllImport("xxxx", EntryPoint = "Demo0")]\npublic static extern void Demo0();\n\n[DllImport("xxxx", EntryPoint = "Demo1")]\npublic static extern void Demo1(int value);\n\n[DllImport("xxxx", EntryPoint = "DemoLua")]\npublic static extern IntPtr DemoLua(IntPtr luaState);\n}\n\n')),(0,a.kt)("h2",{id:"limitations"},"Limitations"),(0,a.kt)("p",null,"Since hybridclr currently does not marshal the parameters and return values \u200b\u200bof the PInvoke function, ordinary int and float types work normally, but parameters such as string are passed as 'char*' by the native layer, and are not marshaled to string, so they will inevitably crash if used directly!"),(0,a.kt)("p",null,"If you encounter a string type parameter, there are two solutions:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"You can put the callback function in AOT and call back the hot update function in AOT.")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Change the parameter to IntPtr type, and then call Marshal.PtrToStringUTF8 to convert the original char* type data of IntPtr type into string."))),(0,a.kt)("p",null,"The sample code is as follows:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-csharp"},'[DllImport("GameAssembly", EntryPoint = "GetStringLength")]\npublic static extern int GetStringLength(IntPtr ptr);\n\npublic static void ProcessString()\n{\n  var s = "abc";\n  // Convert the string to a native string of type `const char*`\n  IntPtr strPtr = Marshal.StringToHGlobalUni(s);\n  int length = GetStringLength(strPtr);\n  // Release string memory\n  Marshal.FreeHGlobal(strPtr);\n}\n\n')),(0,a.kt)("p",null,"Other non-primitive parameters that require Marshal can be processed in the same way."))}d.isMDXComponent=!0}}]);