"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[9973],{3905:(e,n,r)=>{r.d(n,{Zo:()=>u,kt:()=>m});var t=r(67294);function a(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function o(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,t)}return r}function i(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?o(Object(r),!0).forEach((function(n){a(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function l(e,n){if(null==e)return{};var r,t,a=function(e,n){if(null==e)return{};var r,t,a={},o=Object.keys(e);for(t=0;t<o.length;t++)r=o[t],n.indexOf(r)>=0||(a[r]=e[r]);return a}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(t=0;t<o.length;t++)r=o[t],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var s=t.createContext({}),c=function(e){var n=t.useContext(s),r=n;return e&&(r="function"==typeof e?e(n):i(i({},n),e)),r},u=function(e){var n=c(e.components);return t.createElement(s.Provider,{value:n},e.children)},d="mdxType",p={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},b=t.forwardRef((function(e,n){var r=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),d=c(r),b=a,m=d["".concat(s,".").concat(b)]||d[b]||p[b]||o;return r?t.createElement(m,i(i({ref:n},u),{},{components:r})):t.createElement(m,i({ref:n},u))}));function m(e,n){var r=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var o=r.length,i=new Array(o);i[0]=b;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l[d]="string"==typeof e?e:a,i[1]=l;for(var c=2;c<o;c++)i[c]=r[c];return t.createElement.apply(null,i)}return t.createElement.apply(null,r)}b.displayName="MDXCreateElement"},64894:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>s,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>l,toc:()=>c});var t=r(87462),a=(r(67294),r(3905));const o={},i="Common Errors",l={unversionedId:"business/reload/commonerrors",id:"business/reload/commonerrors",title:"Common Errors",description:"[Serializable] types or MonoBehaviour (ScriptableObject) crash when containing generic fields with generic parameters being types from unloaded assemblies",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/business/reload/commonerrors.md",sourceDirName:"business/reload",slug:"/business/reload/commonerrors",permalink:"/en/docs/business/reload/commonerrors",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Manual",permalink:"/en/docs/business/reload/manual"},next:{title:"\u5e2e\u52a9",permalink:"/en/docs/help"}},s={},c=[{value:"Serializable types or MonoBehaviour (ScriptableObject) crash when containing generic fields with generic parameters being types from unloaded assemblies",id:"serializable-types-or-monobehaviour-scriptableobject-crash-when-containing-generic-fields-with-generic-parameters-being-types-from-unloaded-assemblies",level:2},{value:"Issues with illegal references to objects or functions in unloaded assemblies during unloading",id:"issues-with-illegal-references-to-objects-or-functions-in-unloaded-assemblies-during-unloading",level:2},{value:"UnityEngine.AndroidJavaRunnableProxy",id:"unityengineandroidjavarunnableproxy",level:3}],u={toc:c},d="wrapper";function p(e){let{components:n,...r}=e;return(0,a.kt)(d,(0,t.Z)({},u,r,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"common-errors"},"Common Errors"),(0,a.kt)("h2",{id:"serializable-types-or-monobehaviour-scriptableobject-crash-when-containing-generic-fields-with-generic-parameters-being-types-from-unloaded-assemblies"},"[Serializable]"," types or MonoBehaviour (ScriptableObject) crash when containing generic fields with generic parameters being types from unloaded assemblies"),(0,a.kt)("p",null,"Metadata information of objects serialized using JsonUtility or MonoBehaviour will be cached by the engine. To support their unloading, we reuse this type information, i.e., after reloading the assembly, the metadata information accessed by the engine layer will be updated to the latest values."),(0,a.kt)("p",null,"Since caching behavior is internal black box behavior of the engine, we cannot reuse too complex metadata. For example, these type fields cannot be ",(0,a.kt)("inlineCode",{parentName:"p"},"List<T>")," where T is a type from the unloaded assembly."),(0,a.kt)("p",null,"The solution is to replace ",(0,a.kt)("inlineCode",{parentName:"p"},"List<T>")," with ",(0,a.kt)("inlineCode",{parentName:"p"},"T[]"),"."),(0,a.kt)("p",null,"Note that ",(0,a.kt)("strong",{parentName:"p"},"only ","[Serializable]"," and MonoBehaviour (ScriptableObject) have this limitation"),"; fields of other ordinary types can be of any type."),(0,a.kt)("h2",{id:"issues-with-illegal-references-to-objects-or-functions-in-unloaded-assemblies-during-unloading"},"Issues with illegal references to objects or functions in unloaded assemblies during unloading"),(0,a.kt)("h3",{id:"unityengineandroidjavarunnableproxy"},"UnityEngine.AndroidJavaRunnableProxy"),(0,a.kt)("p",null,"This object is created when CreteJavaProxy is called and is held by the engine layer. Unity doesn't provide a direct unloading method.\nThere is a cleanup method, but it cannot be cleaned immediately, and this type of error will still be reported during unloading:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-csharp"},"IntPtr handle = UnityEngine.AndroidJNIHelper.CreateJavaRunnable(xxx);\n")),(0,a.kt)("p",null,"Record the handle. Then clean it when not in use:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-csharp"},"UnityEngine.AndrodJNISafe.DelegateGlobalRef(handle);\n")),(0,a.kt)("p",null,"But this operation only stops holding this java Runnable object at the C# layer. Only when java gc occurs, this Runnable might be truly completely released, at which time the C# layer's AndroidJavaRunanbleProxy will be released, and then will no longer reference objects in the unloaded assembly."),(0,a.kt)("p",null,"Currently there is only one effective solution:"),(0,a.kt)("p",null,"Don't directly pass delegates from unloaded assemblies to AndroidJavaRunnable, but use a proxy class from other AOT or non-unloadable assemblies. Also record this proxy class when creating AndroidJavaRunnable. In the proxy class, save a reference to the actual delegate from the unloaded assembly, and clear this proxy class's delegate reference to null before unloading. Code looks like this:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-csharp"},"        class MyRunnableWrapper\n        {\n            private AndroidJavaRunnable _runnble;\n\n            public MyRunnableWrapper(AndroidJavaRunnable runnable)\n            {\n                _runnble = runnable;\n            }\n\n            public void Run()\n            {\n                _runnble?.Invoke();\n            }\n\n            public void Clean()\n            {\n                _runnble = null;\n            }\n        }\n\n        static void Register(AndroidJavaRunnable runnable)\n        {\n            var wrapper = new MyRunnableWrapper(runnable);\n\n            // Pass this to Java layer\n            var runner = UnityEngine.AndroidJNIHelper.CreateJavaRunnable(wrapper.Run);\n\n            // Clean before unloading\n            wrapper.Clean();\n        }\n")))}p.isMDXComponent=!0}}]);