"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[9892],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var r=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=r.createContext({}),p=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},c=function(e){var t=p(e.components);return r.createElement(l.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},h=r.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=p(n),h=i,m=d["".concat(l,".").concat(h)]||d[h]||u[h]||o;return n?r.createElement(m,a(a({ref:t},c),{},{components:n})):r.createElement(m,a({ref:t},c))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,a=new Array(o);a[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[d]="string"==typeof e?e:i,a[1]=s;for(var p=2;p<o;p++)a[p]=n[p];return r.createElement.apply(null,a)}return r.createElement.apply(null,n)}h.displayName="MDXCreateElement"},14893:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var r=n(87462),i=(n(67294),n(3905));const o={},a="Code Stripping",s={unversionedId:"basic/codestriping",id:"basic/codestriping",title:"Code Stripping",description:"Unity uses code stripping technology to help reduce package size for the il2cpp backend. If anti-stripping measures are not taken, since there is generally not much code in the AOT main project, a large number of C# types and functions are stripped, causing hot update calls to these stripped classes or functions to result in the following exceptions:",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/basic/codestriping.md",sourceDirName:"basic",slug:"/basic/codestriping",permalink:"/en/docs/basic/codestriping",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Publishing to WebGL Platform",permalink:"/en/docs/basic/buildwebgl"},next:{title:"MonoBehaviour Support",permalink:"/en/docs/basic/monobehaviour"}},l={},p=[{value:"Solution",id:"solution",level:2},{value:"AOT Type and Function Reservation",id:"aot-type-and-function-reservation",level:2},{value:"Check if Hot Update Code References Stripped Types or Functions",id:"check-if-hot-update-code-references-stripped-types-or-functions",level:2}],c={toc:p},d="wrapper";function u(e){let{components:t,...n}=e;return(0,i.kt)(d,(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"code-stripping"},"Code Stripping"),(0,i.kt)("p",null,"Unity uses ",(0,i.kt)("a",{parentName:"p",href:"https://docs.unity3d.com/Manual/ManagedCodeStripping.html"},"code stripping")," technology to help reduce package size for the il2cpp backend. If anti-stripping measures are not taken, since there is generally not much code in the AOT main project, a large number of C# types and functions are stripped, causing hot update calls to these stripped classes or functions to result in the following exceptions:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-txt"},"    // Type missing error\n    Unity: TypeLoadException: Could not load type 'Xxx' from assembly 'yyy'\n\n    // Function missing error\n    MissingMethodException: xxxx\n")),(0,i.kt)("h2",{id:"solution"},"Solution"),(0,i.kt)("p",null,"Based on error logs, determine which type or function was stripped, and preserve this type or function in link.xml, or explicitly add calls to these classes or functions in the main project.\nIf you're not familiar with how to preserve types or functions in link.xml, please refer to ",(0,i.kt)("a",{parentName:"p",href:"https://docs.unity3d.com/Manual/ManagedCodeStripping.html"},"code stripping"),"."),(0,i.kt)("p",null,'However, this method is ultimately cumbersome. In actual projects, there are a large number of stripped types, and you repeatedly perform "build-type missing-supplement-build" operations,\nwasting too much time. The ',(0,i.kt)("inlineCode",{parentName:"p"},"com.code-philosophy.hybridclr")," package provides a convenient menu command ",(0,i.kt)("inlineCode",{parentName:"p"},"HybridCLR/Generate/LinkXml"),",\nwhich can generate all AOT type and function references in the hot update project with one click."),(0,i.kt)("admonition",{type:"caution"},(0,i.kt)("p",{parentName:"admonition"},"Note that if your main project has never referenced any code from an assembly, that assembly will be completely stripped even if preserved in ",(0,i.kt)("inlineCode",{parentName:"p"},"link.xml"),". Therefore, for each AOT assembly to be preserved,\nplease ensure that some class or function from it has been explicitly referenced in the main project code.")),(0,i.kt)("h2",{id:"aot-type-and-function-reservation"},"AOT Type and Function Reservation"),(0,i.kt)("p",null,"Although the ",(0,i.kt)("inlineCode",{parentName:"p"},"HybridCLR/Generate/LinkXml")," command in com.code-philosophy.hybridclr can intelligently scan the AOT types you currently reference, it cannot predict the types you will use in the future. Therefore, you still need to plan ahead and reserve types you may use in the future in ",(0,i.kt)("inlineCode",{parentName:"p"},"Assets/link.xml")," (Note! Not the automatically generated link.xml).\nBe sure not to miss anything, to avoid the embarrassing situation where types used in a certain update after going live are stripped!"),(0,i.kt)("h2",{id:"check-if-hot-update-code-references-stripped-types-or-functions"},"Check if Hot Update Code References Stripped Types or Functions"),(0,i.kt)("p",null,"As long as ",(0,i.kt)("inlineCode",{parentName:"p"},"HybridCLR/Generate/All")," is correctly executed when building the game, running the hot update code at that time will not encounter missing types or functions. However, as hot update code continues to iterate, it may access stripped types or functions. If this can be detected in advance when releasing hot update code, problems can be discovered and resolved early."),(0,i.kt)("p",null,"Starting from v5.0.0, the ",(0,i.kt)("inlineCode",{parentName:"p"},"HybridCLR.Editor.HotUpdate.MissingMetadataChecker")," class is provided to check if stripped types and functions are accessed. Example code is as follows:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-csharp"},'        public static void CheckAccessMissingMetadata()\n        {\n            BuildTarget target = EditorUserBuildSettings.activeBuildTarget;\n            // aotDir points to the stripped aot dll directory generated when building the main package, not the latest SettingsUtil.GetAssembliesPostIl2CppStripDir(target) directory.\n            // Generally speaking, when releasing hot update packages, since generate/all may have been called in between, the SettingsUtil.GetAssembliesPostIl2CppStripDir(target) directory contains the latest aot dlls,\n            // which definitely cannot detect type or function stripping issues.\n            // After building the main package, the aot dlls at that time need to be saved for later supplemental metadata or stripping checks.\n            string aotDir = SettingsUtil.GetAssembliesPostIl2CppStripDir(target);\n\n            // The 2nd parameter hotUpdateAssNames is the hot update assembly list. For the flagship version, this list needs to include DHE assemblies, i.e., SettingsUtil.HotUpdateAndDHEAssemblyNamesIncludePreserved.\n            var checker = new MissingMetadataChecker(aotDir, SettingsUtil.HotUpdateAssemblyNamesIncludePreserved);\n\n            string hotUpdateDir = SettingsUtil.GetHotUpdateDllsOutputDirByTarget(target);\n            foreach (var dll in SettingsUtil.HotUpdateAssemblyFilesExcludePreserved)\n            {\n                string dllPath = $"{hotUpdateDir}/{dll}";\n                bool notAnyMissing = checker.Check(dllPath);\n                if (!notAnyMissing)\n                {\n                    // DO SOMETHING\n                }\n            }\n        }\n\n')))}u.isMDXComponent=!0}}]);