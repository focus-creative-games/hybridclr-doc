"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[9388],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>g});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},c="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),c=p(n),u=i,g=c["".concat(s,".").concat(u)]||c[u]||m[u]||r;return n?a.createElement(g,o(o({ref:t},d),{},{components:n})):a.createElement(g,o({ref:t},d))}));function g(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[c]="string"==typeof e?e:i,o[1]=l;for(var p=2;p<r;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},62702:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>m,frontMatter:()=>r,metadata:()=>l,toc:()=>p});var a=n(87462),i=(n(67294),n(3905));const r={},o="Using Generics",l={unversionedId:"beginner/generic",id:"beginner/generic",title:"Using Generics",description:"HybridCLR fully supports generic features without any limitations.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/beginner/generic.md",sourceDirName:"beginner",slug:"/beginner/generic",permalink:"/en/docs/beginner/generic",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Using MonoBehaviour",permalink:"/en/docs/beginner/monobehaviour"},next:{title:"Code Obfuscation",permalink:"/en/docs/basic/codeobfuscation"}},s={},p=[{value:"Using Generic Classes or Functions Defined in Hot Updates",id:"using-generic-classes-or-functions-defined-in-hot-updates",level:2},{value:"Using Generic Classes or Functions Defined in AOT",id:"using-generic-classes-or-functions-defined-in-aot",level:2},{value:"Obtaining Supplementary Metadata DLLs",id:"obtaining-supplementary-metadata-dlls",level:2},{value:"Executing Supplementary Metadata",id:"executing-supplementary-metadata",level:2},{value:"Optimizing Supplementary Metadata DLL Size",id:"optimizing-supplementary-metadata-dll-size",level:2}],d={toc:p},c="wrapper";function m(e){let{components:t,...n}=e;return(0,i.kt)(c,(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"using-generics"},"Using Generics"),(0,i.kt)("p",null,"HybridCLR fully supports generic features without any limitations."),(0,i.kt)("h2",{id:"using-generic-classes-or-functions-defined-in-hot-updates"},"Using Generic Classes or Functions Defined in Hot Updates"),(0,i.kt)("p",null,"Use them directly."),(0,i.kt)("h2",{id:"using-generic-classes-or-functions-defined-in-aot"},"Using Generic Classes or Functions Defined in AOT"),(0,i.kt)("p",null,"For detailed principles about AOT generic issues, please read ",(0,i.kt)("a",{parentName:"p",href:"/en/docs/basic/aotgeneric"},"AOT Generics"),"."),(0,i.kt)("p",null,"If some generic class or function has already been instantiated in AOT code, it can be used directly in hot updates. For example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-csharp"},"\n// AOT already used List<float> generic\nclass Foo\n{\n    public void Run()\n    {\n        var arr = new List<float>();\n    }\n}\n\n// Hot update can use List<float>\nclass HotUpdateGenericDemos\n{\n    public void Run()\n    {\n        var arr = new List<float>();\n    }\n}\n\n")),(0,i.kt)("p",null,"But if some AOT generic class or function hasn't been instantiated in AOT, there are several solutions:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Add corresponding instantiation code in AOT code."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Supplementary metadata technology"),". This is HybridCLR's patented technology, also available in the community version."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"Full generic sharing")," complete generic sharing technology. Compared to supplementary metadata technology, the workflow is simpler, requiring neither carrying or downloading supplementary metadata dlls with the package, nor loading supplementary metadata dlls, with significantly reduced package size and memory usage. This technology is currently only available in commercial versions.")),(0,i.kt)("p",null,"Method 1 has several fatal flaws:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Adding instantiation code in AOT requires repackaging, which is not only troublesome during development but also unrealistic to rerelease the main package shortly after going live."),(0,i.kt)("li",{parentName:"ul"},"Generic parameters might be hot update types, making it impossible to instantiate them in AOT in advance. For example, if you define ",(0,i.kt)("inlineCode",{parentName:"li"},"struct MyVector3 {int x, y, z;}")," in hot update code, you cannot instantiate ",(0,i.kt)("inlineCode",{parentName:"li"},"List<MyVector3>")," in AOT in advance.")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"Supplementary metadata technology")," completely solves this problem. Roughly speaking, after supplementing the original metadata of an AOT generic class (or generic function), you can instantiate this generic class arbitrarily. Using the above ",(0,i.kt)("inlineCode",{parentName:"p"},"List<MyVector3>")," example, after supplementing the metadata of ",(0,i.kt)("inlineCode",{parentName:"p"},"mscorlib.dll")," where the List class (not MyVector3) is located, you can use any ",(0,i.kt)("inlineCode",{parentName:"p"},"List<T>")," generic class in hot update code."),(0,i.kt)("p",null,"The disadvantage of supplementary metadata technology is that it increases package size or requires additional downloading of supplementary metadata dlls, making the workflow more complex, and also consuming more memory. ",(0,i.kt)("inlineCode",{parentName:"p"},"Full generic sharing")," further solves these defects of supplementary metadata. Since ",(0,i.kt)("inlineCode",{parentName:"p"},"full generic sharing")," is a commercial solution, due to space limitations, only the usage of supplementary metadata is introduced here."),(0,i.kt)("h2",{id:"obtaining-supplementary-metadata-dlls"},"Obtaining Supplementary Metadata DLLs"),(0,i.kt)("p",null,"The stripped AOT dlls generated during the ",(0,i.kt)("strong",{parentName:"p"},"packaging process")," can be used for supplementary metadata. The com.code-philosophy.hybridclr plugin automatically copies them to ",(0,i.kt)("inlineCode",{parentName:"p"},"{project}/HybridCLRData/AssembliesPostIl2CppStrip/{target}"),"."),(0,i.kt)("admonition",{type:"danger"},(0,i.kt)("p",{parentName:"admonition"},"Stripped AOT dlls from different BuildTargets cannot be reused.")),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"HybridCLR/Generate/AotDlls")," command can also immediately generate stripped AOT dlls. It works by exporting a Temp project to obtain stripped AOT dlls."),(0,i.kt)("p",null,"Get the supplementary metadata dlls you need from the ",(0,i.kt)("inlineCode",{parentName:"p"},"{project}/HybridCLRData/AssembliesPostIl2CppStrip/{target}")," directory and add them to your project's hot update resource management system. For demonstration purposes, the sample project places them in the StreamingAssets directory.\nTaking the ",(0,i.kt)("inlineCode",{parentName:"p"},"List<T>")," type as an example, it needs to supplement ",(0,i.kt)("inlineCode",{parentName:"p"},"mscorlib.dll"),". Copy ",(0,i.kt)("inlineCode",{parentName:"p"},"{project}/HybridCLRData/AssembliesPostIl2CppStrip/{target}/mscorlib.dll")," to ",(0,i.kt)("inlineCode",{parentName:"p"},"Assets/StreamingAssets/mscorlib.dll.bytes"),"."),(0,i.kt)("h2",{id:"executing-supplementary-metadata"},"Executing Supplementary Metadata"),(0,i.kt)("p",null,"Use the ",(0,i.kt)("inlineCode",{parentName:"p"},"HybridCLR.RuntimeApi.LoadMetadataForAOTAssembly")," function in the ",(0,i.kt)("inlineCode",{parentName:"p"},"com.code-philosophy.hybridclr")," package to supplement metadata for AOT generics.\nMetadata only needs to be supplemented once, recommended before executing any hot update code. ",(0,i.kt)("inlineCode",{parentName:"p"},"LoadDll.cs")," should look similar to the following:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-csharp"},'\npublic class LoadDll : MonoBehaviour\n{\n\n    void Start()\n    {\n        // Supplement metadata first\n        LoadMetadataForAOTAssemblies();\n      // In Editor environment, HotUpdate.dll.bytes has been automatically loaded, no need to load, repeated loading will cause problems.\n#if !UNITY_EDITOR\n        Assembly hotUpdateAss = Assembly.Load(File.ReadAllBytes($"{Application.streamingAssetsPath}/HotUpdate.dll.bytes"));\n#else\n      // No need to load in Editor, directly find and get HotUpdate assembly\n        Assembly hotUpdateAss = System.AppDomain.CurrentDomain.GetAssemblies().First(a => a.GetName().Name == "HotUpdate");\n#endif\n    \n        Type type = hotUpdateAss.GetType("Hello");\n        type.GetMethod("Run").Invoke(null, null);\n    }\n\n    private static void LoadMetadataForAOTAssemblies()\n    {\n        List<string> aotDllList = new List<string>\n        {\n            "mscorlib.dll",\n            "System.dll",\n            "System.Core.dll", // If using Linq, this is needed\n            // "Newtonsoft.Json.dll", \n            // "protobuf-net.dll",\n        };\n\n        foreach (var aotDllName in aotDllList)\n        {\n            byte[] dllBytes = File.ReadAllBytes($"{Application.streamingAssetsPath}/{aotDllName}.bytes");\n            int err = HybridCLR.RuntimeApi.LoadMetadataForAOTAssembly(dllBytes, HomologousImageMode.SuperSet);\n            Debug.Log($"LoadMetadataForAOTAssembly:{aotDllName}. ret:{err}");\n        }\n    }\n}    \n')),(0,i.kt)("p",null,"Now you can freely use AOT generics in hot update code."),(0,i.kt)("admonition",{type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"Please save the stripped AOT dlls generated during packaging (usually in the ",(0,i.kt)("inlineCode",{parentName:"p"},"{project}/HybridCLRData/AssembliesPostIl2CppStrip/{target}")," directory). Use these saved AOT dlls when supplementary metadata is needed."),(0,i.kt)("p",{parentName:"admonition"},"After packaging is complete, supplementary metadata dlls will not change. Please ",(0,i.kt)("strong",{parentName:"p"},"do not use the latest generated AOT dlls for each hot update"),".")),(0,i.kt)("h2",{id:"optimizing-supplementary-metadata-dll-size"},"Optimizing Supplementary Metadata DLL Size"),(0,i.kt)("p",null,"The default generated supplementary metadata dlls contain a lot of data that the supplementary metadata mechanism doesn't need. Starting from version v4.0.16, optimization and trimming of supplementary metadata dlls is supported. For detailed documentation, see ",(0,i.kt)("a",{parentName:"p",href:"../basic/aotgeneric"},"AOT Generics"),"."))}m.isMDXComponent=!0}}]);