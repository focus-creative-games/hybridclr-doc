"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[6418],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>p});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},h="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},f=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),h=c(n),f=r,p=h["".concat(s,".").concat(f)]||h[f]||u[f]||i;return n?a.createElement(p,o(o({ref:t},d),{},{components:n})):a.createElement(p,o({ref:t},d))}));function p(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=f;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[h]="string"==typeof e?e:r,o[1]=l;for(var c=2;c<i;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}f.displayName="MDXCreateElement"},65584:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var a=n(87462),r=(n(67294),n(3905));const i={},o="DHAO file",l={unversionedId:"business/ultimate/dhao",id:"version-7.6.0/business/ultimate/dhao",title:"DHAO file",description:"The dhao file is the core concept of DHE technology. The dhao file contains the information of the types and functions changed in the latest hot update dll calculated offline. When executing a hot update function, the runtime directly determines whether to use the latest interpreted version or directly call the original AOT function based on the information in the dhao file.",source:"@site/i18n/en/docusaurus-plugin-content-docs/version-7.6.0/business/ultimate/dhao.md",sourceDirName:"business/ultimate",slug:"/business/ultimate/dhao",permalink:"/en/docs/7.6.0/business/ultimate/dhao",draft:!1,tags:[],version:"7.6.0",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Build and hot update",permalink:"/en/docs/7.6.0/business/ultimate/build"},next:{title:"User Manual",permalink:"/en/docs/7.6.0/business/ultimate/manual"}},s={},c=[{value:"Mark changed function information",id:"mark-changed-function-information",level:2},{value:"Merge dhao files",id:"merge-dhao-files",level:2},{value:"Notes",id:"notes",level:2},{value:"The results of calculating dhao caused by external dlls have huge differences",id:"the-results-of-calculating-dhao-caused-by-external-dlls-have-huge-differences",level:3}],d={toc:c},h="wrapper";function u(e){let{components:t,...n}=e;return(0,r.kt)(h,(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"dhao-file"},"DHAO file"),(0,r.kt)("p",null,"The dhao file is the core concept of DHE technology. The dhao file contains the information of the types and functions changed in the latest hot update dll calculated offline. When executing a hot update function, the runtime directly determines whether to use the latest interpreted version or directly call the original AOT function based on the information in the dhao file.\nThe dhao file calculated offline is extremely critical for DHE technology. If there is no dhao file, the original AOT dll needs to be carried additionally, and the cost of calculating function changes is extremely high."),(0,r.kt)("p",null,"By comparing the latest hot update dll with the AOT dll generated during packaging, the changed types and functions are calculated offline and saved as dhao files. Therefore, for the DHE mechanism to work properly, it must rely on the correctness of the dhao file, and the correctness of the dhao file\ndepends on accurately providing the latest hot update dll and the AOT dll generated during packaging."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"HybridCLR.Editor.DHE.BuildUtils")," provides multiple functions related to generating dhao files."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Function name"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"GenerateDHAODatas"),(0,r.kt)("td",{parentName:"tr",align:null},"Generate dhao file for hot update package (i.e. when code changes)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"EncryptDllAndGenerateDHAODatas"),(0,r.kt)("td",{parentName:"tr",align:null},"When primary code reinforcement is enabled, generate encrypted dll and dhao file for hot update package (i.e. when code changes)")))),(0,r.kt)("h2",{id:"mark-changed-function-information"},"Mark changed function information"),(0,r.kt)("p",null,"Currently, it is possible to automatically calculate the changed functions by comparing the latest hot update dll with the aot dll generated during packaging, and manual operation is not required in most cases. But in fact, there is no perfect code that can determine logical equivalence.\nThe tool simply compares IL one by one to determine equivalence. Sometimes, the function may be equivalent but the IL has changed (such as swapping the order of two unrelated lines of code), which will be judged as a function transformation and switched to interpreted execution.\nIf this happens, ",(0,r.kt)("strong",{parentName:"p"},"and there are extremely strict performance requirements for the function"),", developers can manually use the UnchangedAttribute feature to mark the function's variability.\n",(0,r.kt)("inlineCode",{parentName:"p"},"[Unchanged]")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"[Unchanged(true)]")," indicate unchanged, ",(0,r.kt)("inlineCode",{parentName:"p"},"[Unchanged(false)]")," indicates changed, and unmarked features are automatically calculated by the tool."),(0,r.kt)("p",null,"Incorrectly marking unchanged functions as changed will not affect the correctness of the operation, but only the performance. Even if all hot update functions are marked as changed, they can still run normally. However, incorrectly marking changed functions as unchanged will not only cause errors in the operation logic,\nbut also cause crashes in serious cases!"),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"Unless there are special circumstances and you are an experienced expert, do not mark manually. Because the compiler often generates some hidden classes or fields, these class names are not stable. The C# code that looks the same on the surface may not be the same as the actual generated code. Forcibly marking it as ",(0,r.kt)("inlineCode",{parentName:"p"},"[Unchanged]")," will lead to incorrect operation logic or even crashes.")),(0,r.kt)("h2",{id:"merge-dhao-files"},"Merge dhao files"),(0,r.kt)("p",null,"Game packages released based on the same or similar source code have only slight differences in their original dhe assemblies on different platforms, and the dhao files generated during hot updates also have only slight differences.\nThis results in the need to calculate a separate dhao file for each platform (even for the same platform, the generated original dll may have slight differences due to the instability of code compilation), which makes the maintenance of dhao complicated and error-prone. This problem is particularly serious when multiple new and old game packages exist at the same time.\nYou can consider merging the dhao files of multiple platforms corresponding to the same dhe assembly, which does not affect the correctness of the operation and has little impact on performance."),(0,r.kt)("p",null,"We provide the ",(0,r.kt)("inlineCode",{parentName:"p"},"HybridCLR.Editor.DHE.BuildUtil::MergeDHAOFiles")," function to achieve the goal of merging dhao files."),(0,r.kt)("p",null,"Note that the workflow with verification cannot use the method of merging dhao files, because the workflow with verification will check the md5 code of the original dll, which is definitely not a match."),(0,r.kt)("h2",{id:"notes"},"Notes"),(0,r.kt)("h3",{id:"the-results-of-calculating-dhao-caused-by-external-dlls-have-huge-differences"},"The results of calculating dhao caused by external dlls have huge differences"),(0,r.kt)("p",null,"If an external dll is marked as a DHE assembly, the external dll will be trimmed when it is packaged, and when calculating the dhao file, the original external dll is taken, resulting in huge differences, which is not expected. There are several solutions:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"In link.xml, ",(0,r.kt)("inlineCode",{parentName:"li"},'<assembly fullname="YourExternDll" preserve="all"/>')," completely retain the external dll"),(0,r.kt)("li",{parentName:"ol"},"Instead of using the latest hot update dll to calculate the difference, use the aot dll generated when the latest code is repackaged to calculate the difference")))}u.isMDXComponent=!0}}]);