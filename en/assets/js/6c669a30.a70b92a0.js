"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[6668],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>y});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),u=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=u(e.components);return r.createElement(l.Provider,{value:t},e.children)},m="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},p=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),m=u(n),p=a,y=m["".concat(l,".").concat(p)]||m[p]||d[p]||o;return n?r.createElement(y,i(i({ref:t},c),{},{components:n})):r.createElement(y,i({ref:t},c))}));function y(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=p;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[m]="string"==typeof e?e:a,i[1]=s;for(var u=2;u<o;u++)i[u]=n[u];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}p.displayName="MDXCreateElement"},9106:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>u});var r=n(7462),a=(n(7294),n(3905));const o={},i="Redirect metadata",s={unversionedId:"business/ultimate/retargetmetadata",id:"version-7.8.1/business/ultimate/retargetmetadata",title:"Redirect metadata",description:"The anonymous classes and anonymous functions generated by the compiler are unstable. Sometimes, just because a new type or function is added to the assembly, the names of a large number of anonymous classes and anonymous functions will change.",source:"@site/i18n/en/docusaurus-plugin-content-docs/version-7.8.1/business/ultimate/retargetmetadata.md",sourceDirName:"business/ultimate",slug:"/business/ultimate/retargetmetadata",permalink:"/en/docs/7.8.1/business/ultimate/retargetmetadata",draft:!1,tags:[],version:"7.8.1",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Function Injection Rules",permalink:"/en/docs/7.8.1/business/ultimate/injectrules"},next:{title:"Frequently Asked Questions",permalink:"/en/docs/7.8.1/business/ultimate/commonerrors"}},l={},u=[{value:"Issues with functions marked with <code>[BurstCompile]</code>",id:"issues-with-functions-marked-with-burstcompile",level:2},{value:"Redirect anonymous type names and anonymous function names",id:"redirect-anonymous-type-names-and-anonymous-function-names",level:2},{value:"Other notes",id:"other-notes",level:2}],c={toc:u},m="wrapper";function d(e){let{components:t,...n}=e;return(0,a.kt)(m,(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"redirect-metadata"},"Redirect metadata"),(0,a.kt)("p",null,"The anonymous classes and anonymous functions generated by the compiler are unstable. Sometimes, just because a new type or function is added to the assembly, the names of a large number of anonymous classes and anonymous functions will change."),(0,a.kt)("p",null,"Even if the code of these anonymous classes themselves has not changed, because their names have changed, these anonymous classes and functions will be judged as changes when generating Dhao, causing these anonymous functions to be executed in an interpreted manner, which ultimately affects the running performance."),(0,a.kt)("h2",{id:"issues-with-functions-marked-with-burstcompile"},"Issues with functions marked with ",(0,a.kt)("inlineCode",{parentName:"h2"},"[BurstCompile]")),(0,a.kt)("p",null,"If the game uses burst-related technologies, the burst-related package will modify the functions marked with ",(0,a.kt)("inlineCode",{parentName:"p"},"[BurstCompile]")," during compilation, for example:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-csharp"},"\n[BurstCompile]\nprivate static int DecryptNumber(int number, int mulFactor, int addFactor)\n{\nreturn (number - addFactor) / mulFactor;\n}\n\n")),(0,a.kt)("p",null,"Finally it will compile to"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-csharp"},"\n[BurstCompile]\nprivate static int DecryptNumber(int number, int mulFactor, int addFactor)\n{\nreturn DecryptNumber_00000029$BurstDirectCall.Invoke(number, mulFactor, addFactor);\n}\n\npublic delegate int DecryptNumber_00000029$PostfixBurstDelegate(int number, int mulFactor, int addFactor); internal static class DecryptNumber_00000029$BurstDirectCall { // Ignore some code... public unsafe static int Invoke(int number, int mulFactor, int addFactor) { if (BurstCompiler.IsEnabled) { IntPtr functionPointer = GetFunctionPointer(); if (functionPointer != (IntPtr)0) { return ((delegate* unmanaged[Cdecl]<int, int, int, int>)functionPointer)(number, mulFactor, addFactor); } } return DecryptNumber$BurstManaged(number, mulFactor, addFactor); }\n}\n\n")),(0,a.kt)("p",null,"If you add some other types to the assembly, even if you do not modify the code of ",(0,a.kt)("inlineCode",{parentName:"p"},"DecryptNumber"),", the next time you compile, ",(0,a.kt)("inlineCode",{parentName:"p"},"DecryptNumber_00000029$BurstDirectCall")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"DecryptNumber_00000029$PostfixBurstDelegate"),"\nmay become ",(0,a.kt)("inlineCode",{parentName:"p"},"DecryptNumber_0000002A$BurstDirectCall")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"DecryptNumber_0000002A$PostfixBurstDelegate"),"."),(0,a.kt)("p",null,"This not only causes DecryptNumber to be incorrectly executed in interpreted mode, but also causes runtime errors or even crashes on hybridclr versions lower than 7.4.0!"),(0,a.kt)("h2",{id:"redirect-anonymous-type-names-and-anonymous-function-names"},"Redirect anonymous type names and anonymous function names"),(0,a.kt)("p",null,"Since the ultimate version ",(0,a.kt)("inlineCode",{parentName:"p"},"v7.4.0"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"HybridCLR.Editor.AssemblyMetaRetarget")," is provided for redirecting metadata to enhance the stability of metadata related to anonymous classes and anonymous functions."),(0,a.kt)("p",null,"Usage is as follows:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-csharp"},'        private static void RetargetAssembly()\n        {\n            string dllName = "HotUpdate";\n\n            string dllDir = $"{Application.dataPath}/../Dlls";\n\n            string oldDllFile = $"{dllDir}/{dllName}.old.dll.bytes";\n            string newDllFile = $"{dllDir}/{dllName}.new.dll.bytes";\n            byte[] oldDllBytes = File.ReadAllBytes(oldDllFile);\n            byte[] newDllBytes = File.ReadAllBytes(newDllFile);\n\n            var retarget = new AssemblyMetaRetarget(oldDllBytes, newDllBytes);\n            retarget.Retarget();\n            retarget.Save($"{dllDir}/{dllName}.retargeted.dll.bytes");\n        }\n\n')),(0,a.kt)("h2",{id:"other-notes"},"Other notes"),(0,a.kt)("p",null,"Redirecting metadata is optional. If you do not use ",(0,a.kt)("inlineCode",{parentName:"p"},"[BurstCompile]"),", you generally do not need to perform this operation."),(0,a.kt)("p",null,"After redirecting the metadata, please treat the generated assembly as the latest hot update assembly to generate dhao."))}d.isMDXComponent=!0}}]);