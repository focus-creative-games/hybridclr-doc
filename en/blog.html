<!doctype html>
<html lang="en-us" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Blog | HybridCLR</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hybridclr.doc.code-philosophy.com/en/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hybridclr.doc.code-philosophy.com/en/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hybridclr.doc.code-philosophy.com/en/blog"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="Blog | HybridCLR"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/en/img/logo.png"><link data-rh="true" rel="canonical" href="https://hybridclr.doc.code-philosophy.com/en/blog"><link data-rh="true" rel="alternate" href="https://hybridclr.doc.code-philosophy.com/blog" hreflang="zh-cn"><link data-rh="true" rel="alternate" href="https://hybridclr.doc.code-philosophy.com/en/blog" hreflang="en-us"><link data-rh="true" rel="alternate" href="https://hybridclr.doc.code-philosophy.com/blog" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://MHX0T95QPO-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/en/blog/rss.xml" title="HybridCLR RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/en/blog/atom.xml" title="HybridCLR Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="HybridCLR" href="/en/opensearch.xml"><link rel="stylesheet" href="/en/assets/css/styles.d6735dd1.css">
<link rel="preload" href="/en/assets/js/runtime~main.b7b60053.js" as="script">
<link rel="preload" href="/en/assets/js/main.a2da2992.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/en/"><div class="navbar__logo"><img src="/en/img/logo.png" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/en/img/logo.png" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">HybridCLR</b></a><a class="navbar__item navbar__link" href="/en/docs/intro">Tutorial</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/en/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/focus-creative-games/hybridclr" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/blog" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-cn">中文</a></li><li><a href="/en/blog" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en-us">English</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/instructions">hybridclr指令集设计</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/principle">hybridclr技术原理剖析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/mindexperiment">关于hybridclr可行性的思维实验</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/en/blog/catelog">深入探究hybridclr 目录</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/en/blog/instructions">hybridclr指令集设计</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-07-14T00:00:00.000Z" itemprop="datePublished">July 14, 2022</time> · <!-- -->24 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">walon</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>原始IL指令集是基于栈的指令集，优点是指令个数少、优雅、紧凑，非常适合表示虚拟机逻辑，但并不适合被解释器高效解释运行。因此我们需要将它转换为自定义的另一种能够高效
解释执行的指令集，然后再在我们的解释器中运行。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="il指令集的缺陷">IL指令集的缺陷<a href="#il指令集的缺陷" class="hash-link" aria-label="Direct link to IL指令集的缺陷" title="Direct link to IL指令集的缺陷">​</a></h2><ul><li>IL是基于栈的指令，运行时维护执行栈是个无谓的开销</li><li>IL有大量单指令多功能的指令，如add指令可以用于计算int、long、float、double类型的和，导致运行时需要根据上文判断到底该执行哪种计算。不仅增加了运行时判定的开销，还增加了运行时维护执行栈数据类型的开销</li><li>IL指令包含一些需要运行时resolve的数据，如newobj指令第一个参数是method token。token resolve是一个开销很大的操作，每次执行都进行resolve会极大拖慢执行性能</li><li>IL是基于栈的指令，压栈退栈相关指令数较多。像a=b+c这样的指令需要4条指令完成，而如果采用基于寄存器的指令，完全可以一条指令完成。</li><li>IL不适合做其他优化操作，如我们的InitOnce JIT技术。</li><li>其他</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="hybridclr令集设计目标">hybridclr令集设计目标<a href="#hybridclr令集设计目标" class="hash-link" aria-label="Direct link to hybridclr令集设计目标" title="Direct link to hybridclr令集设计目标">​</a></h2><p>hybridclr指令集设计目标就是解决原始IL的缺陷，以及做一些更高级的优化，目前主要包含以下功能</p><ul><li>指令中包含要操作的目标地址，不再需要维护栈</li><li>对于单指令多功能指针需要为每种操作数据类型维护一个对应指令，免去运行时维护类型及判定类型的开销。如如add指令，要特例化为add_int、add_long之类的指令</li><li>对于涉及到token解析的指令，尽量转换指令时直接固定，省去计算或者查询的开销。如 newobj中 method token字段，直接转变成 MethodInfo* 元数据</li><li>对于一些常见操作如 a = b + c，需要 <code>ldloc b , ldloc c, add, stloc a</code> 这4条指令，我们希望提供专用指令折叠它</li><li>需要能与一些常见的优化技术配合，如函数inline、InitOnce动态jit技术</li><li>需要考虑到跨平台问题，如在armv7这种要求内存对齐的硬件上，也能高效执行</li></ul><p>hybridclr使用经典的寄存器指令集配合一些其他运行时设施实现以上目标。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="运行环境">运行环境<a href="#运行环境" class="hash-link" aria-label="Direct link to 运行环境" title="Direct link to 运行环境">​</a></h2><p>无论指令的内容如何，指令的执行结果必须产生副作用（哪怕是nop这种什么也不干的指令，也导致当前指令寄存器ip发生变化），而这些副作用，必然作用于运行环境（甚至有可能作用于指令本身，如InitOnce技术）。正因为指令执行离不开具体的执行环境，指令设计必然跟hybridclr解释器及il2cpp运行时的运行环境紧密相关。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="hybridclr函数帧栈">hybridclr函数帧栈<a href="#hybridclr函数帧栈" class="hash-link" aria-label="Direct link to hybridclr函数帧栈" title="Direct link to hybridclr函数帧栈">​</a></h3><p>大多数基础指令都是操作 函数参数、局部变量、执行栈顶的数据，在hybridclr中使用数据栈来存放这些数据，并以逻辑地址（类型uint16_t）来标识要操作的数据的位置。逻辑地址是局部的，每个函数的执行栈帧的逻辑地址从0开始，最大2^16-1。</p><p>逻辑地址的布局如下</p><p><img loading="lazy" alt="method frame" src="/en/assets/images/method_frame-de7744d5746220ffa359d2d196e03868.jpg" width="177" height="537" class="img_ev3q"></p><p>函数帧根据其嵌套顺序，在数据栈上的位置从低位向高位扩展，如下图</p><p><img loading="lazy" alt="method frame" src="data:image/jpeg;base64,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" width="133" height="520" class="img_ev3q"></p><p>数据栈每个slot都为一个size=8的StackObject类型对象，每个变量可能占1个或多个slot。例如int类型变量只占一个slot，但Vector3类型变量占2个slot。</p><p>localVarBase 指针为函数帧栈的基准位置。</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">union</span><span class="token plain"> StackObject</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> ptr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// can&#x27;t adjust position. will raise native_invoke init args bugs.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int8_t</span><span class="token plain"> i8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token plain"> u8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int16_t</span><span class="token plain"> i16</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> u16</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> i32</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> u32</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int64_t</span><span class="token plain"> i64</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> u64</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> f4</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> f8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Il2CppObject</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Il2CppString</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> str</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Il2CppObject</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> ptrObj</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">StackObject</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> localVarBase</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="运行时相关">运行时相关<a href="#运行时相关" class="hash-link" aria-label="Direct link to 运行时相关" title="Direct link to 运行时相关">​</a></h3><p>除了只操作函数帧栈及当前函数状态的指令外，剩下的指令都要依赖于il2cpp运行时及hybridclr解释器执行环境MachineState提供的api才能完成功能。更细化地说，又分为几类</p><ul><li>metadata数据相关。如typeof指令，依赖于运行时将token转换为Il2Class*运行时metadata</li><li>对象相关。如 ldsfld指令 类型静态成员访问</li><li>gc相关。如newobj指令依赖于gc相关机制分配对象内存</li><li>多线程相关。如ThreadStatic类型的类静态成员变量</li><li>其他一些特殊机制。如localloc指令依赖于 hybridclr的MachineState提供api来分配内存</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="指令结构">指令结构<a href="#指令结构" class="hash-link" aria-label="Direct link to 指令结构" title="Direct link to 指令结构">​</a></h2><p>hybridclr指令结构如下</p><p><img loading="lazy" alt="instrument" src="data:image/jpeg;base64,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" width="168" height="285" class="img_ev3q"></p><p>其中指令的前2字节是opcode，剩下的指令数据我们称之为指令param。param分为几种类型：</p><ul><li>数据逻辑地址。</li><li>普通字面常量。比如<code>a = b + 5</code>，其中常量5必然要体现到指令之中</li><li>resolve后的数据。如 <code>ldtoken</code>，为了优化性能不想每次执行时计算token，那就必然要把运行时resolve好的token对应的元数据包含到指令中</li><li>resolve后的数据的指针。一些指令中包含不定长度的数据，如switch语句可能包含n个case项目的跳转地址。为了让指令本身大小固定，我们将这些不定长的数据存到InterpMethodInfo的resolvedDatas中，用一个uint32_t的索引指向它的位置。</li><li>其他一些辅助数据</li><li>为了保证param内存对齐访问而插入的padding参数</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="跨平台兼容性">跨平台兼容性<a href="#跨平台兼容性" class="hash-link" aria-label="Direct link to 跨平台兼容性" title="Direct link to 跨平台兼容性">​</a></h2><p>指令直接相关的跨平台兼容性问题主要是内存对齐问题。目前arm64 CPU支持非对齐的内存访问，但armv7仍然要求内存对齐，否则一旦发生非对齐访问，要么就运行效率大幅下降，要么直接导致崩溃。
尽管可以针对64位和32位设计两套完全不同的指令，但出于方便维护考虑，hybridclr还是统一使用了一套指令集。</p><p>hybridclr指令的一些设计约束：</p><ul><li>每条指令的前2字节必须为opcode</li><li>满足内存对齐。指令param的size可能是1、2、4、8。为了满足内存对齐的要求，我们在param之间插入一些uint8_t类型的无用padding数据。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="padding优化">padding优化<a href="#padding优化" class="hash-link" aria-label="Direct link to padding优化" title="Direct link to padding优化">​</a></h3><p>为了最大程度减少浪费的padding数据空间，我们将所有param排序，从小到大排列，同时插入padding以满足内存对齐。经过不太复杂的推理，我们可以知道，每条指令最多浪费<strong>7</strong>字节的padding空间。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="指令实现">指令实现<a href="#指令实现" class="hash-link" aria-label="Direct link to 指令实现" title="Direct link to 指令实现">​</a></h2><p>由于IL指令众多，我们无法一一介绍所有指令对应的hybridclr指令集设计，我们分为几大类详细介绍。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="空指令">空指令<a href="#空指令" class="hash-link" aria-label="Direct link to 空指令" title="Direct link to 空指令">​</a></h3><p>如nop、pop指令，直接在transform阶段就被消除，完全不产生对应的hybridclr指令。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="简单数据复制指令">简单数据复制指令<a href="#简单数据复制指令" class="hash-link" aria-label="Direct link to 简单数据复制指令" title="Direct link to 简单数据复制指令">​</a></h3><p>典型有</p><ul><li>操作函数参数的指令。如 ldarg、starg、ldarga</li><li>操作函数局部变量的指令。如 ldloc、stloc、ldloca</li><li>隐含操作eval stack栈顶数据的指令。如add、dup</li></ul><p>对于操作函数帧栈的指令，一般要做以下几类处理</p><ul><li>为源数据和目标数据添加对应的逻辑地址字段</li><li>对于源数据或者目标数据有多个变种的指令，统一为带逻辑地址字段的指令。如ldarg.0 - ldarg.3、ldarg、ldarg.s 都统一为一条指令。</li></ul><p>以典型的ldarg指令为例。如果被操作函数参数的类型为int时，对应的hybridclr指令为</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">IRCommon</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> opcode</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">IRLdlocVarVar</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token base-clause class-name">IRCommon</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> dst</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> src</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token plain"> __pad6</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token plain"> __pad7</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//  对应解释执行代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> HiOpcodeEnum</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">LdlocVarVar</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> __dst </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> __src </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __dst</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __src</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>dst 指向当前执行栈顶的逻辑地址</li><li>src ldarg中要加载的变量的逻辑地址</li><li>__pad6 为了内存对齐而插入的</li><li>__pad7 同上</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="需要expand目标数据的指令">需要expand目标数据的指令<a href="#需要expand目标数据的指令" class="hash-link" aria-label="Direct link to 需要expand目标数据的指令" title="Direct link to 需要expand目标数据的指令">​</a></h3><p>根据CLI规范，像byte、sbyte、short、ushort这种size小于4的primitive类型，以及underlying type为这些primitive类型的枚举，它们被加载到evaluate stack时，需要符号扩展为int32_t类型数据。我们不想执行ldarg指令时作运行时判断，因为这样会降低性能。因此为这些size小于4的操作，单独设计了对应的指令。</p><p>以byte类型为例，对应的hybridclr指令为</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">IRLdlocExpandVarVar_u1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token base-clause class-name">IRCommon</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> dst</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> src</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token plain"> __pad6</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token plain"> __pad7</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//  对应解释执行代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> HiOpcodeEnum</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">LdlocExpandVarVar_u1</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> __dst </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> __src </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __dst</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __src</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="静态特例化的指令">静态特例化的指令<a href="#静态特例化的指令" class="hash-link" aria-label="Direct link to 静态特例化的指令" title="Direct link to 静态特例化的指令">​</a></h3><p>有一类指令的实际执行方式跟它的参数类型有关，如add。当操作的数是int、long、float、double时，执行对应类型的数据相加操作。但实际上由于IL程序的静态性，每条指令操作的数据类型肯定是固定的，并不需要运行时维护数据类型，并且根据数据类型决定执行什么操作。我们使用一种叫<code>静态特例化</code>的技术，为这种指令设计了多条hybridclr指令，在transform时，根据具体的操作数据类型，生成相应的指令。</p><p>以add 对两个int32_t类型数据相加为例</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">IRBinOpVarVarVar_Add_i4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token base-clause class-name">IRCommon</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> ret</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> op1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> op2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//  对应解释执行代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> HiOpcodeEnum</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">BinOpVarVarVar_Add_i4</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> __ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> __op1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> __op2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __op1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __op2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="直接包含常量的指令">直接包含常量的指令<a href="#直接包含常量的指令" class="hash-link" aria-label="Direct link to 直接包含常量的指令" title="Direct link to 直接包含常量的指令">​</a></h3><p>有一些指令包含普通字面常量，如ldc指令。相应的寄存器指令只是简单地添加了相应大小的字段。</p><p>以ldc int32_t类型数据为例</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">IRLdcVarConst_4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token base-clause class-name">IRCommon</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> dst</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> src</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 对应解释执行代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> HiOpcodeEnum</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">LdcVarConst_4</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> __dst </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> __src </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __dst</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> __src</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="隐含常量的指令">隐含常量的指令<a href="#隐含常量的指令" class="hash-link" aria-label="Direct link to 隐含常量的指令" title="Direct link to 隐含常量的指令">​</a></h3><p>有一些指令隐含了所操作的常量，如 ldnull、ldc.i4.0 - ldc.i4.8 等等。对于这类指令，如果有对应的<code>直接包含常量的指令</code>的实现，则简单转换为 上一节中介绍的 <code>直接包含常量的指令</code>。后续可能会进一步优化。</p><p>以ldnull为例</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">IRLdnullVar</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token base-clause class-name">IRCommon</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> dst</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token plain"> __pad4</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token plain"> __pad5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token plain"> __pad6</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token plain"> __pad7</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 对应解释执行代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> HiOpcodeEnum</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">LdnullVar</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> __dst </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __dst</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">nullptr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="指令共享">指令共享<a href="#指令共享" class="hash-link" aria-label="Direct link to 指令共享" title="Direct link to 指令共享">​</a></h4><p>为了减少指令数量，操作相同size常量的ldc指令会被合并为同一个。如ldloc.r4 指令就被合并到ldloc.i4指令的实现。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="包含resolved后数据的指令">包含resolved后数据的指令<a href="#包含resolved后数据的指令" class="hash-link" aria-label="Direct link to 包含resolved后数据的指令" title="Direct link to 包含resolved后数据的指令">​</a></h3><p>有一些指令包含metadata token，如sizeof、ldstr、newobj。为了避免巨大的运行时resolve开销，hybridclr在transform这些指令时就已经将包含token数据resolve为对应的runtime metadata。</p><p>更细致一些，又分为两类。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="直接包含resolved后数据的指令">直接包含resolved后数据的指令<a href="#直接包含resolved后数据的指令" class="hash-link" aria-label="Direct link to 直接包含resolved后数据的指令" title="Direct link to 直接包含resolved后数据的指令">​</a></h4><p>以sizeof为例，原始指令token为类型信息，transform时，直接计算了对应ValueType的size，甚至都不需要专门为sizeof设计对应的指令，直接使用现成的LdcVarConst_4指令。</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> OpcodeValue</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">SIZEOF</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> token </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">GetI4LittleEndian</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Il2CppClass</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> objKlass </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> image</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">GetClassFromToken</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">token</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> klassContainer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> methodContainer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> genericContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">IL2CPP_ASSERT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">objKlass</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> typeSize </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetTypeValueSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">objKlass</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CI_ldc4</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">typeSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> EvalStackReduceDataType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">I4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="间接包含resolved后数据的指令">间接包含resolved后数据的指令<a href="#间接包含resolved后数据的指令" class="hash-link" aria-label="Direct link to 间接包含resolved后数据的指令" title="Direct link to 间接包含resolved后数据的指令">​</a></h3><p>像ldstr、newobj这些指令包含的token经过resolve后，变成对应runtime metadata的指针，考虑到指针在不同平台大小不一，因此不直接将这个指针放到指令中，而是换成一个uint32_t类型的指向InterpMethodInfo::resolvedData字段的index param。执行过程中需要一次向resolvedData的查询操作，时间复杂度为O(1)。</p><p>以newobj指令为例</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">IRLdstrVar</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token base-clause class-name">IRCommon</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> dst</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> str</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 对应解释执行代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> HiOpcodeEnum</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">LdstrVar</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> __dst </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> __str </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Il2CppString</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __dst</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Il2CppString</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">imi</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">resolveDatas</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">__str</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="分支跳转指令">分支跳转指令<a href="#分支跳转指令" class="hash-link" aria-label="Direct link to 分支跳转指令" title="Direct link to 分支跳转指令">​</a></h3><p>原始IL字节码使用了相对offset的跳转目标，并且几乎为每条跳转相关指令都设计了near和far offset 两条指令，hybridclr为了简单起见，直接使用4字节的绝对跳转地址。</p><p>以br无条件跳转指令为例</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">IRBranchUncondition_4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token base-clause class-name">IRCommon</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token plain"> __pad2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token plain"> __pad3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> offset</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 对应解释执行代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> HiOpcodeEnum</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">BranchUncondition_4</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> __offset </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ipBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __offset</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>offset为转换后的指令地址的绝对偏移。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="对象成员访问指令">对象成员访问指令<a href="#对象成员访问指令" class="hash-link" aria-label="Direct link to 对象成员访问指令" title="Direct link to 对象成员访问指令">​</a></h3><p>由于字段在对象中的偏移已经完全确定，transform时计算出字段在对象中的偏移，保存为指令的offset param, 执行时根据对象大小，使用this指针和偏移，直接访问字段数据。</p><p>以ldfld 读取int类型字段为例</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">IRLdfldVarVar_i4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token base-clause class-name">IRCommon</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> dst</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> offset</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 对应解释执行代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> HiOpcodeEnum</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">LdfldVarVar_i4</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> __dst </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> __obj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> __offset </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CHECK_NOT_NULL_THROW</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Il2CppObject</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __dst</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Il2CppObject</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __offset</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="threadstatic-成员访问指令">ThreadStatic 成员访问指令<a href="#threadstatic-成员访问指令" class="hash-link" aria-label="Direct link to ThreadStatic 成员访问指令" title="Direct link to ThreadStatic 成员访问指令">​</a></h3><p>在初始化Il2CppClass时，如果它包含ThreadStatic属性标记的静态成员变量，则为它分配一个可以放下这个类型所有ThreadStatic变量的ThreadLocalStorage的连续空间。
借助于il2cpp运行时对ThreadStatic的支持，相关指令实现相当简单直接。</p><p>以ldsfld指令为例</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">IRLdthreadlocalVarVar_i4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token base-clause class-name">IRCommon</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> dst</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> offset</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> klass</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 对应解释执行代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> HiOpcodeEnum</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">LdthreadlocalVarVar_i4</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> __dst </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> __klass </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> __offset </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Il2CppClass</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> _klass </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Il2CppClass</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">imi</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">resolveDatas</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">__class</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Interpreter</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">RuntimeClassCCtorInit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_klass</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __dst</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">byte</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">il2cpp</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vm</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token class-name">Thread</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GetThreadStaticData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_klass</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">thread_static_fields_offset</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __offset</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="数组访问相关指令">数组访问相关指令<a href="#数组访问相关指令" class="hash-link" aria-label="Direct link to 数组访问相关指令" title="Direct link to 数组访问相关指令">​</a></h3><p>比较常规直接，不过有个特殊点：根据规范index变量可以是i4或者native int类型。由于数组访问是非常频繁的操作，我们不想插入运行时数据类型类型及转换，因为我们根据index变量的size为每条数组相关指令设计了2条hybridclr指令。</p><p>以ldelem.i4 指令的index是i4类型的情形为例</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">IRGetArrayElementVarVar_i4_4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token base-clause class-name">IRCommon</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> dst</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> arr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> index</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 对应解释执行代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> HiOpcodeEnum</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">GetArrayElementVarVar_i4_4</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> __dst </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> __arr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> __index </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Il2CppArray</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> arr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Il2CppArray</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __arr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CHECK_NOT_NULL_AND_ARRAY_BOUNDARY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __dst</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">il2cpp_array_get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">  </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="函数调用指令">函数调用指令<a href="#函数调用指令" class="hash-link" aria-label="Direct link to 函数调用指令" title="Direct link to 函数调用指令">​</a></h3><p>目前调用AOT函数和调用Interpreter函数使用不同的指令，因为Interpreter函数可以直接复用已经压到栈顶的数据，可以完全优化掉 Manged2Native -&gt; Native2Managed 这个过程，提升性能。</p><p>调用解释器函数时可以复用当前 InterpreterModule::Execute函数帧，也节省了函数调用开销，同时也避免了解释器嵌套调用过深导致native栈overflow的问题。</p><p>对于带返回值的函数，由于多了一个返回值地址参数ret，与返回void的函数分别设计了不同指令。</p><p>如果调用的是AOT函数，由于每条函数的参数不定，我们将参数信息记录到resolvedDatas，然后argIdxs中保存这个间接索引。另外还需要通过桥接函数完成解释器函数参数到native abi函数参数的转换，为了避免运行时查找的开销，也提前计算了这个桥接函数，记录到resolvedDatas中，然后在managed2NativeMethod中保存了这个间接索引。</p><p>以call指令为例，为它设计了5条指令</p><ul><li>IRCallNative_void</li><li>IRCallNative_ret</li><li>IRCallNative_ret_expand</li><li>IRCallInterp_void</li><li>IRCallInterp_ret</li></ul><p>以IRCallNative_ret的实现为例，介绍调用AOT函数的指令：</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">IRCallNative_ret</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token base-clause class-name">IRCommon</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> ret</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> managed2NativeMethod</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> methodInfo</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> argIdxs</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 对应解释执行代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> HiOpcodeEnum</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">CallNative_ret</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> __managed2NativeMethod </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> __methodInfo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> __argIdxs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> __ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> _ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Managed2NativeCallMethod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">imi</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">resolveDatas</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">__managed2NativeMethod</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MethodInfo</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">imi</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">resolveDatas</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">__methodInfo</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">imi</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">resolveDatas</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">__argIdxs</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> localVarBase</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果调用Interpreter函数，由于函数参数已经按顺序压到栈上，只需要一个argBase参数指定arg0逻辑地址即可，不需要借助resolvedDatas，也不需要managed2NativeMethod桥接函数指针。
这也是解释器函数不受桥接函数影响的原因。</p><p>以IRCallInterp_ret为例，介绍调用Interpreter函数的指令：</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">IRCallInterp_ret</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token base-clause class-name">IRCommon</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> argBase</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> ret</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token plain"> __pad6</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token plain"> __pad7</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> methodInfo</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 对应解释执行代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> HiOpcodeEnum</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">CallInterp_ret</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MethodInfo</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> __methodInfo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MethodInfo</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> __argBase </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> __ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CALL_INTERP_RET</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> __methodInfo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">StackObject</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __argBase</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="异常机制相关指令">异常机制相关指令<a href="#异常机制相关指令" class="hash-link" aria-label="Direct link to 异常机制相关指令" title="Direct link to 异常机制相关指令">​</a></h3><p>异常机制相关指令本身不复杂，但异常处理机制非常复杂。</p><p>异常这种特殊的流程控制指令，跟分支跳转指令相似，原始指令里包含了相对offset，为了简单起见，指令转换时我们改成int32_t类型的绝对offset。</p><p>以leave指令为例</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">IRLeaveEx</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token base-clause class-name">IRCommon</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token plain"> __pad2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token plain"> __pad3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> offset</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 对应解释执行代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> HiOpcodeEnum</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">LeaveEx</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token plain"> __offset </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">LEAVE_EX</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__offset</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="一些额外的instinct-指令">一些额外的instinct 指令<a href="#一些额外的instinct-指令" class="hash-link" aria-label="Direct link to 一些额外的instinct 指令" title="Direct link to 一些额外的instinct 指令">​</a></h3><p>对于一些特别常见的函数，为了优化性能，hybridclr直接内置了相应的指令，例如 new Vector{2,3,4}，如可空变量相关操作。这些instinct指令的执行性能基本与AOT持平。</p><p>以 new Vector3() 为例</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">IRNewVector3_3</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token base-clause class-name">IRCommon</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> obj</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token plain"> __pad10</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token plain"> __pad11</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token plain"> __pad12</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token plain"> __pad13</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token plain"> __pad14</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token plain"> __pad15</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 对应解释执行代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> HiOpcodeEnum</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">NewVector3_3</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> __obj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> __x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> __y </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> __z </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HtVector3f</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">float</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">float</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">float</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="initonce-指令">InitOnce 指令<a href="#initonce-指令" class="hash-link" aria-label="Direct link to InitOnce 指令" title="Direct link to InitOnce 指令">​</a></h3><p>有一些指令（如ldsfld）第一次执行的时候需要进行初始化操作，但后续再次执行时，不需要再执行初始化操作。但即使这样，免不了一个检查是否已经初始化的操作，我们希望完全优化掉这个检查行为。InitOnce动态JIT技术用于解决这个问题。</p><p>InitOnce是hybridclr的专利技术，暂未在代码中实现，这儿不详细介绍。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="其他技术相关指令">其他技术相关指令<a href="#其他技术相关指令" class="hash-link" aria-label="Direct link to 其他技术相关指令" title="Direct link to 其他技术相关指令">​</a></h3><p>限于篇幅，对于这些指令，会在单独的文章中介绍</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="Direct link to 总结" title="Direct link to 总结">​</a></h2><p>至此我们完成hybridclr指令集实现相关介绍。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/en/blog/principle">hybridclr技术原理剖析</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-07-13T00:00:00.000Z" itemprop="datePublished">July 13, 2022</time> · <!-- -->23 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">walon</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>我们在上一节完成了hybridclr可行性分析。由于hybridclr内容极多，限于篇幅本篇文章主要概述性介绍hybridclr的技术实现。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="clr和il2cpp基础">CLR和il2cpp基础<a href="#clr和il2cpp基础" class="hash-link" aria-label="Direct link to CLR和il2cpp基础" title="Direct link to CLR和il2cpp基础">​</a></h2><p>给纯AOT的il2cpp运行时添加一个原生interpreter模块，最终实现<a href="https://developpaper.com/new-net-interpreter-mono-has-arrived/" target="_blank" rel="noopener noreferrer">hybrid mode execution</a>，这看起来是非常复杂的事情。</p><p>其实不然，程序不外乎代码+数据。CLR运行中做的事情，综合起来主要就几种：</p><ol><li>执行简单的内存操作或者计算或者逻辑跳转。这部分与CLI的Base指令集大致对应</li><li>执行一个依赖于元数据信息的基础操作。例如 <code>a.x, arr[3]</code> 这种，依赖于元数据信息才能正确工作的代码。对应部分CLI的Object Model指令集。</li><li>执行一个依赖元数据的较复杂的操作。如 <code>typeof(object)，a is string、(object)5</code> 这种依赖于运行时提供的函数及相应元数据才正确工作的代码。对应部分CLI的Object Model指令集。</li><li>函数调用。包括且不限于被AOT函数调用及调用AOT函数，及interpreter之间的函数调用。对应CLI指令集中的 <code>call、callvir、newobj</code> 等Object Model指令。</li></ol><p>如果对CLR有深入的了解和透彻的分析，为了实现<code>hybrid mode execution</code>，hybridclr核心要完成的就以下两件事，其他则是无碍全局的细节：</p><ul><li>assembly信息能够加载和注册。 在此基础可以实现 <code>1-3</code>。</li><li>确保interpreter函数能被找到并且被调用，并且能执行出正确的结果。则可以实现 <code>4</code>。</li></ul><p>由于彻底理解以上内容需要较丰富的对CLR的认知以及较强的洞察力，我们不再费口舌解释，不能理解的开发者不必深究，继续看后续章节。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="核心模块">核心模块<a href="#核心模块" class="hash-link" aria-label="Direct link to 核心模块" title="Direct link to 核心模块">​</a></h2><p>从功能来看包含以下核心部分：</p><ul><li>metadata初级解析</li><li>metadata高级元数据结构解析</li><li>metadata动态注册</li><li>寄存器指令集设计</li><li>IL指令集到hybridclr寄存器指令集的转换</li><li>解释执行hybridclr指令集</li><li>其他如GC、多线程相关处理</li></ul><p>从代码结构来看包含三个目录：</p><ul><li>metadata 元数据相关</li><li>transform 指令集转换相关</li><li>interpreter 解释器相关</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="metadata-初级解析">metadata 初级解析<a href="#metadata-初级解析" class="hash-link" aria-label="Direct link to metadata 初级解析" title="Direct link to metadata 初级解析">​</a></h2><p>这部分内容技术门槛不高，但比较琐碎和辛苦，忠实地按照 <a href="https://www.ecma-international.org/publications-and-standards/standards/ecma-335/" target="_blank" rel="noopener noreferrer">ECMA-335规范</a> 的文档实现即可。对于少量有疑惑的地方，可以网上的资料或者借鉴mono的代码。</p><p>相关代码在<code>hybridclr\metadata</code>目录，主要在RawImage.h和RawImage.cpp中实现。如果再细分，相关实现分为以下几个部分。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pe-文件结构解析">PE 文件结构解析<a href="#pe-文件结构解析" class="hash-link" aria-label="Direct link to PE 文件结构解析" title="Direct link to PE 文件结构解析">​</a></h3><p>managed dll扩展了PE文件结构，增加了CLI相关metadata部分。这环节的主要工作有：</p><ul><li>解析PE headers</li><li>解析 section headers，找出CLI header，定位出cli数据段</li><li>解析出所有stream。Stream是CLI中最底层的数据结构之一，CLI将元数据根据特性分为几个大类<ul><li>#~ 流。包含所有tables定义，是最核心的元数据结构</li><li>#Strings 流。包括代码中非文档类型的字符串，如类型名、字段名等等</li><li>#GUID 流</li><li>#Blob 流。一些元数据类型过于复杂，以blob格式保存。还有一些数据如数组初始化数据列表，也常常保存到Blob流。</li><li>#- 流</li><li>#Pdb 流。用于调试</li></ul></li></ul><p>解析PE文件和代码在RawImage::Load，解析stream对应的代码在RawImage::LoadStreams。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="tables-metadata-解析">tables metadata 解析<a href="#tables-metadata-解析" class="hash-link" aria-label="Direct link to tables metadata 解析" title="Direct link to tables metadata 解析">​</a></h3><p>CLI中大多数metadata被为几十种类型，每个类型的数据组织成一个table。对于每个table，每行记录都是相同大小。</p><p>初级解析中不解析table中每行记录，只解析table的每行记录大小和每个字段偏移。有一大类字段为Coded Index类型，有可能是2或4字节，并不固定，需要根据其他表的Row Count来决定table中这一列的字段大小。由于table很多，这个计算过程比较琐碎易错。</p><p>对应代码在RawImage::LoadTables，截取部分代码如下</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token class-name">RawImage</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">BuildTableRowMetas</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">auto</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> table </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _tableRowMetas</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">TableType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">MODULE</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        table</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push_back</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        table</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push_back</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ComputStringIndexByte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        table</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push_back</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ComputGUIDIndexByte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        table</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push_back</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ComputGUIDIndexByte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        table</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push_back</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ComputGUIDIndexByte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">auto</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> table </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _tableRowMetas</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">TableType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">TYPEREF</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        table</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push_back</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ComputTableIndexByte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TableType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">MODULE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TableType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">MODULEREF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TableType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">ASSEMBLYREF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TableType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">TYPEREF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TagBits</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">ResoulutionScope</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        table</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push_back</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ComputStringIndexByte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        table</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push_back</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ComputStringIndexByte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ... 其他</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="table-解析">table 解析<a href="#table-解析" class="hash-link" aria-label="Direct link to table 解析" title="Direct link to table 解析">​</a></h3><p>上一节已经解析出每个table的起始数据位置、row count、表中每个字段的偏移和大小，有足够的信息可以解析出每个table中任意row的数据。table中row的id从1开始。</p><p>每个table的row的解析方式根据ECMA规范实现即可。每个table的row定义在 <code>metadata\Coff.h</code>文件，Row解析代码在 <code>RawImage.h</code>。这些解析代码都非常相似，为了避免错误，使用了大量的宏，截取部分代码如下：</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">TABLE2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GenericParamConstraint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TableType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">GENERICPARAMCONSTRAINT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> owner</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> constraint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">TABLE3</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MemberRef</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TableType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">MEMBERREF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> classIdx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> signature</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">TABLE1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">StandAloneSig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TableType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">STANDALONESIG</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> signature</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">TABLE3</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MethodImpl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TableType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">METHODIMPL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> classIdx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> methodBody</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> methodDeclaration</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">TABLE2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">FieldRVA</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TableType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">FIELDRVA</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rva</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> field</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">TABLE2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">FieldLayout</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TableType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">FIELDLAYOUT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> offset</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> field</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">TABLE3</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Constant</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TableType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">CONSTANT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> type</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> parent</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">TABLE2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MethodSpec</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TableType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">METHODSPEC</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> instantiation</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">TABLE3</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CustomAttribute</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TableType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">CUSTOMATTRIBUTE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> parent</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> type</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="metadata高级元数据结构解析">metadata高级元数据结构解析<a href="#metadata高级元数据结构解析" class="hash-link" aria-label="Direct link to metadata高级元数据结构解析" title="Direct link to metadata高级元数据结构解析">​</a></h2><p>从tables里直接读出来的都是持久化的初始metadata，而运行时需要的不只是这些简单原始数据，经常需要进一步resolve后的数据。例如</p><ul><li>Il2CppType 。即可以是简单的 <code>int</code>，也可以是比较复杂的<code>List&lt;int&gt;</code>，甚至是特别复杂的<code>List&lt;(int,int)&gt;&amp;</code></li><li>MethodInfo 。 即可以是简单的<code>object.ToString</code>，也有复杂的泛型 <code>IEnumerator&lt;int&gt;.Count</code>。</li></ul><p>CLI的泛型机制导致元数据变得极其复杂，典型的是TypeSpec，MethodSpec，MemberSpec相关元数据的运行时解析。核心实现代码在Image.cpp中实现，剩余一部分在 InterpreterImage.cpp及AOTHomologousImage.cpp中实现。后面会有专门介绍。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="metadata动态注册">metadata动态注册<a href="#metadata动态注册" class="hash-link" aria-label="Direct link to metadata动态注册" title="Direct link to metadata动态注册">​</a></h2><p>根据粒度从大到小，主要分为以下几类</p><ul><li>Assembly 注册。即将加载的assembly注册到il2cpp的元数据管理中。</li><li>TypeDefinition 注册。 这一步会生成基础运行时类型 Il2CppClass。</li><li>VTable虚表计算。 由于il2cpp的虚表计算是个黑盒，内部相当复杂，我们费了很多功夫才研究明白它的计算机制。后面会有专门章节介绍VTable计算，这儿不再赘述。</li><li>其他元数据，如CustomAttribute计算等等。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="assembly-注册">Assembly 注册<a href="#assembly-注册" class="hash-link" aria-label="Direct link to Assembly 注册" title="Direct link to Assembly 注册">​</a></h3><p>Assembly加载的关键函数在 il2cpp::vm::MetadataCache::LoadAssemblyFromBytes 。由于il2cpp是AOT运行时，原始实现只是简单地抛出异常。我们修改和完善了实现，在其中调用了hybridclr::metadata::Assembly::LoadFromBytes，完成了Assembly的创建，然后再注册到全局Assemblies列表。相关代码实现如下：</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Il2CppAssembly</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> il2cpp</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vm</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token class-name">MetadataCache</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">LoadAssemblyFromBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> assemblyBytes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size_t length</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    il2cpp</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">os</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">FastAutoLock </span><span class="token function" style="color:#d73a49">lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">il2cpp</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vm</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">g_MetadataLock</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Il2CppAssembly</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> newAssembly </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> hybridclr</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">metadata</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token class-name">Assembly</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">LoadFromBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">assemblyBytes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> length</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newAssembly</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// avoid register placeholder assembly twicely.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Il2CppAssembly</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> ass </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> s_cliAssemblies</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ass </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> newAssembly</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ass</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        il2cpp</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vm</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token class-name">Assembly</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">Register</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newAssembly</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s_cliAssemblies</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push_back</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newAssembly</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> newAssembly</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">nullptr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="typedefinition-注册">TypeDefinition 注册<a href="#typedefinition-注册" class="hash-link" aria-label="Direct link to TypeDefinition 注册" title="Direct link to TypeDefinition 注册">​</a></h3><p>Assembly使用了延迟初始化方式，注册后Assembly中的类型信息并未创建相应的运行时metadata Il2CppClass，只有当第一次访问到该类型时才进行初始化。</p><p>由于交叉依赖以及为了优化性能，Il2Class的创建是个分步过程</p><ul><li>Il2CppClass 基础创建</li><li>Il2CppClass的子元数据延迟初始化</li><li>运行时Class初始化</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="il2cppclass基础创建">Il2CppClass基础创建<a href="#il2cppclass基础创建" class="hash-link" aria-label="Direct link to Il2CppClass基础创建" title="Direct link to Il2CppClass基础创建">​</a></h4><p>在上一节加载Assembly时已经创建好所有类型对应的定义数据Il2CppTypeDefinition，在 il2cpp::vm::GlobalMetadata::FromTypeDefinition 中完成Il2CppClass创建工作。代码如下：</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Il2CppClass</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> il2cpp</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vm</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token class-name">GlobalMetadata</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">FromTypeDefinition</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TypeDefinitionIndex index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// ... 省略其他</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Il2CppClass</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> typeInfo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Il2CppClass</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">IL2CPP_CALLOC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Il2CppClass</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">VirtualInvokeData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> typeDefinition</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">vtable_count</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">klass </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> typeInfo</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">image </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetImageForTypeDefinitionIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> il2cpp</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vm</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token class-name">GlobalMetadata</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GetStringFromIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">typeDefinition</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">nameIndex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">namespaze </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> il2cpp</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vm</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token class-name">GlobalMetadata</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GetStringFromIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">typeDefinition</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">namespaceIndex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">byval_arg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">il2cpp</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vm</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token class-name">GlobalMetadata</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GetIl2CppTypeFromIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">typeDefinition</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">byvalTypeIndex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">this_arg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">byval_arg</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">this_arg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">byref </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">typeMetadataHandle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">reinterpret_cast</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name keyword" style="color:#00009f">const</span><span class="token generic-function generic class-name"> Il2CppMetadataTypeHandle</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">typeDefinition</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">genericContainerHandle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetGenericContainerFromIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">typeDefinition</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">genericContainerIndex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">instance_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> typeDefinitionSizes</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">instance_size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">actualSize </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> typeDefinitionSizes</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">instance_size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">// actualySize is instance_size for compiler generated values</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">native_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> typeDefinitionSizes</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">native_size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">static_fields_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> typeDefinitionSizes</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">static_fields_size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">thread_static_fields_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> typeDefinitionSizes</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">thread_static_fields_size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">thread_static_fields_offset </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">flags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> typeDefinition</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">flags</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">valuetype </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">typeDefinition</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">bitfield </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kBitIsValueType </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">enumtype </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">typeDefinition</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">bitfield </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kBitIsEnum </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">is_generic </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> typeDefinition</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">genericContainerIndex </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> kGenericContainerIndexInvalid</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">// generic if we have a generic container</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">has_finalize </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">typeDefinition</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">bitfield </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kBitHasFinalizer </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">has_cctor </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">typeDefinition</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">bitfield </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kBitHasStaticConstructor </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">is_blittable </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">typeDefinition</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">bitfield </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kBitIsBlittable </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">is_import_or_windows_runtime </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">typeDefinition</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">bitfield </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kBitIsImportOrWindowsRuntime </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">packingSize </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ConvertPackingSizeEnumToValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token generic-function function" style="color:#d73a49">static_cast</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">PackingSize</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">typeDefinition</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">bitfield </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kPackingSize </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xF</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">method_count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> typeDefinition</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">method_count</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">property_count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> typeDefinition</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">property_count</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">field_count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> typeDefinition</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">field_count</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">event_count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> typeDefinition</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">event_count</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">nested_type_count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> typeDefinition</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">nested_type_count</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">vtable_count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> typeDefinition</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">vtable_count</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">interfaces_count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> typeDefinition</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">interfaces_count</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">interface_offsets_count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> typeDefinition</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">interface_offsets_count</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">token </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> typeDefinition</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">token</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">interopData </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> il2cpp</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vm</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token class-name">MetadataCache</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GetInteropDataForType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">typeInfo</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">byval_arg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 省略其他</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> typeInfo</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到TypeDefinition中字段相当多，这些都是在Assembly加载环节计算好的。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="il2cppclass的子metadata延迟初始化">Il2CppClass的子metadata延迟初始化<a href="#il2cppclass的子metadata延迟初始化" class="hash-link" aria-label="Direct link to Il2CppClass的子metadata延迟初始化" title="Direct link to Il2CppClass的子metadata延迟初始化">​</a></h4><p>由于交互依赖以及为了优化性能，Il2Class的子metadata数据使用了延迟初始化策略，分步进行，在第一次使用时才初始化。以下代码截取自 <code>Class.h</code> 文件：</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Class</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ... 其他代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Il2CppClass </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">klass</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SetupEvents</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Il2CppClass </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">klass</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SetupFields</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Il2CppClass </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">klass</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SetupMethods</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Il2CppClass </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">klass</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SetupNestedTypes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Il2CppClass </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">klass</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SetupProperties</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Il2CppClass </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">klass</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SetupTypeHierarchy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Il2CppClass </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">klass</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SetupInterfaces</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Il2CppClass </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">klass</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ... 其他代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>重点来了！！！函数metadata的执行指针的绑定在SetupMethods函数中完成，其中关键代码片段如下：</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SetupMethodsLocked</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Il2CppClass </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">klass</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> il2cpp</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">os</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">FastAutoLock</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> lock</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// ... 其他忽略的代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MethodIndex index </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> index </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> end</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">++</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Il2CppMetadataMethodInfo methodInfo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">MetadataCache</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GetMethodInfo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">klass</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        newMethod</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> methodInfo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">klass</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">valuetype</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Il2CppMethodPointer adjustorThunk </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">MetadataCache</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GetAdjustorThunk</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">klass</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">image</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> methodInfo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">token</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">adjustorThunk </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                newMethod</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">methodPointer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> adjustorThunk</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// We did not find an adjustor thunk, or maybe did not need to look for one. Let&#x27;s get the real method pointer.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newMethod</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">methodPointer </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            newMethod</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">methodPointer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">MetadataCache</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GetMethodPointer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">klass</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">image</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> methodInfo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">token</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        newMethod</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">invoker_method </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">MetadataCache</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GetMethodInvoker</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">klass</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">image</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> methodInfo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">token</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// ... 其他忽略的代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>函数运行时元数据结构为 MethodInfo，定义如下,</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">MethodInfo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Il2CppMethodPointer methodPointer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    InvokerMethod invoker_method</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Il2CppClass </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">klass</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Il2CppType </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">return_type</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> ParameterInfo</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> parameters</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ... 省略其他</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> MethodInfo</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中我们比较关心的是methodPointer和invoker_method这两个字段。 methodPointer指向普通执行函数，invoker_method指向反射执行函数。</p><p>我们以 methodPointer为例，进一步跟踪它的设置过程， <code>il2cpp::vm::MetadataCache::GetMethodPointer</code> 的实现如下：</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Il2CppMethodPointer il2cpp</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vm</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token class-name">MetadataCache</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GetMethodPointer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Il2CppImage</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> image</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> token</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> rid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetTokenRowId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">token</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> table </span><span class="token operator" style="color:#393A34">=</span><span class="token plain">  </span><span class="token function" style="color:#d73a49">GetTokenType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">token</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rid </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ==={{ hybridclr</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hybridclr</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">metadata</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">IsInterpreterImage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">image</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> hybridclr</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">metadata</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token class-name">MetadataModule</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GetMethodPointer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">image</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> token</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ===}} hybridclr</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">IL2CPP_ASSERT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rid </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> image</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">codeGenModule</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">methodPointerCount</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> image</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">codeGenModule</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">methodPointers</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">rid </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看出，如果是解释器assembly，就跳转到解释器元数据模块获得对应的MethodPointer指针。 继续跟踪，相关代码如下：</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Il2CppMethodPointer </span><span class="token class-name">InterpreterImage</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GetMethodPointer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> token</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> methodIndex </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">DecodeTokenRowIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">token</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">IL2CPP_ASSERT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">methodIndex </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">_methodDefines</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Il2CppMethodDefinition</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> methodDef </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_methodDefines</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">methodIndex</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> hybridclr</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">interpreter</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token class-name">InterpreterModule</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GetMethodPointer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">methodDef</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Il2CppMethodPointer </span><span class="token class-name">InterpreterModule</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GetMethodPointer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Il2CppMethodDefinition</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> NativeCallMethod</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> ncm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetNativeCallMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ncm</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ncm</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//RaiseMethodNotSupportException(method, &quot;GetMethodPointer&quot;);</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Il2CppMethodPointer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">NotSupportNative2Managed</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// interpreter/InterpreterModule.cpp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">template</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">typename</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> NativeCallMethod</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetNativeCallMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> T</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> forceStatic</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> sigName</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">ComputeSignature</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">forceStatic</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sigName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sigName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> it </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> s_calls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">find</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sigName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">it </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> s_calls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">end</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">it</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">second </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">nullptr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// s_calls 定义</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">unordered_map</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NativeCallMethod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> CStringHash</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> CStringEqualTo</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> s_calls</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token class-name">InterpreterModule</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">Initialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size_t i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        NativeCallMethod</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> method </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> g_callStub</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">signature</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s_calls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">signature</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size_t i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        NativeInvokeMethod</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> method </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> g_invokeStub</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">signature</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s_invokes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">signature</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这儿根据函数定义计算其签名并且返回了一个函数指针，这个函数指针是什么呢？ s_calls在InterpreterModule::Initialize中使用g_callStub初始化。那g_calStub又是什么呢？它在 <code>interpreter/MethodBridge_xxx.cpp</code> 中定义，原来是桥接函数相关的数据结构！</p><p>为什么要返回一个这样的函数，而不是直接将methodPointer指向 <code>InterpreterModule::Execute</code> 函数呢？ 以 <code>int Foo::Sum(int,int)</code> 函数为例，这个函数的实际的签名为 <code>int32_t (int32_t, int32_t, MethodInfo*)</code>，在调用这个methodPointer函数时，调用方一定会传递这三个参数。这些参数每个函数都不一样，如果直接指向 <code>InterpreterModule::Execute</code> 函数，由于ABI调用无法自省（就算可以，性能也比较差），Execute函数既无法提取出普通参数，也无法提取出MethodInfo*参数，因而无法正确运行。因此需要对每个函数，适当地将ABI调用中的这些参数传递给Execute函数。</p><p>桥接函数如其名，承担了native ABI函数参数和interpreter函数之间双向的参数的转换作用。截取一段示例代码：</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/// AOT 到 interpreter 的调用参数转换</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int64_t</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__Native2ManagedCall_i8srr8sr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> __arg0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> __arg1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> __arg2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> MethodInfo</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    StackObject args</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">__arg0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">__arg1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">__arg2 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    StackObject</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> args </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Interpreter</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">Execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int64_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">ret</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// interpreter 到 AOT 的调用参数转换</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__Managed2NativeCall_i8srr8sr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> MethodInfo</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> argVarIndexs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> StackObject</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> localVarBase</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hybridclr</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">metadata</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">IsInstanceMethod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">localVarBase</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">argVarIndexs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        il2cpp</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vm</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token class-name">Exception</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">RaiseNullReferenceException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Interpreter</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">RuntimeClassCCtorInit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int64_t</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">NativeMethod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> __arg0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">double</span><span class="token plain"> __arg1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> __arg2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> MethodInfo</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int64_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">NativeMethod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">method</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">methodPointer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">argVarIndexs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">double</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">argVarIndexs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">argVarIndexs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="运行时class初始化">运行时Class初始化<a href="#运行时class初始化" class="hash-link" aria-label="Direct link to 运行时Class初始化" title="Direct link to 运行时Class初始化">​</a></h4><p>即程序运行过程中第一次访问类的静态字段或者函数时或者创建对象时触发的类型初始化。在il2cpp::vm::Runtime::ClassInit(klass)中完成。不是特别关键，我们后面在单独文章中介绍。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="vtable虚表计算">VTable虚表计算<a href="#vtable虚表计算" class="hash-link" aria-label="Direct link to VTable虚表计算" title="Direct link to VTable虚表计算">​</a></h3><p>虚表是多态的核心。CLI的虚表计算非常复杂，但不理解它的实现并不影响开发者理解hybridclr的核心运行流程，我们后面在单独文章中介绍。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="其他元数据">其他元数据<a href="#其他元数据" class="hash-link" aria-label="Direct link to 其他元数据" title="Direct link to 其他元数据">​</a></h3><p>CustomAttribute使用延迟初始化方式，计算也很复杂，我们后面单独文章介绍。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="寄存器指令集设计">寄存器指令集设计<a href="#寄存器指令集设计" class="hash-link" aria-label="Direct link to 寄存器指令集设计" title="Direct link to 寄存器指令集设计">​</a></h2><p>直接解释原始IL指令有几个问题：</p><ul><li>IL是基于栈的指令，运行时维护执行栈是个无谓的开销</li><li>IL有大量单指令多功能的指令，如add指令可以用于计算int、long、float、double类型的和，导致运行时需要根据上文判断到底该执行哪种计算。不仅增加了运行时判定的开销，还增加了运行时维护执行栈数据类型的开销</li><li>IL指令包含一些需要运行时resolve的数据，如newobj指令第一个参数是method token。token resolve是一个开销很大的操作，每次执行都进行resolve会极大拖慢执行性能</li><li>IL是基于栈的指令，压栈退栈相关指令数较多。像a=b+c这样的指令需要4条指令完成，而如果采用基于寄存器的指令，完全可以一条指令完成。</li><li>IL不适合做其他优化操作，如我们的InitOnce JIT技术。</li><li>其他</li></ul><p>因此我们需要将原始IL指令转换为更高效的寄存器指令。由于指令很多，这儿不介绍寄存器指令集的详细设计。以add指令举例</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 包含type字段，即指令ID。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">IRCommon</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HiOpcodeEnum type</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// add int, int -&gt; int 对应的寄存器指令</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">IRBinOpVarVarVar_Add_i4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token base-clause class-name">IRCommon</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> ret</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 计算结果对应的 栈位置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> op1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 操作数1对应的栈位置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> op2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 操作数2对应的栈位置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="指令集的转换">指令集的转换<a href="#指令集的转换" class="hash-link" aria-label="Direct link to 指令集的转换" title="Direct link to 指令集的转换">​</a></h2><p>理解这节需要初步的编译原理相关知识，我们使用了非常朴素的转换算法，并且基本没有做指令优化。转换过程分为几步：</p><ul><li>BasicBlock 划分。 将IL指令块切成一段段不包含任何跳转指令的代码块，称之为BasicBlock。</li><li>模拟指令执行流程，同时使用广度优先遍历算法遍历所有BasicBlock，将每个BasicBlock转换为IRBasicBlock。</li></ul><p>BasicBlock到IRBasicBlock转换采用了最朴素的一对一指令转换算法，转换相关代码在<code>transform::HiTransform::Transform</code>。我们以add指令为例：</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> OpcodeValue</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">ADD</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">IL2CPP_ASSERT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">evalStackTop </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EvalStackVarInfo</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> op1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> evalStack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">evalStackTop </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EvalStackVarInfo</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> op2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> evalStack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">evalStackTop </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CreateIR</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ir</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BinOpVarVarVar_Add_i4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ir</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">op1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> op1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">locOffset</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ir</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">op2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> op2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">locOffset</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ir</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> op1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">locOffset</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EvalStackReduceDataType resultType</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">op1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reduceType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> EvalStackReduceDataType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">I4</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">op2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reduceType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> EvalStackReduceDataType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">I4</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            resultType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> EvalStackReduceDataType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">I4</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ir</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> HiOpcodeEnum</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">BinOpVarVarVar_Add_i4</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> EvalStackReduceDataType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">I</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> EvalStackReduceDataType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Ref</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">CreateAddIR</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">irConv</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ConvertVarVar_i4_i8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            irConv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dst </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> irConv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">src </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> op1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">locOffset</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            resultType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> op2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reduceType</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ir</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> HiOpcodeEnum</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">BinOpVarVarVar_Add_i8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">IL2CPP_ASSERT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> EvalStackReduceDataType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">I8</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">op2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reduceType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> EvalStackReduceDataType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">I8</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> EvalStackReduceDataType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">I</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// not support i8 + i ! but we support</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            resultType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> EvalStackReduceDataType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">I8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ir</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> HiOpcodeEnum</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">BinOpVarVarVar_Add_i8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">IL2CPP_ASSERT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> EvalStackReduceDataType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">I</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> EvalStackReduceDataType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Ref</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">op2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reduceType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> EvalStackReduceDataType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">I4</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">CreateAddIR</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">irConv</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ConvertVarVar_i4_i8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            irConv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">dst </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> irConv</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">src </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> op2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">locOffset</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            resultType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> op1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reduceType</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ir</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> HiOpcodeEnum</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">BinOpVarVarVar_Add_i8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> EvalStackReduceDataType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">I</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> EvalStackReduceDataType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">I8</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            resultType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> op1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reduceType</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ir</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> HiOpcodeEnum</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">BinOpVarVarVar_Add_i8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">IL2CPP_ASSERT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> EvalStackReduceDataType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">R4</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">op2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reduceType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> EvalStackReduceDataType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">R4</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            resultType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> op2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reduceType</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ir</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> HiOpcodeEnum</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">BinOpVarVarVar_Add_f4</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">IL2CPP_ASSERT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> EvalStackReduceDataType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">R8</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">op2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reduceType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> EvalStackReduceDataType</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">R8</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            resultType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> op2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reduceType</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ir</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> HiOpcodeEnum</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">BinOpVarVarVar_Add_f8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">IL2CPP_ASSERT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">IL2CPP_ASSERT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">PopStack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    op1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reduceType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> resultType</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    op1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">byteSize </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetSizeByReduceType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resultType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">AddInst</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ir</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>从代码可以看出，其实转换算法非常简单，就是根据add指令的参数类型，决定转换为哪条寄存器指令，同时正确设置指令的字段值。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="解释执行hybridclr指令集">解释执行hybridclr指令集<a href="#解释执行hybridclr指令集" class="hash-link" aria-label="Direct link to 解释执行hybridclr指令集" title="Direct link to 解释执行hybridclr指令集">​</a></h2><p>解释执行在代码 <code>interpreter::InterpreterModule::Execute</code> 函数中完成。涉及到几部分：</p><ul><li>函数帧构建，参数、局部变量、执行栈的初始化</li><li>执行普通指令</li><li>调用子函数</li><li>异常处理</li></ul><p>这块内容也很多，我们会在多篇文章中详细介绍实现，这里简单摘取 BinOpVarVarVar_Add_i4 指令的实现代码:</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> HiOpcodeEnum</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">BinOpVarVarVar_Add_i4</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> __ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> __op1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> __op2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ip </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __op1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int32_t</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localVarBase </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> __op2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>相信这段代码还是比较好理解的。指令集转换和指令解释相关代码是hybridclr的核心，但复杂度却不高，这得感谢il2cpp运行时帮我们承担了绝大多数复杂的元数据相关操作的支持。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="其他如gc多线程相关处理">其他如GC、多线程相关处理<a href="#其他如gc多线程相关处理" class="hash-link" aria-label="Direct link to 其他如GC、多线程相关处理" title="Direct link to 其他如GC、多线程相关处理">​</a></h2><p>我们在hybridclr可行性的思维实验中分析过这两部分实现。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="gc">GC<a href="#gc" class="hash-link" aria-label="Direct link to GC" title="Direct link to GC">​</a></h3><p>对于对象分配，我们使用il2cpp::vm::Object::New函数分配对象即可。还有一些其他涉及到GC的部分如ldstr指令中Il2CppString对象的缓存，利用了一些其他il2cpp运行时提供的GC机制。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="多线程相关处理">多线程相关处理<a href="#多线程相关处理" class="hash-link" aria-label="Direct link to 多线程相关处理" title="Direct link to 多线程相关处理">​</a></h3><ul><li>volatile 。对于指令中包含volatile前缀指令，我们简单在执行代码前后插入MemoryBarrier。</li><li>ThreadStatic 。 使用il2cpp内置的Class的ThreadStatic变量机制即可。</li><li>Thread。 我们对于每个托管线程，都创建了一个对应的解释器栈。</li><li>async 相关。由于异步相关只是语法糖，由编译器和标准库完成了所有内容。hybridclr只需要解决其中产生的AOT泛型实例化的问题即可。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="Direct link to 总结" title="Direct link to 总结">​</a></h2><p>概括地说，hybridclr的实现为：</p><ul><li>MetadataCache::LoadAssemblyFromBytes （c#层调用Assembly.Load时触发）时加载并注册interpreter Assembly</li><li>il2cpp运行过程中延迟初始化类型相关元数据，其中关键为正确设置了MethodInfo元数据中methodPointer指针</li><li>il2cpp运行时通过methodPointer或者methodInvoke指针，再经过桥接函数跳转，最终执行了Interpreter::Execute函数。<ul><li>Execute函数在第一次执行某interpreter函数时触发HiTransform::Transform操作，将原始IL指令翻译为hybridclr的寄存器指令。</li><li>然后执行该函数对应的hybridclr寄存器指令。</li></ul></li></ul><p>至此完成hybridclr的技术原理介绍。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/en/blog/mindexperiment">关于hybridclr可行性的思维实验</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-07-08T00:00:00.000Z" itemprop="datePublished">July 8, 2022</time> · <!-- -->10 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">walon</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>在确定目标，动手实现hybridclr前，有一个必须考虑的问题——我们如何确定hybridclr的可行性？</p><p>il2cpp虽然不是一个极其完整的运行时，但代码仍高达12w行，复杂度相当高，想要短期内深入了解它的实现是非常困难的。除了官方几个介绍il2cpp的博客外，几乎找不到其他文档，
而且<code>Hybrid mode execution</code> 的实现复杂度也很高。磨刀不误砍柴工，在动手前从理论上确信这套方案有极高可行性，是完全必要的。</p><p>以我们对CLR运行时的认识，要实现 <code>hybrid mode execution</code> 机制，至少要解决以下几个问题</p><ul><li>能够动态注册元数据，这些动态注册的元数据必须在运行时中跟AOT元数据完全等价。</li><li>所有调用动态加载的assembly中函数的路径，都能定向到正确的解释器实现。包括虚函数override、delegate回调、反射调用等等。</li><li>解释器中的gc，必须能够与AOT部分的gc统一处理。</li><li>多线程相关能正常工作。包括且不限于创建Thread、async、volatile、ThreadStatic等等。</li></ul><p>我们下面一一分析解决这些问题。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="动态注册元数据">动态注册元数据<a href="#动态注册元数据" class="hash-link" aria-label="Direct link to 动态注册元数据" title="Direct link to 动态注册元数据">​</a></h2><p>我们大略地分析了il2cpp元数据初始化相关代码，得出以下结论。</p><p>首先，动态修改globalmetadata.dat这个方式不可行。因为globalmetadata.dat保存了持久化的元数据，元数据之间关系大量使用id来相互引用，添加新的数据很容易引入错误，变成极难检测的bug。另外，globalmetadata里有不少数据项由于没有文档，无法分析实际用途，也不得而知如何设置正确的值。另外，运行时会动态加载新的dll，重新计算globalmetadata.dat是成本高昂的事情。而且il2cpp中元数据管理并不支持二次加载，重复加载globalmetadata.dat会产生相当大的代码改动。</p><p>一个较可行办法，修改所有元数据访问的底层函数，检查被访问的元数据的类型，如果是AOT元数据，则保持之前的调用，如果来自动态加载，则跳转到hybridclr的元数据管理模块，返回一个恰当的值。但这儿又遇到一个问题，其次globalmetadata为了优化性能，所有dll中的元数据在统一的id命名空间下。很多元数据查询操作仅仅使用一个id参数，如何根据id区别出到底是AOT还是interpreter的元数据？</p><p>我们发现实际项目生成的globalmetadata.dat中这些元数据id的值都较小，最大也不过几十万级别。思考后用一个技巧：我们将id分成两部分: 高位为image id，低位为实际上的id，将image id=0保留给AOT元数据使用。我们为每个动态加载的dll分配一个image id，这个image中解析出的所有元数据id的高位为相应的image id。</p><p>我们通过这个技巧，hook了所有底层访问元数据的方法。大约修改了几十处，基本都是如下这样的代码，尽量不修改原始逻辑，很容易保证正确性。</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> il2cpp</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">vm</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token class-name">GlobalMetadata</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GetStringFromIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">StringIndex index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ==={{ hybridclr</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hybridclr</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">metadata</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">IsInterpreterIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> hybridclr</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">metadata</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token class-name">MetadataModule</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GetStringFromEncodeIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ===}} hybridclr</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">IL2CPP_ASSERT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> s_GlobalMetadataHeader</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">stringSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> strings </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">MetadataOffset</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name keyword" style="color:#00009f">const</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name keyword" style="color:#00009f">char</span><span class="token generic-function generic class-name operator" style="color:#393A34">*</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s_GlobalMetadata</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s_GlobalMetadataHeader</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">stringOffset</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">if</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">__ENABLE_UNITY_PLUGIN__</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">g_get_string </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">g_get_string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">char</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">strings</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">endif</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property comment" style="color:#999988;font-style:italic">// __ENABLE_UNITY_PLUGIN__</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> strings</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我们在动手前检查了多个相关函数，基本没有问题。虽然不敢确定这一定是可行的，但元数据加载是hybridclr第一阶段的开发任务，万一发现问题，及时中止hybridclr开发损失不大。于是我们认为算是解决了第一个问题。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="所有调用动态加载的assembly中函数的路径都能定向到正确的解释器实现">所有调用动态加载的assembly中函数的路径，都能定向到正确的解释器实现<a href="#所有调用动态加载的assembly中函数的路径都能定向到正确的解释器实现" class="hash-link" aria-label="Direct link to 所有调用动态加载的assembly中函数的路径，都能定向到正确的解释器实现" title="Direct link to 所有调用动态加载的assembly中函数的路径，都能定向到正确的解释器实现">​</a></h2><p>我们分析了il2cpp中关于Method元数据的管理方式，发现MethodInfo结构中保存了运行时实际执行逻辑的函数指针。如果我们简单地设置动态加载的函数元数据的MethodInfo结构的指针为正确的解释器函数，能否保证所有流程对该函数的调用，都能正确定向到解释器函数呢？</p><p>严谨思考后的结论是肯定的。首先AOT部分不可能直接调用动态加载的dll中的函数。其次，运行时并没有其他地方保存了函数指针。意味着，如果想调用动态加载的函数，必须获得MethodInfo中的函数指针，才能正确执行到目标函数。意味着我们运行过程中所有对该函数的调用一定会调用到正确的解释器函数。</p><p>至于我们解决了第二个问题。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="解释器中的gc必须能够与aot部分的gc统一处理">解释器中的gc，必须能够与AOT部分的gc统一处理<a href="#解释器中的gc必须能够与aot部分的gc统一处理" class="hash-link" aria-label="Direct link to 解释器中的gc，必须能够与AOT部分的gc统一处理" title="Direct link to 解释器中的gc，必须能够与AOT部分的gc统一处理">​</a></h2><p>很容易观察到，通过il2cpp::vm::Object::New可以分配托管对象，通过gc模块的函数可以分配一些能够被gc自动管理的内存。但我们如何保证，使用这种方式就一定能保存正确性呢，会不会有特殊的使用规则 ，hybridclr的解释器代码无法与之配合工作呢？</p><p>考虑到AOT代码中也有很多gc相关的操作，我们检查了一些il2cpp为这些操作生成的c++代码，都是简简单单直接调用 il2cpp::vm::Object::New 之类的函数，并无特殊之处。 可以这么分析：il2cpp生成的代码是普通的c++代码，hybridclr解释器代码也是c++代码，既然生成的代码的内存使用方式能够正确工作，那么hybridclr解释器中gc相关代码，肯定也能正确工作。</p><p>至此，我们解决了第三个问题。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="多线程相关代码能正常工作">多线程相关代码能正常工作<a href="#多线程相关代码能正常工作" class="hash-link" aria-label="Direct link to 多线程相关代码能正常工作" title="Direct link to 多线程相关代码能正常工作">​</a></h2><p>与上一个问题相似。我们检查了il2cpp生成的c++代码，发现并无特殊之处也能在多线程环境下正常运行，那我们也可以非常确信，hybridclr解释器的代码只要符合常规的多线程的要求，也能在多线程环境下正常运行。</p><p>至此，我们解决了第四个问题。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="Direct link to 总结" title="Direct link to 总结">​</a></h2><p>我们通过少量的对实际il2cpp代码的观察，以及对CLR运行时原理的了解，再配合思维实验，可以99.9%以上确定，既然il2cpp生成的代码都能在运行时正确运行，那hybridclr解释模式下执行的代码，也能正确运行。</p><p>我们在完成思维实验的那一刻，难掩内心激动的心情。作为一名物理专业的IT人，脑海里第一时间浮现出爱因斯坦在思考广义相对论时的，使用电梯思维实验得出引力使时空弯曲这一惊人结论。我们不敢比肩这种伟大的科学家，但我们确实在使用类似的思维技巧。可以说，hybridclr不是简单的经验总结，是深刻洞察力与分析能力孕育的结果。</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/en/blog/catelog">深入探究hybridclr 目录</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-07-06T00:00:00.000Z" itemprop="datePublished">July 6, 2022</time> · <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">walon</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>我们在实现hybridclr过程中，深入研究了CLI规范与il2cpp实现，积累了大量宝贵的经验。考虑到国内游戏行业对clr及il2cpp相关的资料不多，我们希望将这些知识系统性地整理出来，帮助那些渴望深入研究Unity下CLR Runtime实现的开发者们，更好了掌握相关知识。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="inspect-il2cpp-目录">Inspect il2cpp 目录<a href="#inspect-il2cpp-目录" class="hash-link" aria-label="Direct link to Inspect il2cpp 目录" title="Direct link to Inspect il2cpp 目录">​</a></h2><ul><li>il2cpp 序章<ul><li>il2cpp 介绍</li><li>il2cpp il2cpp 架构及源码结构介绍</li><li>il2cpp 安装、编译及调试</li></ul></li><li>il2cpp 运行时实现<ul><li>il2cpp Runtime 初始化流程剖析</li><li>il2cpp metadata （此节内容极其庞大）<ul><li>CLI metadata 简略介绍</li><li>il2cpp metadata 初始化流程剖析</li><li>persistent metadata 即 global-metadata.dat 介绍</li><li>runtime metadata 介绍</li></ul></li><li>il2cpp IL to c++ 代码的转换<ul><li>基础指令集</li><li>对象模型相关指令 （内容极其庞大）</li><li>异常机制</li><li>泛型共享机制</li><li>PInvoke 与 MonoPInvokeCallbackAttribute相关。(一个有趣的问题：il2cpp中lua回调c#函数相比与回调普通c函数，多了哪些开销？)</li><li>icalls</li><li>delegate</li><li>反射相关支持</li><li>跨平台相关</li></ul></li><li>类型初始化 Class::Init 流程剖析</li><li>泛型类实现</li><li>泛型函数实现</li><li>泛型共享机制</li><li>异常机制</li><li>反射相关实现</li><li>值类型相关机制</li><li>box与unbox相关机制</li><li>object、string、Array、TypedReference等一些基础BCL类型的探究</li><li>icalls 实现</li><li>il2cpp及mono的bug介绍</li><li>il2cpp gc管理</li><li>il2cpp 多线程及内存模型处理</li></ul></li><li>2018-2022中il2cpp实现的演化</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="inspect-hybridclr-目录">Inspect hybridclr 目录<a href="#inspect-hybridclr-目录" class="hash-link" aria-label="Direct link to Inspect hybridclr 目录" title="Direct link to Inspect hybridclr 目录">​</a></h2><ul><li>1 导论<ul><li>手游热更新技术的发展史</li><li>当前主流热更新技术的缺陷</li><li>下一代热更新技术探索——unity引擎下的原生c#热更新技术</li></ul></li><li>2 hybridclr概览<ul><li>1 hybridclr介绍</li><li>2 关于hybridclr可行性的思维实验</li><li>3 hybridclr技术原理剖析</li></ul></li><li>3 metadata 加载<ul><li>1 coff文件解析</li><li>2 stream 解析</li><li>3 原始tables解析</li><li>4 复杂元数据解析</li></ul></li><li>4 metadata 注册<ul><li>1 assembly 注册</li><li>2 TypeDefinition 注册（复杂）</li><li>3 generic class</li><li>4 generic method</li><li>5 桥接函数</li></ul></li><li>5 寄存器指令集设计<ul><li>IL指令集介绍</li><li>基于栈的指令集的缺陷</li><li>寄存器指令集<ul><li>基础转换规则</li><li>指令静态特例化</li><li>resolve data</li><li>其他特殊处理</li></ul></li><li>一些用于解释器JIT技术<ul><li>InitOnce JIT优化技术</li></ul></li></ul></li><li>6 指令集transform实现<ul><li>基础思路介绍</li><li>transform算法<ul><li>basic block划分</li><li>基于basic block的指令流遍历及转换</li><li>普通指令</li><li>函数调用指令</li><li>branch相关指令</li><li>异常相关指令</li></ul></li><li>指令集优化<ul><li>指令合并</li><li>ValueType相关指令优化</li><li>函数inline</li><li>instinct函数替换</li></ul></li><li>virtual Execution System<ul><li>Thread Interpreter Stack</li><li>Interpreter Frame实现与优化</li><li>localloc 与 Local Memory Pool</li><li>桥接函数</li><li>指令实现</li><li>instinct函数</li><li>reflection相关实现</li><li>extern函数实现</li></ul></li><li>跨平台兼容性处理<ul><li>32位与64位</li><li>内存对齐访问</li><li>x86与arm系列区别<ul><li>float与int之间转换</li><li>abi</li></ul></li><li>虚拟地址空间差异</li><li>一些行为不定的函数<ul><li>memcpy</li></ul></li></ul></li><li>AOT泛型 （基于补充元数据的泛型实例化技术）</li><li>AOT hotfix实现</li></ul></li><li>misc<ul><li>解决Unity资源上挂载interpreter脚本</li><li>gc 处理</li><li>多线程相关处理</li></ul></li><li>test框架<ul><li>测试用例项目<ul><li>bootstrap cpp测试集</li><li>.net c#测试集</li><li>生成测试报告</li></ul></li><li>测试工具<ul><li>创建多版本多平台的测试项目</li><li>运行测试用例，收集测试报告</li><li>生成最终测试报告</li></ul></li><li>自动化测试DevOps框架</li></ul></li></ul></div></article><nav class="pagination-nav" aria-label="Blog list page navigation"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/en/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Repository</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/focus-creative-games/hybridclr" target="_blank" rel="noopener noreferrer" class="footer__link-item">hybridclr<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/focus-creative-games/il2cpp_plus" target="_blank" rel="noopener noreferrer" class="footer__link-item">il2cpp_plus<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/focus-creative-games/hybridclr_unity" target="_blank" rel="noopener noreferrer" class="footer__link-item">hybridclr package<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/en/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/focus-creative-games/hybridclr" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gitee.com/focus-creative-games/hybridclr" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 <a href="https://code-philosophy.com/">Code Philosophy</a>. All Rights Reserved.</div></div></div></footer></div>
<script src="/en/assets/js/runtime~main.b7b60053.js"></script>
<script src="/en/assets/js/main.a2da2992.js"></script>
</body>
</html>